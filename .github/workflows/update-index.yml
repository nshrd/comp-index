name: üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –ò–Ω–¥–µ–∫—Å–∞

# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –∏ –ø—Ä–∏ –ø—É—à–µ –≤ main
on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  push:
    branches: [ main, master ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-index:
    name: üìä –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚úÖ Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TA-Lib (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      run: |
        # TA-Lib —á–∞—Å—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        sudo apt-get update
        sudo apt-get install -y build-essential
        # –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ TA-Lib, –∑–∞–º–µ–Ω–∏–≤ –Ω–∞ pandas rolling
        
    - name: üîß –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Seeds —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SEEDS_REPO: ${{ secrets.SEEDS_REPO_NAME }}
      run: |
        if [ ! -z "$SEEDS_REPO" ]; then
          git clone https://${GITHUB_TOKEN}@github.com/${SEEDS_REPO}.git seeds_repo
        else
          echo "‚ö†Ô∏è SEEDS_REPO_NAME –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ secrets"
          mkdir -p seeds_repo
        fi
        
    - name: üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –¥–ª—è –∫–æ–º–º–∏—Ç–æ–≤
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
    - name: üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
      env:
        APP_RANKINGS_API_KEY: ${{ secrets.APP_RANKINGS_API_KEY }}
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
      run: |
        chmod +x run_updater.sh
        ./run_updater.sh
        
    - name: üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ Seeds —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      if: success()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        if [ -d "seeds_repo/.git" ]; then
          cd seeds_repo
          if ! git diff --quiet; then
            git add .
            git commit -m "üîÑ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞ $(date '+%Y-%m-%d %H:%M UTC')" || true
            git push origin HEAD || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è"
          else
            echo "üìù –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
          fi
        fi
        
    - name: üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: updater-logs
        path: "*.log"
        retention-days: 30
        
    - name: üìä –û—Ç—á–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ
      if: failure()
      run: |
        echo "‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        if [ -f "updater.log" ]; then
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
          tail -20 updater.log
        fi 