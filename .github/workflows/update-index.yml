name: üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ö–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –ò–Ω–¥–µ–∫—Å–∞

# –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ –∏ –ø—Ä–∏ –ø—É—à–µ –≤ main
on:
  schedule:
    - cron: '0 */6 * * *'  # –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
  push:
    branches: [ main, master ]
  workflow_dispatch:  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  update-index:
    name: üìä –û–±–Ω–æ–≤–∏—Ç—å –∫–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å
    runs-on: ubuntu-latest
    
    steps:
    - name: ‚úÖ Checkout –∫–æ–¥–∞
      uses: actions/checkout@v4
      
    - name: üêç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        cache: 'pip'
        
    - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ TA-Lib (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
      run: |
        # TA-Lib —á–∞—Å—Ç–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏
        sudo apt-get update
        sudo apt-get install -y build-essential
        # –ú–æ–∂–Ω–æ —Ç–∞–∫–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–µ–∑ TA-Lib, –∑–∞–º–µ–Ω–∏–≤ –Ω–∞ pandas rolling
        
    - name: üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞
      env:
        APP_RANKINGS_API_KEY: ${{ secrets.APP_RANKINGS_API_KEY }}
        API_BASE_URL: ${{ secrets.API_BASE_URL }}
      run: |
        chmod +x run_updater.sh
        ./run_updater.sh
        
    - name: üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: updater-logs
        path: "*.log"
        retention-days: 30
        
    - name: üìä –û—Ç—á–µ—Ç –æ —Å—Ç–∞—Ç—É—Å–µ
      if: failure()
      run: |
        echo "‚ùå –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–∞ –∑–∞–≤–µ—Ä—à–∏–ª–æ—Å—å —Å –æ—à–∏–±–∫–æ–π"
        if [ -f "updater.log" ]; then
          echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ª–æ–≥–∞:"
          tail -20 updater.log
        fi 