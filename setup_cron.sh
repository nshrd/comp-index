#!/bin/bash

# ============================================================================
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ cron –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./setup_cron.sh
# ============================================================================

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
UPDATER_SCRIPT="$SCRIPT_DIR/run_updater.sh"
LOG_FILE="$SCRIPT_DIR/cron.log"

echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–º–ø–æ–∑–∏—Ç–Ω–æ–≥–æ –∏–Ω–¥–µ–∫—Å–∞..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è updater —Å–∫—Ä–∏–ø—Ç–∞
if [[ ! -f "$UPDATER_SCRIPT" ]]; then
    echo "‚ùå –§–∞–π–ª $UPDATER_SCRIPT –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x "$UPDATER_SCRIPT"

# –°–æ–∑–¥–∞–µ–º cron –∑–∞–¥–∞—á—É (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
CRON_ENTRY="0 */6 * * * $UPDATER_SCRIPT >> $LOG_FILE 2>&1"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–∞—è –∑–∞–¥–∞—á–∞
if crontab -l 2>/dev/null | grep -q "$UPDATER_SCRIPT"; then
    echo "‚ö†Ô∏è  Cron –∑–∞–¥–∞—á–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    echo "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏:"
    crontab -l | grep "$UPDATER_SCRIPT"
    
    read -p "–•–æ—Ç–∏—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É? (y/N): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É
        crontab -l | grep -v "$UPDATER_SCRIPT" | crontab -
        echo "‚úÖ –°—Ç–∞—Ä–∞—è –∑–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞"
    else
        echo "‚ùå –û—Ç–º–µ–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–¥–∞—á—É."
        exit 0
    fi
fi

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É
(crontab -l 2>/dev/null; echo "$CRON_ENTRY") | crontab -

echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo "üìã –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏:"
echo "   –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (00:00, 06:00, 12:00, 18:00)"
echo "   –°–∫—Ä–∏–ø—Ç: $UPDATER_SCRIPT"
echo "   –õ–æ–≥–∏: $LOG_FILE"

echo ""
echo "üîç –¢–µ–∫—É—â–∏–µ cron –∑–∞–¥–∞—á–∏:"
crontab -l

echo ""
echo "üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f $LOG_FILE"
echo "   –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á: crontab -l"
echo "   –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á: crontab -r"
echo "   –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: crontab -e"

echo ""
echo "‚ö° –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—É—Å—Ç–∏—Ç–µ: $UPDATER_SCRIPT" 