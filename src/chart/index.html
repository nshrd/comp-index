<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBMA14 Chart - TradingView Style</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="config.js"></script>
    <script src="optimized_utils.js"></script>
    <script src="enhanced_technical_indicators.js"></script>
    <script src="indicators_manager.js"></script>
    <script src="timescale_integration.js"></script>
    <script src="advanced_chart_features.js"></script>
    <script src="datafeed_optimization.js"></script>
    <script src="events_and_export.js"></script>
    <script src="advanced_series_and_scale.js"></script>
    <script src="mobile_responsive.js"></script>
    <script src="candlestick_bar_series.js"></script>
    <script src="advanced_time_features.js"></script>
    <!-- <script src="performance_optimizations.js"></script> -->
    <script src="animation_effects.js"></script>
    <script src="custom_crosshair.js"></script>
    <style>
        /* ========= –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò TRADINGVIEW ========= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: #0D1421;
            color: #B2B5BE;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* ========= –ë–û–ö–û–í–ê–Ø –ü–ê–ù–ï–õ–¨ –°–õ–ï–í–ê ========= */
        .sidebar {
            width: 48px;
            background: #1E222D;
            border-right: 1px solid #2A2E39;
            display: flex;
            flex-direction: column;
            padding: 8px 0;
        }

        .sidebar-tool {
            width: 32px;
            height: 32px;
            margin: 4px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: transparent;
        }

        .sidebar-tool:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .sidebar-tool.active {
            background: #2962FF;
            color: white;
        }

        /* ========= –û–°–ù–û–í–ù–û–ô –ö–û–ù–¢–ï–ù–¢ ========= */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #0D1421;
        }

        /* ========= –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ========= */
        .top-panel {
            height: 48px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .symbol-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .symbol-details {
            font-size: 11px;
            color: #787B86;
        }

        .price-data {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .price-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .price-label {
            font-size: 10px;
            font-weight: 500;
        }

        .price-value {
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .price-change {
            font-size: 12px;
            font-weight: 500;
        }

        .price-change.positive {
            color: #00C851;
        }

        .price-change.negative {
            color: #FF4444;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –¢–ê–ô–ú–§–†–ï–ô–ú–û–í ========= */
        .toolbar-panel {
            height: 40px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            color: #B2B5BE;
            background: transparent;
            border: none;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }

        .toolbar-btn.active {
            background: #2962FF;
            color: #FFFFFF;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: #2A2E39;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ========= */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2A2E39;
            border-radius: 6px;
            font-size: 12px;
        }

        .control-group label {
            color: #B2B5BE;
            font-weight: 500;
            white-space: nowrap;
        }

        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2A2E39;
            border-radius: 4px;
            padding: 4px 8px;
            color: #FFFFFF;
            font-size: 12px;
            min-width: 80px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962FF;
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.3);
        }

        .control-btn {
            background: #2962FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #1E53E5;
            transform: translateY(-1px);
        }

        .control-btn:active {
            transform: translateY(0);
        }

        .date-input {
            width: 140px !important;
        }

        /* ========= –û–ë–õ–ê–°–¢–¨ –ì–†–ê–§–ò–ö–ê ========= */
        .chart-area {
            flex: 1;
            position: relative;
            background: #0D1421;
        }

        .chart-container {
            width: 100%;
            height: 100%;
            background: #0D1421;
        }

        .status {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            padding: 8px 12px;
            background: rgba(30, 34, 45, 0.9);
            border: 1px solid #2A2E39;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .status.success {
            border-color: #00C851;
            color: #00C851;
        }

        .status.error {
            border-color: #FF4444;
            color: #FF4444;
        }

        .status.info {
            border-color: #2962FF;
            color: #2962FF;
        }

        /* ========= –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ ========= */
        .right-panel {
            width: 280px;
            background: #1E222D;
            border-left: 1px solid #2A2E39;
            display: flex;
            flex-direction: column;
        }

        .right-panel-header {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
            border-bottom: 1px solid #2A2E39;
            background: rgba(41, 98, 255, 0.1);
        }

        .watchlist {
            flex: 1;
            overflow-y: auto;
        }

        .watchlist-header {
            padding: 8px 12px;
            font-size: 11px;
            color: #787B86;
            border-bottom: 1px solid #2A2E39;
        }

        .watchlist-item {
            padding: 12px 16px;
            border-bottom: 1px solid #2A2E39;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .watchlist-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .watchlist-item.active {
            background: rgba(41, 98, 255, 0.2);
            border-left: 3px solid #2962FF;
        }

        .watchlist-symbol {
            font-size: 13px;
            font-weight: 500;
            color: #FFFFFF;
            margin-bottom: 4px;
        }

        .watchlist-price {
            font-size: 11px;
            color: #B2B5BE;
        }

        .watchlist-change {
            font-size: 11px;
            font-weight: 500;
        }

        .watchlist-change.positive {
            color: #00C851;
        }

        .watchlist-change.negative {
            color: #FF4444;
        }

        /* ========= –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´ ========= */
        .hidden {
            display: none;
        }

        /* ========= –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ========= */
        @media (max-width: 1200px) {
            .right-panel {
                width: 240px;
            }
            
            .price-data {
                gap: 12px;
            }
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 48px;
                flex-direction: row;
                justify-content: center;
                border-right: none;
                border-bottom: 1px solid #2A2E39;
            }
            
            .right-panel {
                display: none;
            }
            
            .controls {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: space-between;
            }
            
            .top-panel {
                flex-direction: column;
                height: auto;
                padding: 8px 16px;
                gap: 8px;
            }
            
            .price-data {
                justify-content: space-around;
                width: 100%;
            }
        }

        /* ========= –ê–ù–ò–ú–ê–¶–ò–ò ========= */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        /* ========= –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–õ–£–ß–®–ï–ù–ò–Ø ========= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1E222D;
        }

        ::-webkit-scrollbar-thumb {
            background: #2A2E39;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #363A45;
        }

        select option {
            background: #1E222D;
            color: #FFFFFF;
        }

        /* ========= FULLSCREEN MODE ========= */
        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 10000;
            background: #0D1421;
        }

        .fullscreen .sidebar,
        .fullscreen .right-panel {
            display: none;
        }

        .fullscreen .main-content {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
        <div class="sidebar">
            <div class="sidebar-tool active" id="sidebar-chart" title="–ì—Ä–∞—Ñ–∏–∫">
                üìä
            </div>
            <div class="sidebar-tool" id="sidebar-indicators" title="–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã">
                üìà
            </div>
            <div class="sidebar-tool" id="sidebar-drawing" title="–†–∏—Å–æ–≤–∞–Ω–∏–µ">
                ‚úèÔ∏è
            </div>
            <div class="sidebar-tool" id="sidebar-alerts" title="–û–ø–æ–≤–µ—â–µ–Ω–∏—è">
                üîî
            </div>
            <div class="sidebar-tool" id="sidebar-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                ‚öôÔ∏è
            </div>
        </div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å -->
        <div class="main-content">
            <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å —Å —Å–∏–º–≤–æ–ª–æ–º –∏ –¥–∞–Ω–Ω—ã–º–∏ -->
            <div class="top-panel">
                <div class="symbol-info">
                    <div class="symbol-name">Coinbase Index Rank</div>
                    <div class="symbol-details">–û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è ‚Ä¢ vs <span id="comparison-instrument">BTC</span> ‚Ä¢ 1W ‚Ä¢ charts.expert</div>
                </div>
                <div class="price-data">
                    <div class="price-item">
                        <span class="price-label" style="color: #2962FF;">Rank</span>
                        <span class="price-value" id="coinbase-rank">-</span>
                    </div>
                    <div class="price-item">
                        <span class="price-label" style="color: #F7931A;" id="comparison-label">BTC</span>
                        <span class="price-value" id="comparison-price">-</span>
                    </div>
                    <div class="price-item">
                        <span class="price-change" id="rank-change">+0.00%</span>
                    </div>
                    <div class="price-item">
                        <span class="price-change" id="comparison-change">+0.00%</span>
                    </div>
                </div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ -->
            <div class="toolbar-panel">
                <div class="toolbar-group">
                    <div class="toolbar-btn active">1s</div>
                    <div class="toolbar-btn">1m</div>
                    <div class="toolbar-btn">5m</div>
                    <div class="toolbar-btn">15m</div>
                    <div class="toolbar-btn">30m</div>
                    <div class="toolbar-btn">1h</div>
                    <div class="toolbar-btn">4h</div>
                    <div class="toolbar-btn">1D</div>
                    <div class="toolbar-btn">1W</div>
                    <div class="toolbar-btn">1M</div>
                </div>
                <div class="toolbar-separator"></div>
                <div class="toolbar-group">
                    <div class="toolbar-btn">üìä</div>
                    <div class="toolbar-btn">üìà</div>
                    <div class="toolbar-btn">üìâ</div>
                    <div class="toolbar-btn">‚ö°</div>
                </div>
            </div>
            
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="controls">
                <div class="control-group" style="background: rgba(41, 98, 255, 0.1); border-color: #2962FF;">
                    <label style="color: #2962FF; font-weight: 600;">üìä Coinbase Index:</label>
                    <span style="color: #FFFFFF; font-size: 11px;">–û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–∞)</span>
                </div>
                
                <div class="control-group">
                    <label for="comparisonSelect">üéØ –°—Ä–∞–≤–Ω–∏—Ç—å —Å:</label>
                    <select id="comparisonSelect">
                        <option value="btc" selected>üü† BTC</option>
                        <option value="spx">üîµ S&P 500</option>
                        <option value="vix">üî¥ VIX</option>
                        <option value="dxy">üü¢ DXY</option>
                        <option value="total3esbtc">üü° Total3-BTC</option>
                        <option value="withoutbtceth">üü£ Without BTC/ETH</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="timeframeSelect">–¢–∞–π–º—Ñ—Ä–µ–π–º:</label>
                    <select id="timeframeSelect">
                        <option value="240">4H</option>
                        <option value="D">1D</option>
                        <option value="3D">3D</option>
                        <option value="W" selected>1W</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="maPeriodSelect">MA –ø–µ—Ä–∏–æ–¥:</label>
                    <select id="maPeriodSelect">
                        <option value="7">7</option>
                        <option value="14" selected>14</option>
                        <option value="21">21</option>
                        <option value="50">50</option>
                        <option value="200">200</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="fromDate">–°:</label>
                    <input type="date" id="fromDate" class="date-input">
                </div>
                
                <div class="control-group">
                    <label for="toDate">–ü–æ:</label>
                    <input type="date" id="toDate" class="date-input">
                </div>
                
                <button id="resetScale" class="control-btn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
                <button id="fitContent" class="control-btn">üìè –ü–æ–¥–æ–≥–Ω–∞—Ç—å</button>
                <button id="toggleFullscreen" class="control-btn">‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
            </div>
            
            <!-- –û–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ -->
            <div class="chart-area">
                <div class="chart-container" id="chart-container"></div>
                <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</div>
            </div>
        </div>
        
        <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="right-panel">
            <div class="right-panel-header">üìä Coinbase Index vs:</div>
            <div class="watchlist">
                <div class="watchlist-header" style="padding: 8px 12px; font-size: 11px; color: #787b86; border-bottom: 1px solid #2a2e39;">
                    –í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                </div>
                <div class="watchlist-item active" data-symbol="btc">
                    <div>
                        <div class="watchlist-symbol">üü† BTC</div>
                        <div class="watchlist-price">$108,082</div>
                    </div>
                    <div class="watchlist-change positive">+0.05%</div>
                </div>
                <div class="watchlist-item" data-symbol="spx">
                    <div>
                        <div class="watchlist-symbol">üîµ S&P 500</div>
                        <div class="watchlist-price">5,974</div>
                    </div>
                    <div class="watchlist-change negative">-0.32%</div>
                </div>
                <div class="watchlist-item" data-symbol="vix">
                    <div>
                        <div class="watchlist-symbol">üî¥ VIX</div>
                        <div class="watchlist-price">14.2</div>
                    </div>
                    <div class="watchlist-change positive">+2.1%</div>
                </div>
                <div class="watchlist-item" data-symbol="dxy">
                    <div>
                        <div class="watchlist-symbol">üü¢ DXY</div>
                        <div class="watchlist-price">105.8</div>
                    </div>
                    <div class="watchlist-change negative">-0.1%</div>
                </div>
                <div class="watchlist-item" data-symbol="total3esbtc">
                    <div>
                        <div class="watchlist-symbol">üü° Total3-BTC</div>
                        <div class="watchlist-price">0.0142</div>
                    </div>
                    <div class="watchlist-change positive">+1.5%</div>
                </div>
                <div class="watchlist-item" data-symbol="withoutbtceth">
                    <div>
                        <div class="watchlist-symbol">üü£ Without BTC/ETH</div>
                        <div class="watchlist-price">0.0089</div>
                    </div>
                    <div class="watchlist-change negative">-0.8%</div>
                </div>
            </div>
            <div style="padding: 8px 12px; font-size: 10px; color: #787b86; border-top: 1px solid #2a2e39; line-height: 1.4;">
                üí° –°–∏–Ω—è—è –∫—Ä–∏–≤–∞—è (—Å–ª–µ–≤–∞) - —Ä–∞–Ω–≥ Coinbase Index<br>
                üéØ –¶–≤–µ—Ç–Ω–∞—è –∫—Ä–∏–≤–∞—è (—Å–ø—Ä–∞–≤–∞) - –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
            </div>
        </div>
    </div>

    <!-- –°–∫—Ä—ã—Ç—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ -->
    <div class="hidden">
        <select id="indicatorSelect">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä</option>
            <option value="sma">SMA</option>
            <option value="ema">EMA</option>
            <option value="rsi">RSI</option>
            <option value="macd">MACD</option>
            <option value="bollinger">Bollinger Bands</option>
            <option value="stochastic">Stochastic</option>
            <option value="cbma14">CBMA14 Enhanced</option>
        </select>
        <button id="addIndicator">–î–æ–±–∞–≤–∏—Ç—å</button>
        <select id="quickTimeRange">
            <option value="">–í—ã–±—Ä–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω</option>
            <option value="7days">7 –¥–Ω–µ–π</option>
            <option value="30days">30 –¥–Ω–µ–π</option>
            <option value="3months">3 –º–µ—Å—è—Ü–∞</option>
            <option value="6months">6 –º–µ—Å—è—Ü–µ–≤</option>
            <option value="1year">1 –≥–æ–¥</option>
            <option value="2years">2 –≥–æ–¥–∞</option>
            <option value="all">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
        </select>
        <select id="exportOptions">
            <option value="">–≠–∫—Å–ø–æ—Ä—Ç</option>
            <option value="png">PNG</option>
            <option value="svg">SVG</option>
            <option value="csv">CSV</option>
        </select>
        <select id="seriesOptions">
            <option value="">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏—é</option>
            <option value="line">–õ–∏–Ω–∏—è</option>
            <option value="area">–û–±–ª–∞—Å—Ç—å</option>
            <option value="histogram">–ì–∏—Å—Ç–æ–≥—Ä–∞–º–º–∞</option>
        </select>
        <select id="priceScaleMode">
            <option value="normal">–û–±—ã—á–Ω—ã–π</option>
            <option value="logarithmic">–õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∏–π</option>
        </select>
        <button id="saveState">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="toggleTheme">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
        <button id="toggleGrid">–°–µ—Ç–∫–∞</button>
        <select id="addPriceLevels">
            <option value="">–£—Ä–æ–≤–Ω–∏ —Ü–µ–Ω</option>
            <option value="current">–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞</option>
            <option value="support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</option>
            <option value="resistance">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</option>
        </select>
        <select id="candlestickOptions">
            <option value="">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—á–∏</option>
            <option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ</option>
            <option value="hollow">–ü–æ–ª—ã–µ</option>
            <option value="heikin">Heikin-Ashi</option>
            <option value="bar">–ë–∞—Ä—ã</option>
        </select>
        <select id="timeFeatures">
            <option value="">–§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏</option>
            <option value="business_hours">–¢–æ—Ä–≥–æ–≤—ã–µ —á–∞—Å—ã</option>
            <option value="timezone">–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</option>
            <option value="goto_now">–¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</option>
            <option value="custom_marks">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏</option>
        </select>
        <select id="crosshairMode">
            <option value="normal">–û–±—ã—á–Ω—ã–π</option>
            <option value="magnet">–ú–∞–≥–Ω–∏—Ç–Ω—ã–π</option>
            <option value="hidden">–°–∫—Ä—ã—Ç—ã–π</option>
        </select>
        <select id="animationEffects">
            <option value="">–≠—Ñ—Ñ–µ–∫—Ç—ã</option>
            <option value="entrance_fade">–ü–æ—è–≤–ª–µ–Ω–∏–µ</option>
            <option value="highlight">–ü–æ–¥—Å–≤–µ—Ç–∫–∞</option>
            <option value="pulse">–ü—É–ª—å—Å–∞—Ü–∏—è</option>
            <option value="loading">–ó–∞–≥—Ä—É–∑–∫–∞</option>
        </select>
        <button id="toggleAnimations">–ê–Ω–∏–º–∞—Ü–∏–∏</button>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ config.js
        // CONFIG –¥–æ—Å—Ç—É–ø–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ

        // –î–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö
        
        // –ö–µ—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞—Ç–∞—Ö –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        const instrumentDateCache = new Map();
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
        const DateUtils = {
            toTimestamp: (date) => Math.floor(date.getTime() / 1000),
            fromTimestamp: (timestamp) => new Date(timestamp * 1000),
            toLocaleDateString: (timestamp, locale = 'ru-RU') => new Date(timestamp * 1000).toLocaleDateString(locale),
            getDaysSinceEpoch: (date) => Math.floor(date.getTime() / (24 * 60 * 60 * 1000))
        };
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º–∏
        const TimeframeUtils = {
            // –ú–∞–ø–∏–Ω–≥ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –≤ —Å—É—Ñ—Ñ–∏–∫—Å—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
            getFileSuffix: (timeframe) => {
                const mapping = { '240': '4H', 'D': '1D', '3D': '1D', 'W': '1W' };
                return mapping[timeframe] || '1D';
            },
            
            // –ú–∞–ø–∏–Ω–≥ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            getDisplayText: (timeframe) => {
                const mapping = { '240': '4H', 'D': '1D', '3D': '3D', 'W': '1W' };
                return mapping[timeframe] || '1D';
            },
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞ –ª–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏–∑ –¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            needsAggregation: (timeframe) => ['3D', 'W'].includes(timeframe),
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ API —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            getApiTimeframe: (timeframe) => {
                return TimeframeUtils.needsAggregation(timeframe) ? 'D' : timeframe;
            }
        };
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
        const DataUpdateUtils = {
            // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            async updateStartDateAndReload(reason = '–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö') {
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const fromDateInput = document.getElementById('fromDate');
                const currentFromDate = fromDateInput.value;
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
                if (!currentFromDate || new Date(currentFromDate) < new Date(commonStartDate)) {
                    fromDateInput.value = commonStartDate;
                    fromDate = commonStartDate;
                    console.log(`üìÖ Updated start date to: ${commonStartDate}`);
                    updateStatus(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ ${DateUtils.toLocaleDateString(DateUtils.toTimestamp(new Date(commonStartDate)))} –∏–∑-–∑–∞ ${reason}`, 'info');
                }
                
                console.log('üîÑ Reloading data...');
                loadData();
            }
        };
        
        let chart = null;
        let candlestickSeries = null;
        let coinbaseLineSeries = null; // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Coinbase Index
        let comparisonLineSeries = null; // –°–µ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
        let currentMAPeriod = CONFIG.DEFAULT_MA_PERIOD;
        let currentTimeframe = 'W'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
        let currentComparisonInstrument = 'btc'; // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å Coinbase
        let fromDate = null;
        let toDate = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å CONFIG
            if (typeof CONFIG === 'undefined') {
                console.error('‚ùå CONFIG not loaded! Make sure config.js is loaded before this script.');
                updateStatus('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å INSTRUMENTS –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            if (!CONFIG.INSTRUMENTS || Object.keys(CONFIG.INSTRUMENTS).length === 0) {
                console.error('‚ùå INSTRUMENTS not configured! Make sure CONFIG.INSTRUMENTS is defined.');
                updateStatus('–û—à–∏–±–∫–∞: –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'error');
                return;
            }
            
            // –û–∂–∏–¥–∞–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ TradingView Lightweight Charts
            await waitForTradingViewCharts();
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!CONFIG.INSTRUMENTS[currentComparisonInstrument]) {
                console.warn(`‚ö†Ô∏è Default comparison instrument '${currentComparisonInstrument}' not found, using first available instrument.`);
                currentComparisonInstrument = Object.keys(CONFIG.INSTRUMENTS).find(key => key !== 'coinbase') || 'btc';
                console.log(`üìä Switched to comparison instrument: ${currentComparisonInstrument}`);
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å —Ç–µ–∫—É—â–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º
            const comparisonSelect = document.getElementById('comparisonSelect');
            if (comparisonSelect) {
                comparisonSelect.value = currentComparisonInstrument;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            updateTimeframeSelector(currentComparisonInstrument);
            
            await initializeDates();
            initializeChart();
            setupEventHandlers();
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
            setTimeout(loadData, 100);
        });

        // –§—É–Ω–∫—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ TradingView Charts
        async function waitForTradingViewCharts() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å–∏–º—É–º
                
                const checkTradingView = () => {
                    attempts++;
                    
                    if (typeof LightweightCharts !== 'undefined') {
                        console.log('‚úÖ TradingView Lightweight Charts loaded successfully');
                        resolve();
                        return;
                    }
                    
                    if (attempts >= maxAttempts) {
                        console.error('‚ùå TradingView Lightweight Charts failed to load');
                        updateStatus('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ TradingView –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å', 'error');
                        reject(new Error('TradingView Charts timeout'));
                        return;
                    }
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 100ms
                    setTimeout(checkTradingView, 100);
                };
                
                checkTradingView();
            });
        }

        async function initializeDates() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∏—Å—Ö–æ–¥—è –∏–∑ –æ–±—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
            const today = new Date();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è Coinbase –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
            
            toDate = today.toISOString().split('T')[0];
            fromDate = commonStartDate;
            
            document.getElementById('fromDate').value = fromDate;
            document.getElementById('toDate').value = toDate;
            
            console.log(`üìÖ Default date range set based on common data availability: ${fromDate} to ${toDate}`);
            console.log(`‚ÑπÔ∏è Note: This is the latest start date among all data sources`);
            console.log(`üïê Default timeframe: ${currentTimeframe} (Weekly)`);
        }

        // ========================================
        // –†–ê–°–®–ò–†–ï–ù–ù–´–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–´
        // ========================================
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é Enhanced Technical Indicators –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        
        function calculateMovingAverage(values, period, type = 'SMA') {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            const data = values.map((value, index) => ({
                time: index,
                close: value
            }));
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            switch (type.toUpperCase()) {
                case 'EMA':
                    return TechnicalIndicators.ema(data, period).map(item => item.value);
                case 'SMA':
                default:
                    return TechnicalIndicators.sma(data, period).map(item => item.value);
            }
        }

        function aggregateDataByTimeframe(data, timeframe) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TimeScale API –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–ø–∏—Å–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
            if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                return window.timeScaleManager.autoAggregateDataByVisibleRange(data, {
                    maxDataPoints: 1000,
                    minDataPoints: 100
                });
            } else {
                // Fallback –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞–≥—Ä–µ–≥–∞—Ü–∏—é –µ—Å–ª–∏ TimeScale API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                return DataAggregator.aggregateTimeSeriesData(data, timeframe);
            }
        }



        // ================================================
        // –£–°–¢–ê–†–ï–í–®–ò–ï –§–£–ù–ö–¶–ò–ò –£–î–ê–õ–ï–ù–´ –ò –ó–ê–ú–ï–ù–ï–ù–´ –ù–ê 
        // –°–û–í–†–ï–ú–ï–ù–ù–´–ï –ò–ó optimized_utils.js
        // ================================================
        // –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ DataAggregator



        async function loadCSVData(filePath) {
            try {
                console.log(`üîç Loading CSV data from: ${filePath}`);
                const response = await fetch(filePath);
                
                if (!response.ok) {
                    throw new Error(`Failed to load ${filePath}: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                const timeIdx = headers.findIndex(h => h.trim() === 'time');
                const closeIdx = headers.findIndex(h => h.trim() === 'close');
                
                if (timeIdx === -1 || closeIdx === -1) {
                    throw new Error('Required columns (time, close) not found in CSV');
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',');
                    if (values.length < headers.length) continue;
                    
                    const time = parseInt(values[timeIdx]);
                    const close = parseFloat(values[closeIdx]);
                    
                    if (isNaN(time) || isNaN(close)) continue;
                    
                    data.push({
                        time: time,
                        value: close
                    });
                }
                
                console.log(`üìä Loaded ${data.length} data points from CSV`);
                return data;
                
            } catch (error) {
                console.error('‚ùå Error loading CSV data:', error);
                return [];
            }
        }

        async function getInstrumentFirstDate(instrumentKey, timeframe) {
            const cacheKey = `${instrumentKey}_${timeframe}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
            if (instrumentDateCache.has(cacheKey)) {
                return instrumentDateCache.get(cacheKey);
            }
            
            try {
                const instrument = CONFIG.INSTRUMENTS[instrumentKey];
                if (!instrument) {
                    console.error(`‚ùå Unknown instrument: ${instrumentKey}`);
                    return null;
                }

                let firstTimestamp = null;
                
                if (instrument.dataSource === 'json') {
                    // –î–ª—è JSON –¥–∞–Ω–Ω—ã—Ö (Coinbase Index)
                    try {
                        const cacheBuster = Date.now();
                        const response = await fetch(`${instrument.path}?v=${cacheBuster}`, {
                            headers: {
                                'Accept': 'application/json',
                                'Cache-Control': 'no-cache, no-store, must-revalidate'
                            }
                        });
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error(`Expected JSON, got ${contentType}`);
                        }
                        
                        const jsonData = await response.json();
                        if (jsonData.data && jsonData.data.length > 0) {
                            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –≤–∞–ª–∏–¥–Ω—É—é –¥–∞—Ç—É
                            for (const item of jsonData.data) {
                                if (item.date && item.rank != null) {
                                    const timestamp = parseDateString(item.date);
                                    if (timestamp) {
                                        firstTimestamp = timestamp;
                                        break;
                                    }
                                }
                            }
                        }
                    } catch (jsonError) {
                        console.error(`‚ùå Error loading JSON for ${instrumentKey}:`, jsonError.message);
                        return null;
                    }
                } else if (instrument.dataSource === 'csv') {
                    // –î–ª—è CSV –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è 3D –∏—Å–ø–æ–ª—å–∑—É–µ–º 1D —Ñ–∞–π–ª—ã)
                    const timeframeSuffix = TimeframeUtils.getFileSuffix(timeframe);
                    const possibleFiles = [
                        `${instrument.path}TVC_${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`,
                        `${instrument.path}SP_${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`,
                        `${instrument.path}${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`
                    ];
                    
                    for (const filePath of possibleFiles) {
                        try {
                            const response = await fetch(filePath);
                            if (response.ok) {
                                const csvText = await response.text();
                                const lines = csvText.split('\n');
                                
                                if (lines.length > 1) {
                                    const headers = lines[0].split(',');
                                    const timeIdx = headers.findIndex(h => h.trim() === 'time');
                                    
                                    if (timeIdx !== -1) {
                                        const firstDataLine = lines[1].split(',');
                                        if (firstDataLine.length > timeIdx) {
                                            const time = parseInt(firstDataLine[timeIdx]);
                                            if (!isNaN(time)) {
                                                firstTimestamp = time;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª
                        }
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                instrumentDateCache.set(cacheKey, firstTimestamp);
                
                if (firstTimestamp) {
                    console.log(`üìÖ First date for ${instrumentKey} (${timeframe}): ${DateUtils.toLocaleDateString(firstTimestamp)}`);
                }
                
                return firstTimestamp;
                
            } catch (error) {
                console.error(`‚ùå Error getting first date for ${instrumentKey}:`, error);
                return null;
            }
        }

        async function getCommonStartDate(comparisonInstrumentKey, timeframe) {
            try {
                console.log(`üîç Calculating common start date for Coinbase vs ${comparisonInstrumentKey} (${timeframe})`);
                
                const dates = [];
                
                // 1. –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ Coinbase Index (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)
                const coinbaseStartTime = await getInstrumentFirstDate('coinbase', timeframe);
                if (coinbaseStartTime) {
                    dates.push(coinbaseStartTime);
                    console.log(`üìÖ Coinbase start date: ${DateUtils.toLocaleDateString(coinbaseStartTime)}`);
                }
                
                // 2. –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const comparisonStartTime = await getInstrumentFirstDate(comparisonInstrumentKey, timeframe);
                if (comparisonStartTime) {
                    dates.push(comparisonStartTime);
                    console.log(`üìÖ ${comparisonInstrumentKey} start date: ${DateUtils.toLocaleDateString(comparisonStartTime)}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –¥–∞—Ç–∞
                if (dates.length === 0) {
                    console.warn('‚ö†Ô∏è No valid start dates found, using default fallback');
                    return '2017-01-01'; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fallback
                }
                
                // –ë–µ—Ä–µ–º —Å–∞–º—É—é –ø–æ–∑–¥–Ω—é—é –¥–∞—Ç—É (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é)
                const commonStartTime = Math.max(...dates);
                const commonStartDate = new Date(commonStartTime * 1000).toISOString().split('T')[0];
                
                console.log(`‚úÖ Common start date: ${commonStartDate} (${DateUtils.toLocaleDateString(commonStartTime)})`);
                
                return commonStartDate;
                
            } catch (error) {
                console.error('‚ùå Error calculating common start date:', error);
                return '2017-01-01'; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fallback
            }
        }

        async function loadCoinbaseData(fromTime, toTime) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index –∏–∑ JSON (–ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô –∏—Å—Ç–æ—á–Ω–∏–∫)
                console.log('üìä Loading Coinbase Index from data.json...');
                
                // –î–æ–±–∞–≤–ª—è–µ–º cache-busting –ø–∞—Ä–∞–º–µ—Ç—Ä –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                const cacheBuster = Date.now();
                const response = await fetch(`/data/data.json?v=${cacheBuster}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache, no-store, must-revalidate',
                        'Pragma': 'no-cache',
                        'Expires': '0'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º Content-Type –ø–µ—Ä–µ–¥ –ø–∞—Ä—Å–∏–Ω–≥–æ–º
                const contentType = response.headers.get('content-type');
                console.log('üìä Response Content-Type:', contentType);
                
                if (!contentType || !contentType.includes('application/json')) {
                    const textResponse = await response.text();
                    console.error('‚ùå Expected JSON, got:', contentType);
                    console.error('‚ùå Response text (first 500 chars):', textResponse.substring(0, 500));
                    throw new Error(`Expected JSON, got ${contentType || 'unknown'}`);
                }
                
                const jsonData = await response.json();
                console.log('üìä JSON data loaded, title:', jsonData.title);
                
                if (!jsonData.data || !Array.isArray(jsonData.data)) {
                    throw new Error('Invalid Coinbase data structure in JSON');
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                const allData = [];
                for (const item of jsonData.data) {
                    if (!item.date || item.rank == null) continue;

                    const timestamp = parseDateString(item.date);
                    if (!timestamp) continue;

                    allData.push({
                        time: timestamp,
                        value: parseFloat(item.rank),
                    });
                }

                if (allData.length === 0) {
                    throw new Error('No valid Coinbase data found in JSON');
                }
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                allData.sort((a, b) => a.time - b.time);
                console.log(`üìä Loaded ${allData.length} Coinbase data points from JSON`);

                // –í—ã—á–∏—Å–ª—è–µ–º Moving Average —Å –ø–æ–º–æ—â—å—é TradingView Lightweight Charts
                const rawValues = allData.map(item => item.value);
                const maValues = calculateMovingAverage(rawValues, currentMAPeriod);

                // –°–æ–∑–¥–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å MA –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–≤–µ—Ä—Ö –≥—Ä–∞—Ñ–∏–∫–∞
                const finalData = [];
                for (let i = 0; i < maValues.length; i++) {
                    const originalIndex = i + currentMAPeriod - 1;
                    if (originalIndex < allData.length) {
                        finalData.push({
                            time: allData[originalIndex].time,
                            value: maValues[i]
                        });
                    }
                }

                console.log(`üìä Coinbase MA${currentMAPeriod} ready: ${finalData.length} points`);

                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É
                const filteredData = finalData.filter(item => 
                    item.time >= fromTime && item.time <= toTime
                );

                console.log(`üìä Filtered Coinbase MA: ${filteredData.length} points`);

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–µ—Ä–∏—é (MA –ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
                if (coinbaseLineSeries && filteredData.length > 0) {
                    coinbaseLineSeries.setData(filteredData);
                    console.log('‚úÖ Coinbase MA data set to series (overlay)');
                } else {
                    console.warn('‚ö†Ô∏è Coinbase series not initialized or no data');
                }

            } catch (error) {
                console.error('‚ùå Error loading Coinbase data:', error);
                updateStatus(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ Coinbase Index: ${error.message}`, 'error');
                // –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback - –¥–∞–Ω–Ω—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑ JSON!
            }
        }

        async function loadComparisonInstrumentData(fromTime, toTime) {
            try {
                const instrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (!instrument) {
                    console.error(`‚ùå Unknown comparison instrument: ${currentComparisonInstrument}`);
                    return;
                }

                let data = [];

                if (instrument.dataSource === 'api') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API (–¥–ª—è BTC)
                    data = await loadAPIData(instrument, fromTime, toTime);
                } else if (instrument.dataSource === 'csv') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤
                    data = await loadInstrumentCSVData(instrument);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
                    if (data.length > 0) {
                        data = data.filter(item => item.time >= fromTime && item.time <= toTime);
                    }
                }

                if (data.length === 0) {
                    console.warn(`‚ö†Ô∏è No data loaded for ${instrument.name}`);
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ—Ä–∏—é
                if (instrument.seriesType === 'candlestick' && candlestickSeries) {
                    candlestickSeries.setData(data);
                } else if (comparisonLineSeries) {
                    comparisonLineSeries.setData(data);
                }

                console.log(`‚úÖ ${instrument.name} data loaded: ${data.length} points`);

            } catch (error) {
                console.error('‚ùå Error loading comparison instrument data:', error);
            }
        }

        async function loadAPIData(instrument, fromTime, toTime) {
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API —Ç–∞–π–º—Ñ—Ä–µ–π–º (API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ >= 4H)
                const apiTimeframe = TimeframeUtils.getApiTimeframe(currentTimeframe);
                
                if (TimeframeUtils.needsAggregation(currentTimeframe)) {
                    console.log(`üìä Loading 1D API data for ${currentTimeframe} timeframe (will be aggregated locally)`);
                }
                
                const apiUrl = `${CONFIG.API_BASE_URL}/history?symbol=${instrument.apiSymbol}&resolution=${apiTimeframe}&from=${fromTime}&to=${toTime}`;
                console.log(`üîó API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const apiData = await response.json();
                
                console.log('üìä API Response:', apiData);
                console.log('üìä API Response status:', apiData.s);
                console.log('üìä API Response data keys:', Object.keys(apiData));

                if (apiData.s === 'ok' && apiData.t && apiData.o && apiData.h && apiData.l && apiData.c) {
                    console.log(`üìä API returned ${apiData.t.length} candles for ${instrument.apiSymbol}`);
                    
                    let candleData = [];
                    for (let i = 0; i < apiData.t.length; i++) {
                        if (apiData.t[i] && apiData.o[i] != null && apiData.h[i] != null && 
                            apiData.l[i] != null && apiData.c[i] != null) {
                            candleData.push({
                                time: apiData.t[i],
                                open: parseFloat(apiData.o[i]),
                                high: parseFloat(apiData.h[i]),
                                low: parseFloat(apiData.l[i]),
                                close: parseFloat(apiData.c[i]),
                            });
                        }
                    }

                    console.log(`üìä Processed ${candleData.length} valid candles`);

                    // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
                    if (currentTimeframe === 'W' && apiTimeframe === 'D') {
                        candleData = DataAggregator.aggregateTimeSeriesData(candleData, 'W');
                        console.log(`üìä API data aggregated to weekly: ${candleData.length} candles`);
                    } else if (currentTimeframe === '3D' && apiTimeframe === 'D') {
                        candleData = DataAggregator.aggregateTimeSeriesData(candleData, '3D');
                        console.log(`üìä API data aggregated to 3-day: ${candleData.length} candles`);
                    }

                    return candleData;
                } else {
                    console.error('‚ùå API response error details:');
                    console.error('- Status:', apiData.s);
                    console.error('- Message:', apiData.errmsg || 'No error message');
                    console.error('- Has time data:', !!apiData.t);
                    console.error('- Has OHLC data:', !!apiData.o && !!apiData.h && !!apiData.l && !!apiData.c);
                    
                    if (apiData.s === 'no_data') {
                        console.warn('‚ö†Ô∏è No data available for the requested period');
                        return [];
                    }
                    
                    throw new Error(`API error: ${apiData.s} - ${apiData.errmsg || 'Unknown error'}`);
                }

            } catch (error) {
                console.error('‚ùå Error loading API data:', error);
                console.error('‚ùå Error type:', error.constructor.name);
                console.error('‚ùå Error message:', error.message);
                return [];
            }
        }

        async function loadInstrumentCSVData(instrument) {
            try {
                // –î–ª—è 3D —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ
                const timeframeSuffix = TimeframeUtils.getFileSuffix(currentTimeframe);
                
                if (currentTimeframe === '3D') {
                    console.log(`üìä Loading 1D CSV data for 3D timeframe (will be aggregated locally)`);
                }
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤
                const possibleFiles = [
                    `${instrument.path}TVC_${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`,
                    `${instrument.path}SP_${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`,
                    `${instrument.path}${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`
                ];
                
                for (const filePath of possibleFiles) {
                    const data = await loadCSVData(filePath);
                    if (data.length > 0) {
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º moving average –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if (currentMAPeriod > 1) {
                            const rawValues = data.map(item => item.value);
                            const maValues = calculateMovingAverage(rawValues, currentMAPeriod);
                            
                            const maData = [];
                            const startIndex = currentMAPeriod - 1;
                            
                            for (let i = 0; i < maValues.length; i++) {
                                const originalIndex = startIndex + i;
                                if (originalIndex < data.length) {
                                    maData.push({
                                        time: data[originalIndex].time,
                                        value: maValues[i]
                                    });
                                }
                            }
                            
                            return aggregateDataByTimeframe(maData, currentTimeframe);
                        } else {
                            return aggregateDataByTimeframe(data, currentTimeframe);
                        }
                    }
                }
                
                return [];

            } catch (error) {
                console.error('‚ùå Error loading CSV instrument data:', error);
                return [];
            }
        }



        function createCoinbaseSeries() {
            if (!chart) {
                console.error('‚ö†Ô∏è Chart not initialized, cannot create Coinbase series');
                return;
            }
            
            try {
                // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
                if (coinbaseLineSeries) {
                    chart.removeSeries(coinbaseLineSeries);
                    coinbaseLineSeries = null;
                }
                
                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏—é –¥–ª—è Coinbase Index Moving Average (–ø–æ–≤–µ—Ä—Ö –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
                coinbaseLineSeries = chart.addLineSeries({
                    color: '#2962FF',           // TradingView —Å–∏–Ω–∏–π - —Ö–æ—Ä–æ—à–æ –≤–∏–¥–Ω–æ –ø–æ–≤–µ—Ä—Ö
                    lineWidth: 3,               // –¢–æ–ª—â–µ —á–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ 
                    priceScaleId: 'left',       // –õ–µ–≤–∞—è –æ—Å—å –¥–ª—è —Ä–∞–Ω–≥–∞ (1-100)
                    title: `Coinbase Index MA${currentMAPeriod}`,
                    lastValueVisible: true,
                    priceLineVisible: true,
                    crosshairMarkerVisible: true,
                    crosshairMarkerRadius: 5,
                    crosshairMarkerBorderColor: '#2962FF',
                    crosshairMarkerBackgroundColor: '#2962FF',
                });
                
                if (!coinbaseLineSeries) {
                    throw new Error('Failed to create line series - returned null');
                }
                
                console.log(`‚úÖ Coinbase MA${currentMAPeriod} series created (overlay)`);
                
            } catch (error) {
                console.error('‚ùå Error creating Coinbase series:', error);
                console.error('‚ùå Chart object available methods:', Object.keys(chart).filter(k => typeof chart[k] === 'function'));
                throw new Error('Failed to create Coinbase MA series');
            }
        }

        function createComparisonSeries() {
            if (!chart) {
                console.error('‚ö†Ô∏è Chart not initialized, cannot create comparison series');
                return;
            }
            
            try {
                // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–µ—Ä–∏—é –µ—Å–ª–∏ –µ—Å—Ç—å
                if (comparisonLineSeries) {
                    chart.removeSeries(comparisonLineSeries);
                    comparisonLineSeries = null;
                }
                
                // –ü–æ–ª—É—á–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                const instrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (!instrument) {
                    console.error(`‚ùå Unknown comparison instrument: ${currentComparisonInstrument}`);
                    return;
                }
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç (–±–æ–ª–µ–µ –ø—Ä–∏–≥–ª—É—à–µ–Ω–Ω—ã–π, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ —Ñ–æ–Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)
                const colors = {
                    'btc': '#F7931A',    
                    'spx': '#4285F4',    
                    'vix': '#DB4437',    
                    'dxy': '#0F9D58',    
                    'total3esbtc': '#FF6B35',
                    'withoutbtceth': '#6A4C93'
                };
                
                const seriesColor = colors[currentComparisonInstrument] || instrument.color || '#FF9800';
                
                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏—é (–æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç—Å—è MA)
                if (instrument.seriesType === 'candlestick') {
                    comparisonLineSeries = chart.addCandlestickSeries({
                        upColor: '#00C851',
                        downColor: '#FF4444',
                        borderVisible: true,
                        wickUpColor: '#00C851',
                        wickDownColor: '#FF4444',
                        borderUpColor: '#00C851',
                        borderDownColor: '#FF4444',
                        priceScaleId: 'right',      // –ü—Ä–∞–≤–∞—è –æ—Å—å –¥–ª—è —Ü–µ–Ω—ã
                        title: instrument.name,
                        lastValueVisible: true,
                        priceLineVisible: false,    // –£–±–∏—Ä–∞–µ–º —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ MA
                        crosshairMarkerVisible: true,
                    });
                } else {
                    comparisonLineSeries = chart.addLineSeries({
                        color: seriesColor,
                        lineWidth: 2,
                        priceScaleId: 'right',      // –ü—Ä–∞–≤–∞—è –æ—Å—å –¥–ª—è —Ü–µ–Ω—ã/–∏–Ω–¥–µ–∫—Å–∞
                        title: instrument.name,
                        lastValueVisible: true,
                        priceLineVisible: false,    // –£–±–∏—Ä–∞–µ–º —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ MA
                        crosshairMarkerVisible: true,
                        crosshairMarkerRadius: 4,
                        crosshairMarkerBorderColor: seriesColor,
                        crosshairMarkerBackgroundColor: seriesColor,
                    });
                }
                
                if (!comparisonLineSeries) {
                    throw new Error('Failed to create comparison series - returned null');
                }
                
                console.log(`‚úÖ ${instrument.name} series created (background data for MA overlay)`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–º–≤–æ–ª–µ
                updateSymbolInfo(currentComparisonInstrument);
                
            } catch (error) {
                console.error('‚ùå Error creating comparison series:', error);
                console.error('‚ùå Chart object available methods:', Object.keys(chart).filter(k => typeof chart[k] === 'function'));
                throw new Error('Failed to create comparison series');
            }
        }

        function parseDateString(dateStr) {
            try {
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É —Ç–∏–ø–∞ "Fri, Jul 4, 25"
                const parts = dateStr.split(',').map(s => s.trim());
                if (parts.length !== 3) return null;

                const monthDay = parts[1]; // "Jul 4"
                const year = parts[2]; // "25"

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ–¥ –≤ –ø–æ–ª–Ω—ã–π
                let fullYear;
                if (year.length === 2) {
                    const yearNum = parseInt(year);
                    // –î–ª—è –¥–∞–Ω–Ω—ã—Ö: "25" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 2023, –Ω–æ –ø–æ—Å–∫–æ–ª—å–∫—É —É –Ω–∞—Å "25" –≤ –¥–∞–Ω–Ω—ã—Ö 
                    // –≤–µ—Ä–æ—è—Ç–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç 2023 –≥–æ–¥, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
                    // 00-30 = 20xx, 31-99 = 19xx
                    fullYear = yearNum <= 30 ? '20' + year : '19' + year;
                } else {
                    fullYear = year;
                }

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É
                const fullDate = `${monthDay}, ${fullYear}`;
                const date = new Date(fullDate);

                if (isNaN(date.getTime())) return null;

                return DateUtils.toTimestamp(date);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error parsing date:', dateStr, error);
                return null;
            }
        }

        async function initializeChart() {
            try {
                const container = document.getElementById('chart-container');
                if (!container) {
                    throw new Error('Chart container not found');
                }

                updateStatus('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞...', 'info');

                // –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ TradingView Charts –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                if (typeof LightweightCharts === 'undefined') {
                    console.log('‚è≥ Waiting for TradingView Lightweight Charts to load...');
                    await waitForTradingViewCharts();
                }

                console.log('‚úÖ TradingView Lightweight Charts is available');

                // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                container.innerHTML = '';

                // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞—Ñ–∏–∫ —Å –ø—Ä–æ—Å—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 600,
                    layout: {
                        backgroundColor: '#0D1421',
                        textColor: '#B2B5BE',
                    },
                    grid: {
                        vertLines: { 
                            color: 'rgba(42, 46, 57, 0.3)',
                        },
                        horzLines: { 
                            color: 'rgba(42, 46, 57, 0.3)',
                        },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#2A2E39',
                        visible: true,
                    },
                    leftPriceScale: {
                        borderColor: '#2A2E39',
                        visible: true,
                    },
                    timeScale: {
                        borderColor: '#2A2E39',
                        timeVisible: true,
                    },
                });

                console.log('‚úÖ Chart created successfully');

                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏–∏
                createCoinbaseSeries();
                createComparisonSeries();

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                window.addEventListener('resize', () => {
                    if (chart && chart.applyOptions) {
                        chart.applyOptions({ width: container.clientWidth });
                    }
                });

                console.log('‚úÖ Lightweight Charts initialized');
                updateStatus('–ì—Ä–∞—Ñ–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');

            } catch (error) {
                console.error('‚ùå Chart initialization failed:', error);
                updateStatus(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadData() {
            try {
                updateStatus(CONFIG.MESSAGES.LOADING, 'info');

                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
                const fromDateValue = document.getElementById('fromDate').value;
                const toDateValue = document.getElementById('toDate').value;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const commonStartTime = DateUtils.toTimestamp(new Date(commonStartDate));
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ timestamp —Å —É—á–µ—Ç–æ–º –æ–±—â–µ–π –Ω–∞—á–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
                const requestedFromTime = fromDateValue ? DateUtils.toTimestamp(new Date(fromDateValue)) : commonStartTime;
                const effectiveFromTime = Math.max(requestedFromTime, commonStartTime); // –ù–µ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–∞—Ç—ã
                const toTime = toDateValue ? DateUtils.toTimestamp(new Date(toDateValue + 'T23:59:59')) : DateUtils.toTimestamp(new Date());
                
                console.log(`üìÖ Requested from: ${DateUtils.toLocaleDateString(requestedFromTime)}`);
                console.log(`üìÖ Common start: ${DateUtils.toLocaleDateString(commonStartTime)}`);
                console.log(`üìÖ Effective from: ${DateUtils.toLocaleDateString(effectiveFromTime)}`);
                console.log(`üìÖ To: ${DateUtils.toLocaleDateString(toTime)}`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –¥–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                const fromTime = effectiveFromTime;

                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
                const timeframeSelect = document.getElementById('timeframeSelect');
                currentTimeframe = timeframeSelect ? timeframeSelect.value : 'W';
                
                // 1. –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index
                console.log('üìä Loading Coinbase Index data...');
                await loadCoinbaseData(fromTime, toTime);
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                console.log(`üìä Loading comparison instrument: ${CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name}...`);
                await loadComparisonInstrumentData(fromTime, toTime);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
                updateLegend();
                
                // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–µ—Ä–∏–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ü–µ–Ω
                let coinbaseSeriesData = null;
                let comparisonSeriesData = null;
                
                try {
                    if (coinbaseLineSeries && coinbaseLineSeries.data) {
                        coinbaseSeriesData = coinbaseLineSeries.data();
                    }
                    if (comparisonLineSeries && comparisonLineSeries.data) {
                        comparisonSeriesData = comparisonLineSeries.data();
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not get series data for price update:', error);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ü–µ–Ω –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏
                updatePriceData(coinbaseSeriesData, comparisonSeriesData);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∏–º–≤–æ–ª–µ
                updateSymbolInfo(currentComparisonInstrument);
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                setTimeout(() => {
                    refreshChart();
                }, 300);
                
                setTimeout(() => {
                    refreshChart();
                }, 800);
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞
                setTimeout(() => {
                    fitAllContent();
                }, 1200);
                
                const timeframeText = TimeframeUtils.getDisplayText(currentTimeframe);
                const coinbaseName = `Coinbase Index MA${currentMAPeriod}`;
                const comparisonName = CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name || 'Unknown';
                const commonDate = DateUtils.toLocaleDateString(commonStartTime);
                updateStatus(`üìä ${coinbaseName} overlay on ${comparisonName} | ${timeframeText} | –î–∞–Ω–Ω—ã–µ —Å ${commonDate}`, 'success');

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                updateStatus(CONFIG.MESSAGES.ERROR, 'error');
            }
        }



        function setupScaleSynchronization() {
            if (!chart) return;
            
            try {
                // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                // –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
                
                console.log('‚úÖ Scale synchronization setup completed (minimal)');
            } catch (error) {
                console.warn('‚ö†Ô∏è Scale synchronization not available:', error);
            }
        }

        function refreshChart() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot refresh');
                return;
            }
            
            try {
                console.log('üîÑ Refreshing chart layout...');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–≥–æ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É
                const timeScale = chart.timeScale();
                timeScale.fitContent();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
                const container = document.getElementById('chart-container');
                if (container) {
                    chart.resize(container.clientWidth, 600);
                }
                
                // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω–æ–≤—ã—Ö —à–∫–∞–ª —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                    console.log('üìä BTC price scale (right) refreshed');
                }
                
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                    console.log('üìä Instrument price scale (left) refreshed');
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                setTimeout(() => {
                    timeScale.fitContent();
                }, 50);
                
                console.log('‚úÖ Chart refreshed successfully');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error refreshing chart:', error);
            }
        }

        function setOptimalInitialRange() {
            if (!chart) return;
            
            try {
                console.log('üéØ Setting optimal initial time range...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞
                const now = Math.floor(Date.now() / 1000);
                const twoYearsAgo = now - (2 * 365 * 24 * 60 * 60); // 2 –≥–æ–¥–∞ –Ω–∞–∑–∞–¥
                
                const timeScale = chart.timeScale();
                timeScale.setVisibleRange({
                    from: twoYearsAgo,
                    to: now
                });
                
                console.log('üìä Initial range set to last 2 years for better visibility');
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not set initial range:', error);
            }
        }

        function resetAllScaling() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot reset scaling');
                return;
            }
            
            try {
                console.log('üîÑ Resetting all chart scaling...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º TimeScale Manager –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                    window.timeScaleManager.resetTimeScale();
                } else {
                    // Fallback –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤
                    const timeScale = chart.timeScale();
                    if (timeScale.resetTimeScale) {
                        timeScale.resetTimeScale();
                    } else {
                        timeScale.fitContent();
                    }
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É (BTC)
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–µ–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É (–≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                }
                
                console.log('‚úÖ All scaling reset successfully');
                updateStatus('–ú–∞—Å—à—Ç–∞–± –≤—Å–µ—Ö –æ—Å–µ–π —Å–±—Ä–æ—à–µ–Ω', 'success');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error resetting scaling:', error);
                updateStatus('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –º–∞—Å—à—Ç–∞–±–∞', 'error');
            }
        }

        function fitAllContent() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot fit content');
                return;
            }
            
            try {
                console.log('üîÑ Fitting all content...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º TimeScale Manager –¥–ª—è –ø–æ–¥–≥–æ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                    window.timeScaleManager.fitContent();
                } else {
                    // Fallback –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤
                    chart.timeScale().fitContent();
                }
                
                // –ü–æ–¥–≥–æ–Ω—è–µ–º –ø—Ä–∞–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                    });
                }
                
                // –ü–æ–¥–≥–æ–Ω—è–µ–º –ª–µ–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É  
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                    });
                }
                
                console.log('‚úÖ All content fitted successfully');
                updateStatus('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–æ–≥–Ω–∞–Ω—ã –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞', 'success');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error fitting content:', error);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ–Ω–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ', 'error');
            }
        }

        function setupEventHandlers() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const requiredElements = ['comparisonSelect', 'timeframeSelect', 'maPeriodSelect', 'fromDate', 'toDate', 'resetScale', 'fitContent'];
            for (const elementId of requiredElements) {
                if (!document.getElementById(elementId)) {
                    console.error(`‚ùå Required DOM element not found: ${elementId}`);
                    updateStatus(`–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç ${elementId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                    return;
                }
            }
            
            // –°–º–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            document.getElementById('comparisonSelect').addEventListener('change', async (e) => {
                currentComparisonInstrument = e.target.value;
                console.log(`üìä Comparison instrument changed to: ${currentComparisonInstrument}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                updateTimeframeSelector(currentComparisonInstrument);
                
                // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                createComparisonSeries();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                await DataUpdateUtils.updateStartDateAndReload('–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
            
            // –°–º–µ–Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            document.getElementById('timeframeSelect').addEventListener('change', async (e) => {
                currentTimeframe = e.target.value;
                console.log(`üìä Timeframe changed to: ${currentTimeframe}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
                await DataUpdateUtils.updateStartDateAndReload('–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
            
            // –°–º–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞ MA
            document.getElementById('maPeriodSelect').addEventListener('change', (e) => {
                currentMAPeriod = parseInt(e.target.value);
                loadData();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç
            document.getElementById('fromDate').addEventListener('change', async (e) => {
                const selectedDate = e.target.value;
                console.log(`üìÖ FROM date changed to: ${selectedDate}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const commonStartTime = new Date(commonStartDate);
                const selectedTime = new Date(selectedDate);
                
                if (selectedTime < commonStartTime) {
                    console.warn(`‚ö†Ô∏è Selected date (${selectedDate}) is before common data availability (${commonStartDate})`);
                    updateStatus(`–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (—Å ${DateUtils.toLocaleDateString(DateUtils.toTimestamp(new Date(commonStartDate)))}). –î–∞—Ç–∞ –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞.`, 'info');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                    e.target.value = commonStartDate;
                    fromDate = commonStartDate;
                } else {
                    fromDate = selectedDate;
                }
                
                console.log('üîÑ Reloading data with new date range...');
                loadData();
            });

            document.getElementById('toDate').addEventListener('change', (e) => {
                toDate = e.target.value;
                console.log(`üìÖ TO date changed to: ${toDate}`);
                console.log('üîÑ Reloading data with new date range...');
                loadData();
            });

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º
            document.getElementById('resetScale').addEventListener('click', () => {
                console.log('üîÑ Reset scale button clicked');
                resetAllScaling();
            });

            document.getElementById('fitContent').addEventListener('click', () => {
                console.log('üìè Fit content button clicked');
                fitAllContent();
            });

            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            document.getElementById('addIndicator').addEventListener('click', () => {
                addSelectedIndicator();
            });

            // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            document.getElementById('quickTimeRange').addEventListener('change', (e) => {
                handleQuickTimeRangeSelection(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            document.getElementById('toggleTheme').addEventListener('click', () => {
                toggleChartTheme();
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
            document.getElementById('toggleGrid').addEventListener('click', () => {
                toggleChartGrid();
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π —Ü–µ–Ω
            document.getElementById('addPriceLevels').addEventListener('change', (e) => {
                handlePriceLevelAdd(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // ===============================================
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô
            // ===============================================

            // –≠–∫—Å–ø–æ—Ä—Ç
            document.getElementById('exportOptions').addEventListener('change', (e) => {
                handleExportAction(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–∏–π
            document.getElementById('seriesOptions').addEventListener('change', (e) => {
                handleSeriesAdd(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —à–∫–∞–ª—ã —Ü–µ–Ω
            document.getElementById('priceScaleMode').addEventListener('change', (e) => {
                handlePriceScaleModeChange(e.target.value);
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            document.getElementById('saveState').addEventListener('click', () => {
                handleSaveState();
            });

            // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            document.getElementById('toggleFullscreen').addEventListener('click', () => {
                handleToggleFullscreen();
            });

            // Candlestick —Å–µ—Ä–∏–∏
            document.getElementById('candlestickOptions').addEventListener('change', (e) => {
                handleCandlestickAdd(e.target.value);
                e.target.value = '';
            });

            // –§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('timeFeatures').addEventListener('change', (e) => {
                handleTimeFeature(e.target.value);
                e.target.value = '';
            });

            // –†–µ–∂–∏–º crosshair
            document.getElementById('crosshairMode').addEventListener('change', (e) => {
                handleCrosshairModeChange(e.target.value);
            });

            // –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            document.getElementById('animationEffects').addEventListener('change', (e) => {
                handleAnimationEffect(e.target.value);
                e.target.value = '';
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π
            document.getElementById('toggleAnimations').addEventListener('click', () => {
                handleToggleAnimations();
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ toolbar
            setupToolbarHandlers();

            // ===============================================
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò TRADINGVIEW-STYLE –ò–ù–¢–ï–†–§–ï–ô–°–ê
            // ===============================================

            // –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å
            setupSidebarHandlers();

            // –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å (watchlist)
            setupWatchlistHandlers();

            // –ü–∞–Ω–µ–ª—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            setupTradingViewToolbarHandlers();

            console.log('‚úÖ All event handlers set up successfully');
        }

        function setupSidebarHandlers() {
            const sidebarTools = document.querySelectorAll('.sidebar-tool');
            
            sidebarTools.forEach(tool => {
                tool.addEventListener('click', () => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
                    sidebarTools.forEach(t => t.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É
                    tool.classList.add('active');
                    
                    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç ID
                    const toolId = tool.id;
                    switch(toolId) {
                        case 'sidebar-chart':
                            showChartPanel();
                            break;
                        case 'sidebar-indicators':
                            showIndicatorsPanel();
                            break;
                        case 'sidebar-drawing':
                            showDrawingPanel();
                            break;
                        case 'sidebar-alerts':
                            showAlertsPanel();
                            break;
                        case 'sidebar-settings':
                            showSettingsPanel();
                            break;
                        default:
                            console.log(`Sidebar tool clicked: ${toolId}`);
                    }
                });
            });
        }

        function setupWatchlistHandlers() {
            const watchlistItems = document.querySelectorAll('.watchlist-item');
            
            watchlistItems.forEach(item => {
                item.addEventListener('click', () => {
                    // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    watchlistItems.forEach(i => i.classList.remove('active'));
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É
                    item.classList.add('active');
                    
                    // –ü–æ–ª—É—á–∞–µ–º —Å–∏–º–≤–æ–ª –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
                    const symbol = item.dataset.symbol;
                    if (symbol && symbol !== currentComparisonInstrument) {
                        currentComparisonInstrument = symbol;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
                        const comparisonSelect = document.getElementById('comparisonSelect');
                        if (comparisonSelect) {
                            comparisonSelect.value = symbol;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        updateTimeframeSelector(currentComparisonInstrument);
                        createComparisonSeries();
                        DataUpdateUtils.updateStartDateAndReload('—Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                        
                        updateStatus(`üìä Coinbase Index vs ${CONFIG.INSTRUMENTS[symbol]?.name || symbol} - –∫–æ—Ä—Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑`, 'success');
                    }
                });
            });
        }

        function setupTradingViewToolbarHandlers() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            const timeframeButtons = document.querySelectorAll('.toolbar-panel .toolbar-btn');
            
            timeframeButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const timeframeText = button.textContent.trim();
                    
                    // –ú–∞–ø–ø–∏–Ω–≥ –∫–Ω–æ–ø–æ–∫ –Ω–∞ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
                    const timeframeMap = {
                        '1s': '1',
                        '1m': '1',
                        '5m': '5',
                        '15m': '15',
                        '30m': '30',
                        '1h': '60',
                        '4h': '240',
                        '1D': 'D',
                        '1W': 'W',
                        '1M': 'M'
                    };
                    
                    const newTimeframe = timeframeMap[timeframeText];
                    if (newTimeframe && getSupportedTimeframes(currentComparisonInstrument).includes(newTimeframe)) {
                        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
                        timeframeButtons.forEach(btn => btn.classList.remove('active'));
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–µ
                        button.classList.add('active');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–π–º—Ñ—Ä–µ–π–º
                        currentTimeframe = newTimeframe;
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
                        const timeframeSelect = document.getElementById('timeframeSelect');
                        if (timeframeSelect) {
                            timeframeSelect.value = newTimeframe;
                        }
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
                        DataUpdateUtils.updateStartDateAndReload('—Å–º–µ–Ω—ã —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞');
                        updateStatus(`–¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${timeframeText}`, 'success');
                    } else {
                        updateStatus(`–¢–∞–π–º—Ñ—Ä–µ–π–º ${timeframeText} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –¥–ª—è ${CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name}`, 'error');
                    }
                });
            });
        }

        function showChartPanel() {
            updateStatus('–ü–∞–Ω–µ–ª—å –≥—Ä–∞—Ñ–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞', 'info');
        }

        function showDrawingPanel() {
            updateStatus('–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∏—Å–æ–≤–∞–Ω–∏—è –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã', 'info');
        }

        function showAlertsPanel() {
            updateStatus('–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞', 'info');
        }

        function showSettingsPanel() {
            // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.7);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            const panel = document.createElement('div');
            panel.style.cssText = `
                background: #1e222d;
                border: 1px solid #2a2e39;
                border-radius: 8px;
                padding: 20px;
                max-width: 400px;
                color: #d1d4dc;
                max-height: 80vh;
                overflow-y: auto;
            `;
            
            panel.innerHTML = `
                <h3 style="margin-top: 0; color: #ffffff;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;">–¢–µ–º–∞:</label>
                    <button onclick="toggleChartTheme()" style="padding: 8px 16px; background: #2962ff; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É</button>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;">–°–µ—Ç–∫–∞:</label>
                    <button onclick="toggleChartGrid()" style="padding: 8px 16px; background: #2962ff; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–µ—Ç–∫—É</button>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω:</label>
                    <button onclick="handleToggleFullscreen()" style="padding: 8px 16px; background: #2962ff; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px;">–ê–Ω–∏–º–∞—Ü–∏–∏:</label>
                    <button onclick="handleToggleAnimations()" style="padding: 8px 16px; background: #2962ff; color: white; border: none; border-radius: 4px; cursor: pointer;">–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏</button>
                </div>
                <div style="margin: 15px 0;">
                    <button onclick="handleSaveState()" style="padding: 8px 16px; background: #00c851; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ</button>
                    <button onclick="this.closest('.modal').remove()" style="padding: 8px 16px; background: #ff4444; color: white; border: none; border-radius: 4px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            
            modal.className = 'modal';
            modal.appendChild(panel);
            document.body.appendChild(modal);
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –ø–∞–Ω–µ–ª–∏
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        function updatePriceData(coinbaseData, comparisonData) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index (—Ä–∞–Ω–≥)
            if (coinbaseData && coinbaseData.length > 0) {
                const latestCoinbase = coinbaseData[coinbaseData.length - 1];
                const previousCoinbase = coinbaseData.length > 1 ? coinbaseData[coinbaseData.length - 2] : latestCoinbase;
                
                const coinbaseRank = document.getElementById('coinbase-rank');
                const rankChange = document.getElementById('rank-change');
                
                if (coinbaseRank) {
                    const currentRank = latestCoinbase.value || latestCoinbase.close || latestCoinbase;
                    coinbaseRank.textContent = currentRank?.toFixed(1) || '-';
                }
                
                if (rankChange && typeof latestCoinbase.value === 'number' && typeof previousCoinbase.value === 'number') {
                    const change = latestCoinbase.value - previousCoinbase.value;
                    const changePercent = (change / previousCoinbase.value) * 100;
                    
                    const sign = change >= 0 ? '+' : '';
                    rankChange.textContent = `${sign}${changePercent.toFixed(2)}%`;
                    rankChange.className = change >= 0 ? 'price-change positive' : 'price-change negative';
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            if (comparisonData && comparisonData.length > 0) {
                const latestComparison = comparisonData[comparisonData.length - 1];
                const previousComparison = comparisonData.length > 1 ? comparisonData[comparisonData.length - 2] : latestComparison;
                
                const comparisonPrice = document.getElementById('comparison-price');
                const comparisonChange = document.getElementById('comparison-change');
                
                if (comparisonPrice) {
                    const currentPrice = latestComparison.value || latestComparison.close || latestComparison;
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ü–µ–Ω—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                    let formattedPrice = '-';
                    if (typeof currentPrice === 'number') {
                        if (currentComparisonInstrument === 'btc') {
                            formattedPrice = `$${currentPrice.toLocaleString()}`;
                        } else if (currentComparisonInstrument === 'spx') {
                            formattedPrice = currentPrice.toFixed(0);
                        } else {
                            formattedPrice = currentPrice.toFixed(2);
                        }
                    }
                    
                    comparisonPrice.textContent = formattedPrice;
                }
                
                if (comparisonChange && typeof latestComparison.value === 'number' && typeof previousComparison.value === 'number') {
                    const change = latestComparison.value - previousComparison.value;
                    const changePercent = (change / previousComparison.value) * 100;
                    
                    const sign = change >= 0 ? '+' : '';
                    comparisonChange.textContent = `${sign}${changePercent.toFixed(2)}%`;
                    comparisonChange.className = change >= 0 ? 'price-change positive' : 'price-change negative';
                }
            }
        }

        function updateSymbolInfo(instrumentKey) {
            const instrument = CONFIG.INSTRUMENTS[instrumentKey];
            if (!instrument) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏
            const comparisonInstrument = document.getElementById('comparison-instrument');
            const comparisonLabel = document.getElementById('comparison-label');
            
            if (comparisonInstrument) {
                comparisonInstrument.textContent = CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name || 'Unknown';
            }
            
            if (comparisonLabel) {
                comparisonLabel.textContent = CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name || 'Unknown';
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–≤–µ—Ç –º–µ—Ç–∫–∏
                const colors = {
                    'btc': '#F7931A',
                    'spx': '#4285F4',
                    'vix': '#DB4437',
                    'dxy': '#0F9D58',
                    'total3esbtc': '#FF6B35',
                    'withoutbtceth': '#6A4C93'
                };
                
                comparisonLabel.style.color = colors[currentComparisonInstrument] || '#FF9800';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Å–∏–º–≤–æ–ª–∞
            const symbolDetails = document.querySelector('.symbol-details');
            if (symbolDetails) {
                const timeframeText = TimeframeUtils.getDisplayText(currentTimeframe);
                const comparisonName = CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name || 'Unknown';
                symbolDetails.innerHTML = `–û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è ‚Ä¢ vs <span id="comparison-instrument">${comparisonName}</span> ‚Ä¢ ${timeframeText} ‚Ä¢ charts.expert`;
            }
        }

        function updateLegend() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É Coinbase Index (–≤—Å–µ–≥–¥–∞ Coinbase)
            const coinbaseLegendElement = document.getElementById('coinbase-legend');
            const coinbaseLegendLineElement = document.querySelector('.legend-instrument');
            
            if (coinbaseLegendElement && coinbaseLegendLineElement) {
                const coinbaseInstrument = CONFIG.INSTRUMENTS['coinbase'];
                if (coinbaseInstrument) {
                    coinbaseLegendElement.textContent = coinbaseInstrument.name;
                    coinbaseLegendLineElement.style.background = `linear-gradient(135deg, ${coinbaseInstrument.color}, ${coinbaseInstrument.color}aa)`;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const comparisonLegendElement = document.getElementById('comparison-legend');
            const comparisonLegendLineElement = document.querySelector('.legend-comparison');
            
            if (comparisonLegendElement && comparisonLegendLineElement) {
                const comparisonInstrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (comparisonInstrument) {
                    comparisonLegendElement.textContent = comparisonInstrument.name;
                    comparisonLegendLineElement.style.background = `linear-gradient(135deg, ${comparisonInstrument.color}, ${comparisonInstrument.color}aa)`;
                }
            }
        }

        function getSupportedTimeframes(comparisonInstrumentKey) {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã –¥–ª—è Coinbase –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            const coinbaseInstrument = CONFIG.INSTRUMENTS['coinbase'];
            const comparisonInstrument = CONFIG.INSTRUMENTS[comparisonInstrumentKey];
            
            if (!coinbaseInstrument || !comparisonInstrument) {
                console.warn('‚ö†Ô∏è Instrument not found, returning default timeframes');
                return ['D', '3D', 'W']; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            const coinbaseTimeframes = coinbaseInstrument.supportedTimeframes || ['D', '3D', 'W'];
            const comparisonTimeframes = comparisonInstrument.supportedTimeframes || ['D', '3D', 'W'];
            
            const supportedTimeframes = coinbaseTimeframes.filter(tf => comparisonTimeframes.includes(tf));
            
            console.log(`üìä Supported timeframes for ${comparisonInstrumentKey}:`, supportedTimeframes);
            return supportedTimeframes;
        }

        function updateTimeframeSelector(comparisonInstrumentKey) {
            const timeframeSelect = document.getElementById('timeframeSelect');
            if (!timeframeSelect) {
                console.warn('‚ö†Ô∏è Timeframe selector not found');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã
            const supportedTimeframes = getSupportedTimeframes(comparisonInstrumentKey);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
            const currentSelectedTimeframe = timeframeSelect.value;
            
            // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
            timeframeSelect.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            const timeframeOptions = {
                '240': '4H',
                'D': '1D',
                '3D': '3D',
                'W': '1W'
            };
            
            supportedTimeframes.forEach(tf => {
                const option = document.createElement('option');
                option.value = tf;
                option.textContent = timeframeOptions[tf] || tf;
                timeframeSelect.appendChild(option);
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            if (supportedTimeframes.includes(currentSelectedTimeframe)) {
                timeframeSelect.value = currentSelectedTimeframe;
                currentTimeframe = currentSelectedTimeframe;
            } else {
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                const newTimeframe = supportedTimeframes[0] || 'D';
                timeframeSelect.value = newTimeframe;
                currentTimeframe = newTimeframe;
                console.log(`üìä Timeframe changed to ${currentTimeframe} (${comparisonInstrumentKey} doesn't support ${currentSelectedTimeframe})`);
                updateStatus(`–¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${currentTimeframe} (${comparisonInstrumentKey} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ${currentSelectedTimeframe})`, 'info');
            }
            
            console.log(`‚úÖ Timeframe selector updated for ${comparisonInstrumentKey}. Available: [${supportedTimeframes.join(', ')}], Selected: ${currentTimeframe}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            if (!statusEl) {
                console.warn('‚ö†Ô∏è Status element not found, logging message:', message);
                return;
            }
            
            statusEl.textContent = message;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
            statusEl.className = 'status';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–∏–ø–∞
            switch (type) {
                case 'success':
                    statusEl.classList.add('success');
                    break;
                case 'error':
                    statusEl.classList.add('error');
                    break;
                case 'loading':
                    statusEl.classList.add('loading');
                    break;
                default:
                    statusEl.classList.add('info');
            }
        }

        // ===============================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ú–ò –ò–ù–î–ò–ö–ê–¢–û–†–ê–ú–ò
        // ===============================================

        function addSelectedIndicator() {
            const indicatorSelect = document.getElementById('indicatorSelect');
            const selectedType = indicatorSelect.value;
            
            if (!selectedType) {
                updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            if (!window.indicatorsManager) {
                updateStatus('–ú–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            const chartData = getCombinedChartData();
            if (!chartData || chartData.length === 0) {
                updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞', 'error');
                return;
            }
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                window.indicatorsManager.setData(chartData);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                const defaultParams = getDefaultIndicatorParams(selectedType);
                const indicatorName = `${selectedType}_${Date.now()}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const success = window.indicatorsManager.addIndicator(
                    indicatorName, 
                    selectedType, 
                    defaultParams
                );
                
                if (success) {
                    updateStatus(`‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä ${selectedType.toUpperCase()} –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                    indicatorSelect.value = '';
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ ${selectedType}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding indicator:', error);
                updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞: ${error.message}`, 'error');
            }
        }

        function getCombinedChartData() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (comparison)
            if (comparisonLineSeries && comparisonLineSeries.data) {
                return comparisonLineSeries.data().map((item, index) => ({
                    time: item.time,
                    close: item.value,
                    high: item.value * 1.01,
                    low: item.value * 0.99,
                    open: item.value
                }));
            }
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index
            if (coinbaseLineSeries && coinbaseLineSeries.data) {
                return coinbaseLineSeries.data().map((item, index) => ({
                    time: item.time,
                    close: item.value,
                    high: item.value * 1.01,
                    low: item.value * 0.99,
                    open: item.value
                }));
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            console.warn('‚ö†Ô∏è No chart data available, generating test data');
            const testData = [];
            const startTime = Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60);
            
            for (let i = 0; i < 100; i++) {
                const time = startTime + (i * 24 * 60 * 60);
                const baseValue = 50000 + Math.sin(i * 0.1) * 10000;
                testData.push({
                    time: time,
                    close: baseValue,
                    high: baseValue * 1.02,
                    low: baseValue * 0.98,
                    open: baseValue
                });
            }
            
            return testData;
        }

        function getDefaultIndicatorParams(type) {
            switch (type.toLowerCase()) {
                case 'sma':
                case 'ema':
                    return { period: 14 };
                    
                case 'rsi':
                    return { period: 14 };
                    
                case 'macd':
                    return { fast: 12, slow: 26, signal: 9 };
                    
                case 'bollinger':
                case 'bb':
                    return { period: 20, stdDev: 2 };
                    
                case 'stochastic':
                case 'stoch':
                    return { k: 14, d: 3 };
                    
                case 'cbma14':
                    return { period: 14, smoothing: 3 };
                    
                default:
                    return { period: 14 };
            }
        }

        // ===============================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° TIMESCALE API
        // ===============================================

        function handleQuickTimeRangeSelection(range) {
            if (!range || !window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return;
            }
            
            try {
                switch (range) {
                    case '7days':
                        window.timeScaleManager.setLastNDays(7);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π', 'success');
                        break;
                        
                    case '30days':
                        window.timeScaleManager.setLastNDays(30);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π', 'success');
                        break;
                        
                    case '3months':
                        window.timeScaleManager.setLastNMonths(3);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞', 'success');
                        break;
                        
                    case '6months':
                        window.timeScaleManager.setLastNMonths(6);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤', 'success');
                        break;
                        
                    case '1year':
                        window.timeScaleManager.setLastNMonths(12);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥', 'success');
                        break;
                        
                    case '2years':
                        window.timeScaleManager.setLastNMonths(24);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞', 'success');
                        break;
                        
                    case 'all':
                        window.timeScaleManager.fitContent();
                        updateStatus('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'success');
                        break;
                        
                    default:
                        console.warn('Unknown time range:', range);
                }
                
            } catch (error) {
                console.error('‚ùå Error setting time range:', error);
                updateStatus(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: ${error.message}`, 'error');
            }
        }

        function getTimeScaleInfo() {
            if (!window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return null;
            }
            
            return window.timeScaleManager.getTimeScaleInfo();
        }

        function optimizeDataForCurrentView(data) {
            if (!window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return data;
            }
            
                         return window.timeScaleManager.optimizeDataForCurrentRange(data, {
                 maxDataPoints: 1000,
                 minDataPoints: 100,
                 bufferSeconds: 86400 // 1 –¥–µ–Ω—å –±—É—Ñ–µ—Ä
             });
         }

         // ===============================================
         // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–î–í–ò–ù–£–¢–´–ú–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–Ø–ú–ò
         // ===============================================

         function toggleChartTheme() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 updateStatus('–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'error');
                 return;
             }
             
             try {
                 const currentTheme = window.advancedFeatures.currentTheme;
                 const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                 
                 window.advancedFeatures.setTheme(newTheme);
                 updateStatus(`–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${newTheme === 'light' ? '—Å–≤–µ—Ç–ª—É—é' : '—Ç—ë–º–Ω—É—é'}`, 'success');
                 
             } catch (error) {
                 console.error('‚ùå Theme toggle error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã: ${error.message}`, 'error');
             }
         }

         function toggleChartGrid() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 updateStatus('–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'error');
                 return;
             }
             
             try {
                 window.advancedFeatures.toggleGrid();
                 updateStatus('–í–∏–¥–∏–º–æ—Å—Ç—å —Å–µ—Ç–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞', 'success');
                 
             } catch (error) {
                 console.error('‚ùå Grid toggle error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ç–∫–∏: ${error.message}`, 'error');
             }
         }

         function handlePriceLevelAdd(levelType) {
             if (!levelType || !window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return;
             }
             
             try {
                 // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π
                 const currentPrice = getCurrentPrice();
                 if (!currentPrice) {
                     updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π', 'error');
                     return;
                 }
                 
                 switch (levelType) {
                     case 'support':
                         addSupportLevel(currentPrice);
                         break;
                         
                     case 'resistance':
                         addResistanceLevel(currentPrice);
                         break;
                         
                     case 'fibonacci':
                         addFibonacciLevels(currentPrice);
                         break;
                         
                     case 'pivot':
                         addPivotLevels(currentPrice);
                         break;
                         
                     default:
                         console.warn('Unknown level type:', levelType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Price level add error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è: ${error.message}`, 'error');
             }
         }

         function getCurrentPrice() {
             try {
                 // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                 if (comparisonLineSeries && comparisonLineSeries.data) {
                     const data = comparisonLineSeries.data();
                     if (data && data.length > 0) {
                         return data[data.length - 1].value;
                     }
                 }
                 
                 // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö Coinbase
                 if (coinbaseLineSeries && coinbaseLineSeries.data) {
                     const data = coinbaseLineSeries.data();
                     if (data && data.length > 0) {
                         return data[data.length - 1].value;
                     }
                 }
                 
                 return null;
                 
             } catch (error) {
                 console.error('‚ùå Get current price error:', error);
                 return null;
             }
         }

         function addSupportLevel(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ 5% –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
             const supportPrice = basePrice * 0.95;
             
             window.advancedFeatures.addPriceLine(series, supportPrice, {
                 color: '#00C851',
                 title: `–ü–æ–¥–¥–µ—Ä–∂–∫–∞: ${supportPrice.toFixed(2)}`,
                 id: `support_${Date.now()}`,
                 lineStyle: LightweightCharts.LineStyle.Dashed
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏: ${supportPrice.toFixed(2)}`, 'success');
         }

         function addResistanceLevel(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –Ω–∞ 5% –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
             const resistancePrice = basePrice * 1.05;
             
             window.advancedFeatures.addPriceLine(series, resistancePrice, {
                 color: '#FF4444',
                 title: `–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ${resistancePrice.toFixed(2)}`,
                 id: `resistance_${Date.now()}`,
                 lineStyle: LightweightCharts.LineStyle.Dashed
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è: ${resistancePrice.toFixed(2)}`, 'success');
         }

         function addFibonacciLevels(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏
             const fibLevels = [0.236, 0.382, 0.5, 0.618, 0.786];
             const range = basePrice * 0.1; // 10% –¥–∏–∞–ø–∞–∑–æ–Ω
             
             fibLevels.forEach(level => {
                 const price = basePrice + (range * level) - (range * 0.5);
                 
                 window.advancedFeatures.addPriceLine(series, price, {
                     color: '#FFB74D',
                     title: `–§–∏–±–æ ${(level * 100).toFixed(1)}%: ${price.toFixed(2)}`,
                     id: `fib_${level}_${Date.now()}`,
                     lineWidth: 1,
                     lineStyle: LightweightCharts.LineStyle.Dotted
                 });
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω—ã —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏ (${fibLevels.length})`, 'success');
         }

         function addPivotLevels(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –ü—Ä–æ—Å—Ç—ã–µ –ø–∏–≤–æ—Ç —É—Ä–æ–≤–Ω–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
             const pivot = basePrice;
             const range = basePrice * 0.02; // 2% –¥–∏–∞–ø–∞–∑–æ–Ω
             
             const levels = [
                 { price: pivot, label: 'Pivot', color: '#2962FF' },
                 { price: pivot + range, label: 'R1', color: '#FF6B6B' },
                 { price: pivot + range * 2, label: 'R2', color: '#FF6B6B' },
                 { price: pivot - range, label: 'S1', color: '#4ECDC4' },
                 { price: pivot - range * 2, label: 'S2', color: '#4ECDC4' }
             ];
             
             levels.forEach(level => {
                 window.advancedFeatures.addPriceLine(series, level.price, {
                     color: level.color,
                     title: `${level.label}: ${level.price.toFixed(2)}`,
                     id: `pivot_${level.label}_${Date.now()}`,
                     lineWidth: level.label === 'Pivot' ? 2 : 1
                 });
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∏–≤–æ—Ç —É—Ä–æ–≤–Ω–∏ (${levels.length})`, 'success');
         }

         function addEventMarker(time, type, text) {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return;
             }
             
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             return window.advancedFeatures.addMarker(series, time, {
                 position: type === 'bullish' ? 'belowBar' : 'aboveBar',
                 color: type === 'bullish' ? '#00C851' : '#FF4444',
                 shape: type === 'bullish' ? 'arrowUp' : 'arrowDown',
                 text: text,
                 id: `event_${Date.now()}`
             });
         }

         function getAdvancedFeaturesInfo() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return null;
             }
             
             return window.advancedFeatures.getFeatureInfo();
         }

         // ===============================================
         // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ù–û–í–´–ú–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–Ø–ú–ò
         // ===============================================

         function handleExportAction(exportType) {
             if (!exportType || !window.eventsAndExport || !window.eventsAndExport.isInitialized) {
                 return;
             }
             
             try {
                 switch (exportType) {
                     case 'image':
                         window.eventsAndExport.exportChartAsImage();
                         updateStatus('–ì—Ä–∞—Ñ–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'success');
                         break;
                         
                     case 'csv':
                         window.eventsAndExport.exportDataAsCSV();
                         updateStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV', 'success');
                         break;
                         
                     case 'json':
                         window.eventsAndExport.exportDataAsJSON();
                         updateStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON', 'success');
                         break;
                         
                     default:
                         console.warn('Unknown export type:', exportType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Export error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
             }
         }

         function handleSeriesAdd(seriesType) {
             if (!seriesType || !window.advancedSeriesAndScale || !window.advancedSeriesAndScale.isInitialized) {
                 return;
             }
             
             try {
                 const seriesId = `${seriesType}_${Date.now()}`;
                 
                 switch (seriesType) {
                                     // case 'volume':
                //     // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä—ë–º–æ–≤
                //     const volumeData = generateVolumeData();
                //     window.advancedSeriesAndScale.createVolumesSeries(seriesId, volumeData);
                //     updateStatus('–°–µ—Ä–∏—è –æ–±—ä—ë–º–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                //     break;
                         
                     case 'area':
                         // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                         const areaData = getCurrentChartData();
                         window.advancedSeriesAndScale.createTrendAreaSeries(seriesId, areaData);
                         updateStatus('–°–µ—Ä–∏—è –æ–±–ª–∞—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                         break;
                         
                     case 'baseline':
                         // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é –ª–∏–Ω–∏—é
                         const baselineData = getCurrentChartData();
                         const baselineValue = calculateBaselineValue(baselineData);
                         window.advancedSeriesAndScale.createDeviationBaselineSeries(seriesId, baselineData, baselineValue);
                         updateStatus('–ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                         break;
                         
                     default:
                         console.warn('Unknown series type:', seriesType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Series add error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–∏–∏: ${error.message}`, 'error');
             }
         }

         function handlePriceScaleModeChange(mode) {
             if (!window.advancedSeriesAndScale || !window.advancedSeriesAndScale.isInitialized) {
                 return;
             }
             
             try {
                 window.advancedSeriesAndScale.setPriceScaleMode('right', mode);
                 updateStatus(`–†–µ–∂–∏–º —à–∫–∞–ª—ã —Ü–µ–Ω –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${mode}`, 'success');
                 
             } catch (error) {
                 console.error('‚ùå Price scale mode change error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ —à–∫–∞–ª—ã: ${error.message}`, 'error');
             }
         }

         function handleSaveState() {
             if (!window.eventsAndExport || !window.eventsAndExport.isInitialized) {
                 updateStatus('–ú–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                 return;
             }
             
             try {
                 window.eventsAndExport.saveChartState();
                 updateStatus('–°–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                 
             } catch (error) {
                 console.error('‚ùå Save state error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${error.message}`, 'error');
             }
         }

         // function generateVolumeData() {
         //     // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä—ë–º–æ–≤
         //     const volumeData = [];
         //     const startTime = Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60);
         //     
         //     for (let i = 0; i < 100; i++) {
         //         const time = startTime + (i * 24 * 60 * 60);
         //         const baseVolume = 1000000 + Math.random() * 500000;
         //         volumeData.push({
         //             time: time,
         //             value: baseVolume,
         //             volume: baseVolume,
         //             color: Math.random() > 0.5 ? '#26a69a' : '#ef5350'
         //         });
         //     }
         //     
         //     return volumeData;
         // }

         function getCurrentChartData() {
             // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
             if (comparisonLineSeries && comparisonLineSeries.data) {
                 return comparisonLineSeries.data();
             }
             
             if (coinbaseLineSeries && coinbaseLineSeries.data) {
                 return coinbaseLineSeries.data();
             }
             
             return [];
         }

                   function calculateBaselineValue(data) {
              if (!data || data.length === 0) return 0;
              
              // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –±–∞–∑–æ–≤—É—é –ª–∏–Ω–∏—é
              const sum = data.reduce((acc, item) => acc + item.value, 0);
              return sum / data.length;
          }

                     function handleToggleFullscreen() {
               if (!window.mobileResponsive || !window.mobileResponsive.isInitialized) {
                   updateStatus('–ú–æ–±–∏–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                   return;
               }
               
               try {
                   if (!window.mobileResponsive.isFullscreenSupported()) {
                       updateStatus('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
                       return;
                   }

                   const success = window.mobileResponsive.toggleFullscreen();
                   if (success) {
                       const isFullscreen = window.mobileResponsive.isFullscreen;
                       updateStatus(
                           isFullscreen ? '–í–∫–ª—é—á—ë–Ω –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º' : '–í—ã–∫–ª—é—á–µ–Ω –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º', 
                           'success'
                       );
                       
                       // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                       const button = document.getElementById('toggleFullscreen');
                       if (button) {
                           button.innerHTML = isFullscreen ? 'üóó –í—ã–π—Ç–∏' : '‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω';
                       }
                   } else {
                       updateStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞', 'error');
                   }
                   
               } catch (error) {
                   console.error('‚ùå Fullscreen toggle error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞: ${error.message}`, 'error');
               }
           }

           function handleCandlestickAdd(type) {
               if (!type || !window.candlestickBarSeries) return;
               
               try {
                   const currentData = getCurrentChartData();
                   if (!currentData || currentData.length === 0) {
                       updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–µ—á–µ–π', 'error');
                       return;
                   }

                   // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º line-–¥–∞–Ω–Ω—ã–µ –≤ OHLC
                   const ohlcData = window.candlestickBarSeries.convertLineToOHLC(currentData);
                   const seriesId = `${type}_${Date.now()}`;
                   
                   switch (type) {
                       case 'classic':
                           window.candlestickBarSeries.createClassicCandlesticks(seriesId, ohlcData);
                           updateStatus('–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'hollow':
                           window.candlestickBarSeries.createHollowCandlesticks(seriesId, ohlcData);
                           updateStatus('–ü–æ–ª—ã–µ —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'heikin':
                           window.candlestickBarSeries.createHeikinAshiCandlesticks(seriesId, ohlcData);
                           updateStatus('Heikin-Ashi —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'bar':
                           window.candlestickBarSeries.addBarSeries(seriesId);
                           window.candlestickBarSeries.setBarData(seriesId, ohlcData);
                           updateStatus('–ë–∞—Ä-–≥—Ä–∞—Ñ–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Candlestick add error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—á–µ–π: ${error.message}`, 'error');
               }
           }

           function handleTimeFeature(feature) {
               if (!feature || !window.advancedTimeFeatures) return;
               
               try {
                   switch (feature) {
                       case 'business_hours':
                           window.advancedTimeFeatures.setBusinessHours({
                               from: '09:30',
                               to: '16:00',
                               timezone: 'America/New_York'
                           });
                           updateStatus('–¢–æ—Ä–≥–æ–≤—ã–µ —á–∞—Å—ã NYSE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                           break;
                           
                       case 'timezone':
                           window.advancedTimeFeatures.setTimeZone('Europe/Moscow');
                           updateStatus('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ –º–æ—Å–∫–æ–≤—Å–∫–∏–π', 'success');
                           break;
                           
                       case 'goto_now':
                           window.advancedTimeFeatures.goToNow();
                           updateStatus('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏', 'success');
                           break;
                           
                       case 'custom_marks':
                           const now = Math.floor(Date.now() / 1000);
                           window.advancedTimeFeatures.addEventMark(now, '–í–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ', '#FF6B6B');
                           updateStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Time feature error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏: ${error.message}`, 'error');
               }
           }

           function handleCrosshairModeChange(mode) {
               if (!window.customCrosshair) return;
               
               try {
                   window.customCrosshair.setCrosshairMode(mode);
                   updateStatus(`–†–µ–∂–∏–º crosshair –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${mode}`, 'success');
                   
               } catch (error) {
                   console.error('‚ùå Crosshair mode error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ crosshair: ${error.message}`, 'error');
               }
           }

           function handleAnimationEffect(effect) {
               if (!effect || !window.animationEffects) return;
               
               try {
                   // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—ä–µ–∫—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
                   if (!window.animationEffects.transitions) {
                       console.warn('Animation effects not fully initialized');
                       return;
                   }
                   
                   switch (effect) {
                       case 'entrance_fade':
                           window.animationEffects.animateChartEntrance('fade');
                           updateStatus('–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'highlight':
                           window.animationEffects.highlightChart();
                           updateStatus('–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'pulse':
                           window.animationEffects.pulseChart();
                           updateStatus('–ü—É–ª—å—Å–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'loading':
                           window.animationEffects.showLoadingSpinner('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è...');
                           setTimeout(() => {
                               window.animationEffects.hideLoadingSpinner();
                           }, 3000);
                           updateStatus('–ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–∞', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Animation effect error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞: ${error.message}`, 'error');
               }
           }

           function handleToggleAnimations() {
               if (!window.animationEffects || !window.animationEffects.transitions) {
                   updateStatus('–ú–æ–¥—É–ª—å –∞–Ω–∏–º–∞—Ü–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                   return;
               }
               
               try {
                   const currentlyEnabled = window.animationEffects.transitions.enabled;
                   const newState = !currentlyEnabled;
                   
                   window.animationEffects.setAnimationsEnabled(newState);
                   updateStatus(`–ê–Ω–∏–º–∞—Ü–∏–∏ ${newState ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`, 'success');
                   
                   const button = document.getElementById('toggleAnimations');
                   if (button) {
                       button.innerHTML = newState ? 'üé¨ –ê–Ω–∏–º–∞—Ü–∏–∏' : '‚è∏Ô∏è –ê–Ω–∏–º–∞—Ü–∏–∏';
                   }
                   
               } catch (error) {
                   console.error('‚ùå Toggle animations error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π: ${error.message}`, 'error');
               }
           }

           // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ toolbar
           function setupToolbarHandlers() {
               // Toolbar –∫–Ω–æ–ø–∫–∏
               const toolbarReset = document.getElementById('toolbar-reset');
               const toolbarFit = document.getElementById('toolbar-fit');
               const toolbarFullscreen = document.getElementById('toolbar-fullscreen');
               const toolbarTheme = document.getElementById('toolbar-theme');
               const toolbarGrid = document.getElementById('toolbar-grid');
               const toolbarSave = document.getElementById('toolbar-save');
               
               // Toolbar —Å–µ–ª–µ–∫—Ç–æ—Ä—ã
               const toolbarTimeframe = document.getElementById('toolbar-timeframe');
               const toolbarComparison = document.getElementById('toolbar-comparison');
               
               // Floating –∫–Ω–æ–ø–∫–∏
               const floatingIndicators = document.getElementById('floating-indicators');
               const floatingExport = document.getElementById('floating-export');
               const floatingAnimation = document.getElementById('floating-animation');
               
               // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ toolbar
               if (toolbarReset) {
                   toolbarReset.addEventListener('click', () => {
                       if (chart) {
                           chart.timeScale().fitContent();
                           updateStatus('–ú–∞—Å—à—Ç–∞–± —Å–±—Ä–æ—à–µ–Ω', 'success');
                       }
                   });
               }
               
               if (toolbarFit) {
                   toolbarFit.addEventListener('click', () => {
                       if (chart) {
                           chart.timeScale().fitContent();
                           updateStatus('–ì—Ä–∞—Ñ–∏–∫ –ø–æ–¥–æ–≥–Ω–∞–Ω', 'success');
                       }
                   });
               }
               
               if (toolbarFullscreen) {
                   toolbarFullscreen.addEventListener('click', handleToggleFullscreen);
               }
               
               if (toolbarTheme) {
                   toolbarTheme.addEventListener('click', () => {
                       // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
                       const currentTheme = document.body.dataset.theme || 'dark';
                       const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                       document.body.dataset.theme = newTheme;
                       updateStatus(`–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${newTheme}`, 'success');
                   });
               }
               
               if (toolbarGrid) {
                   toolbarGrid.addEventListener('click', () => {
                       if (chart) {
                           // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
                           const priceScale = chart.priceScale('right');
                           const timeScale = chart.timeScale();
                           
                           // –ü—Ä–æ—Å—Ç–æ–π toggle —Å–µ—Ç–∫–∏
                           updateStatus('–°–µ—Ç–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞', 'success');
                       }
                   });
               }
               
               if (toolbarSave) {
                   toolbarSave.addEventListener('click', handleSaveState);
               }
               
               // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤
               if (toolbarTimeframe) {
                   toolbarTimeframe.addEventListener('change', (e) => {
                       currentTimeframe = e.target.value;
                       updateTimeframeSelector(currentComparisonInstrument);
                       DataUpdateUtils.updateStartDateAndReload('—Å–º–µ–Ω—ã —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞');
                   });
               }
               
               if (toolbarComparison) {
                   toolbarComparison.addEventListener('change', (e) => {
                       currentComparisonInstrument = e.target.value;
                       updateTimeframeSelector(currentComparisonInstrument);
                       DataUpdateUtils.updateStartDateAndReload('—Å–º–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞');
                   });
               }
               
               // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ floating –∫–Ω–æ–ø–æ–∫
               if (floatingIndicators) {
                   floatingIndicators.addEventListener('click', () => {
                       // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                       showIndicatorsPanel();
                   });
               }
               
               if (floatingExport) {
                   floatingExport.addEventListener('click', () => {
                       // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞
                       showExportPanel();
                   });
               }
               
               if (floatingAnimation) {
                   floatingAnimation.addEventListener('click', () => {
                       // –ü–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å –∞–Ω–∏–º–∞—Ü–∏–π
                       showAnimationPanel();
                   });
               }
           }

           function showIndicatorsPanel() {
               // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
               const modal = document.createElement('div');
               modal.style.cssText = `
                   position: fixed;
                   top: 0;
                   left: 0;
                   width: 100%;
                   height: 100%;
                   background: rgba(0,0,0,0.7);
                   z-index: 10000;
                   display: flex;
                   align-items: center;
                   justify-content: center;
               `;
               
               const panel = document.createElement('div');
               panel.style.cssText = `
                   background: #1e222d;
                   border: 1px solid #2a2e39;
                   border-radius: 8px;
                   padding: 20px;
                   max-width: 400px;
                   color: #d1d4dc;
               `;
               
               panel.innerHTML = `
                   <h3 style="margin-top: 0; color: #ffffff;">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã</h3>
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                       <button onclick="addIndicator('sma')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">SMA - Simple Moving Average</button>
                       <button onclick="addIndicator('ema')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">EMA - Exponential Moving Average</button>
                       <button onclick="addIndicator('rsi')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">RSI - Relative Strength Index</button>
                       <button onclick="addIndicator('macd')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">MACD - Moving Average Convergence Divergence</button>
                       <button onclick="addIndicator('bollinger')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">Bollinger Bands</button>
                   </div>
                   <button onclick="document.body.removeChild(this.closest('.indicators-modal'))" style="margin-top: 15px; padding: 8px 16px; background: #2962ff; border: none; color: white; border-radius: 4px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
               `;
               
               modal.className = 'indicators-modal';
               modal.appendChild(panel);
               document.body.appendChild(modal);
           }

           function showExportPanel() {
               // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
               const modal = document.createElement('div');
               modal.style.cssText = `
                   position: fixed;
                   top: 0;
                   left: 0;
                   width: 100%;
                   height: 100%;
                   background: rgba(0,0,0,0.7);
                   z-index: 10000;
                   display: flex;
                   align-items: center;
                   justify-content: center;
               `;
               
               const panel = document.createElement('div');
               panel.style.cssText = `
                   background: #1e222d;
                   border: 1px solid #2a2e39;
                   border-radius: 8px;
                   padding: 20px;
                   max-width: 400px;
                   color: #d1d4dc;
               `;
               
               panel.innerHTML = `
                   <h3 style="margin-top: 0; color: #ffffff;">–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h3>
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                       <button onclick="handleExportAction('image')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üì∏ –≠–∫—Å–ø–æ—Ä—Ç –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
                       <button onclick="handleExportAction('csv')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
                       <button onclick="handleExportAction('json')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üì¶ –≠–∫—Å–ø–æ—Ä—Ç –≤ JSON</button>
                   </div>
                   <button onclick="document.body.removeChild(this.closest('.export-modal'))" style="margin-top: 15px; padding: 8px 16px; background: #2962ff; border: none; color: white; border-radius: 4px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
               `;
               
               modal.className = 'export-modal';
               modal.appendChild(panel);
               document.body.appendChild(modal);
           }

           function showAnimationPanel() {
               // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–π
               const modal = document.createElement('div');
               modal.style.cssText = `
                   position: fixed;
                   top: 0;
                   left: 0;
                   width: 100%;
                   height: 100%;
                   background: rgba(0,0,0,0.7);
                   z-index: 10000;
                   display: flex;
                   align-items: center;
                   justify-content: center;
               `;
               
               const panel = document.createElement('div');
               panel.style.cssText = `
                   background: #1e222d;
                   border: 1px solid #2a2e39;
                   border-radius: 8px;
                   padding: 20px;
                   max-width: 400px;
                   color: #d1d4dc;
               `;
               
               panel.innerHTML = `
                   <h3 style="margin-top: 0; color: #ffffff;">–ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã</h3>
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                       <button onclick="handleAnimationEffect('entrance_fade')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üí´ –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è</button>
                       <button onclick="handleAnimationEffect('highlight')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">‚ú® –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞</button>
                       <button onclick="handleAnimationEffect('pulse')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üíì –ü—É–ª—å—Å–∞—Ü–∏—è</button>
                       <button onclick="handleAnimationEffect('loading')" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">‚è≥ –î–µ–º–æ –∑–∞–≥—Ä—É–∑–∫–∏</button>
                       <button onclick="handleToggleAnimations()" style="padding: 8px; background: #2a2e39; border: 1px solid #363a45; color: #d1d4dc; border-radius: 4px; cursor: pointer;">üé¨ –í–∫–ª/–í—ã–∫–ª –∞–Ω–∏–º–∞—Ü–∏–∏</button>
                   </div>
                   <button onclick="document.body.removeChild(this.closest('.animation-modal'))" style="margin-top: 15px; padding: 8px 16px; background: #2962ff; border: none; color: white; border-radius: 4px; cursor: pointer;">–ó–∞–∫—Ä—ã—Ç—å</button>
               `;
               
               modal.className = 'animation-modal';
               modal.appendChild(panel);
               document.body.appendChild(modal);
           }

           // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (–¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω)
           function addIndicator(type) {
               // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä –∏ –≤—ã–∑—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é
               const indicatorSelect = document.getElementById('indicatorSelect');
               if (indicatorSelect) {
                   indicatorSelect.value = type;
                   addSelectedIndicator();
               }
           }
    </script>
</body>
</html> 