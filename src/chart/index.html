<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBMA Chart - Simplified</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="config.js"></script>
    <script src="optimized_utils.js"></script>
    <style>
        /* ========= –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ========= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: #0D1421;
            color: #B2B5BE;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* ========= –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ========= */
        .top-panel {
            height: 48px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .symbol-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .symbol-details {
            font-size: 11px;
            color: #787B86;
        }

        .price-data {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .price-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .price-label {
            font-size: 10px;
            font-weight: 500;
        }

        .price-value {
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .price-change {
            font-size: 12px;
            font-weight: 500;
        }

        .price-change.positive {
            color: #00C851;
        }

        .price-change.negative {
            color: #FF4444;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –¢–ê–ô–ú–§–†–ï–ô–ú–û–í ========= */
        .toolbar-panel {
            height: 40px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            color: #B2B5BE;
            background: transparent;
            border: none;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }

        .toolbar-btn.active {
            background: #2962FF;
            color: #FFFFFF;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: #2A2E39;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ========= */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2A2E39;
            border-radius: 6px;
            font-size: 12px;
        }

        .control-group label {
            color: #B2B5BE;
            font-weight: 500;
            white-space: nowrap;
        }

        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2A2E39;
            border-radius: 4px;
            padding: 4px 8px;
            color: #FFFFFF;
            font-size: 12px;
            min-width: 80px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962FF;
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.3);
        }

        .control-btn {
            background: #2962FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .control-btn:hover {
            background: #1E53E5;
        }

        .date-input {
            width: 140px !important;
        }

        /* ========= –û–ë–õ–ê–°–¢–¨ –ì–†–ê–§–ò–ö–ê ========= */
        .chart-area {
            flex: 1;
            position: relative;
            background: #0D1421;
        }

        .chart-container {
            width: 100%;
            height: 100%;
            background: #0D1421;
        }

        .status {
            position: absolute;
            bottom: 16px;
            left: 16px;
            right: 16px;
            padding: 8px 12px;
            background: rgba(30, 34, 45, 0.9);
            border: 1px solid #2A2E39;
            border-radius: 6px;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .status.success {
            border-color: #00C851;
            color: #00C851;
        }

        .status.error {
            border-color: #FF4444;
            color: #FF4444;
        }

        .status.info {
            border-color: #2962FF;
            color: #2962FF;
        }

        /* ========= –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´ ========= */
        .hidden {
            display: none;
        }

        /* ========= –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ========= */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: space-between;
            }
            
            .top-panel {
                flex-direction: column;
                height: auto;
                padding: 8px 16px;
                gap: 8px;
            }
            
            .price-data {
                justify-content: space-around;
                width: 100%;
            }
        }

        /* ========= –û–°–ù–û–í–´ –°–ö–†–û–õ–õ–ë–ê–†–ê ========= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1E222D;
        }

        ::-webkit-scrollbar-thumb {
            background: #2A2E39;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #363A45;
        }

        select option {
            background: #1E222D;
            color: #FFFFFF;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="symbol-info">
                <div class="symbol-name">Coinbase Index Rank</div>
                <div class="symbol-details">–û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è ‚Ä¢ vs BTC ‚Ä¢ 1W ‚Ä¢ charts.expert</div>
            </div>
            <div class="price-data">
                <div class="price-item">
                    <div class="price-label">Rank</div>
                    <div class="price-value" id="rank-value">-</div>
                </div>
                <div class="price-item">
                    <div class="price-label">BTC</div>
                    <div class="price-value" id="btc-value">-</div>
                    <div class="price-change positive" id="btc-change">+0.00%</div>
                </div>
                <div class="price-item">
                    <div class="price-label">‚ö° Coinbase Index vs:</div>
                    <div class="price-value" id="comparison-symbol">-</div>
                </div>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ -->
        <div class="toolbar-panel">
            <div class="toolbar-group">
                <button class="toolbar-btn" data-timeframe="1m">1m</button>
                <button class="toolbar-btn" data-timeframe="5m">5m</button>
                <button class="toolbar-btn" data-timeframe="15m">15m</button>
                <button class="toolbar-btn" data-timeframe="30m">30m</button>
                <button class="toolbar-btn" data-timeframe="1h">1h</button>
                <button class="toolbar-btn" data-timeframe="4h">4h</button>
                <button class="toolbar-btn" data-timeframe="1D">1D</button>
                <button class="toolbar-btn active" data-timeframe="1W">1W</button>
                <button class="toolbar-btn" data-timeframe="1M">1M</button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls">
            <div class="control-group">
                <label>üîµ Coinbase Index:</label>
                <span style="color: #2962FF; font-weight: 600;">–û—Å–Ω–æ–≤–Ω–∞—è –∫—Ä–∏–≤–∞—è (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑–∞–Ω–∞)</span>
            </div>
            
            <div class="control-group">
                <label>üî¥ –°—Ä–∞–≤–Ω–∏—Ç—å —Å:</label>
                <select id="comparison-select">
                    <option value="btc">BTC</option>
                    <option value="spx">S&P 500</option>
                    <option value="vix">VIX</option>
                    <option value="dxy">DXY</option>
                    <option value="total3esbtc">Total3 - BTC</option>
                    <option value="withoutbtceth">Without BTC/ETH</option>
                </select>
            </div>

            <div class="control-group">
                <label>–¢–∞–π–º—Ñ—Ä–µ–π–º:</label>
                <select id="timeframe-select">
                    <option value="1W">1W</option>
                    <option value="3D">3D</option>
                    <option value="D">D</option>
                </select>
            </div>

            <div class="control-group">
                <label>MA –ø–µ—Ä–∏–æ–¥:</label>
                <select id="ma-period-select">
                    <option value="7">7</option>
                    <option value="14" selected>14</option>
                    <option value="30">30</option>
                </select>
            </div>

            <div class="control-group">
                <label>–°:</label>
                <input type="date" id="date-from" class="date-input">
            </div>

            <div class="control-group">
                <label>–ü–æ:</label>
                <input type="date" id="date-to" class="date-input">
            </div>

            <button class="control-btn" id="update-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="control-btn" id="reset-btn">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="control-btn" id="fullscreen-btn">‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ -->
        <div class="chart-area">
            <div class="chart-container" id="chart-container"></div>
            <div class="status info" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <script>
        console.log('üîß Frontend Configuration:', CONFIG);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let chart = null;
        let coinbaseSeries = null;
        let comparisonSeries = null;
        let currentComparison = 'btc';
        let currentTimeframe = '1W';
        let currentMaPeriod = 14;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        let coinbaseData = [];
        let comparisonData = [];
        let isLoading = false;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ TradingView Lightweight Charts loaded successfully');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            initializeControls();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            initializeChart();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadData();
        });

        function initializeControls() {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('comparison-select').value = currentComparison;
            document.getElementById('timeframe-select').value = currentTimeframe;
            document.getElementById('ma-period-select').value = currentMaPeriod;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('comparison-select').addEventListener('change', function() {
                currentComparison = this.value;
                updateComparisonInfo();
                loadData();
            });

            document.getElementById('timeframe-select').addEventListener('change', function() {
                currentTimeframe = this.value;
                updateTimeframeButtons();
                loadData();
            });

            document.getElementById('ma-period-select').addEventListener('change', function() {
                currentMaPeriod = parseInt(this.value);
                loadData();
            });

            document.getElementById('update-btn').addEventListener('click', loadData);
            document.getElementById('reset-btn').addEventListener('click', resetChart);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const timeframe = this.dataset.timeframe;
                    currentTimeframe = timeframe;
                    updateTimeframeButtons();
                    document.getElementById('timeframe-select').value = timeframe;
                    loadData();
                });
            });

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –¥–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            setDefaultDates();
            updateComparisonInfo();
            updateTimeframeButtons();
        }

        function initializeChart() {
            if (!window.LightweightCharts) {
                console.error('TradingView Lightweight Charts not loaded');
                return;
            }

            const chartContainer = document.getElementById('chart-container');
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: {
                    background: { color: '#0D1421' },
                    textColor: '#B2B5BE',
                },
                grid: {
                    vertLines: { color: '#2A2E39' },
                    horzLines: { color: '#2A2E39' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                rightPriceScale: {
                    borderColor: '#2A2E39',
                    scaleMargins: {
                        top: 0.05,
                        bottom: 0.05,
                    },
                },
                leftPriceScale: {
                    borderColor: '#2A2E39',
                    scaleMargins: {
                        top: 0.05,
                        bottom: 0.05,
                    },
                },
                timeScale: {
                    borderColor: '#2A2E39',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö
            coinbaseSeries = chart.addLineSeries({
                color: '#2962FF',
                lineWidth: 3,
                priceScaleId: 'left',
                title: 'Coinbase MA' + currentMaPeriod,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 6,
                crosshairMarkerBorderColor: '#2962FF',
                crosshairMarkerBackgroundColor: '#2962FF',
            });

            comparisonSeries = chart.addLineSeries({
                color: '#F7931A',
                lineWidth: 2,
                priceScaleId: 'right',
                title: 'BTC',
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 4,
                crosshairMarkerBorderColor: '#F7931A',
                crosshairMarkerBackgroundColor: '#F7931A',
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
            window.addEventListener('resize', function() {
                chart.applyOptions({
                    width: chartContainer.clientWidth,
                    height: chartContainer.clientHeight,
                });
            });

            console.log('‚úÖ Chart initialized successfully');
        }

        function updateComparisonInfo() {
            const instrument = CONFIG.INSTRUMENTS[currentComparison];
            if (instrument) {
                document.getElementById('comparison-symbol').textContent = instrument.name;
                if (comparisonSeries) {
                    comparisonSeries.applyOptions({
                        color: instrument.color,
                        title: instrument.name,
                        crosshairMarkerBorderColor: instrument.color,
                        crosshairMarkerBackgroundColor: instrument.color,
                    });
                }
            }
        }

        function updateTimeframeButtons() {
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.timeframe === currentTimeframe);
            });
        }

        function setDefaultDates() {
            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);

            document.getElementById('date-from').value = oneWeekAgo.toISOString().split('T')[0];
            document.getElementById('date-to').value = today.toISOString().split('T')[0];
        }

        function setStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function loadData() {
            if (isLoading) return;
            isLoading = true;

            try {
                setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ Coinbase –¥–∞–Ω–Ω—ã—Ö
                await loadCoinbaseData();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                await loadComparisonData();
                
                setStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        async function loadCoinbaseData() {
            try {
                const response = await fetch('/data/data.json');
                const data = await response.json();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
                let processedData = [];
                if (data.data && Array.isArray(data.data)) {
                    processedData = data.data.map(item => ({
                        time: Math.floor(new Date(item.date).getTime() / 1000),
                        value: parseFloat(item.rank)
                    }));
                } else {
                    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                    processedData = Object.entries(data).map(([date, values]) => ({
                        time: Math.floor(new Date(date).getTime() / 1000),
                        value: parseFloat(values.Overall || 0)
                    }));
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                processedData.sort((a, b) => a.time - b.time);

                // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ–ª—å–∑—è—â–µ–π —Å—Ä–µ–¥–Ω–µ–π
                const maData = applyMovingAverage(processedData, currentMaPeriod);
                
                coinbaseData = maData;
                if (coinbaseSeries) {
                    coinbaseSeries.setData(maData);
                    coinbaseSeries.applyOptions({
                        title: 'Coinbase MA' + currentMaPeriod,
                    });
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ö–µ–¥–µ—Ä–µ
                if (maData.length > 0) {
                    const latestRank = maData[maData.length - 1].value;
                    document.getElementById('rank-value').textContent = latestRank.toFixed(0);
                }

                console.log(`‚úÖ Coinbase data loaded: ${maData.length} points`);
                
            } catch (error) {
                console.error('Error loading Coinbase data:', error);
                throw error;
            }
        }

        async function loadComparisonData() {
            const instrument = CONFIG.INSTRUMENTS[currentComparison];
            if (!instrument) return;

            try {
                if (instrument.dataSource === 'api') {
                    await loadApiData(instrument);
                } else {
                    await loadFileData(instrument);
                }
            } catch (error) {
                console.error('Error loading comparison data:', error);
                throw error;
            }
        }

        async function loadApiData(instrument) {
            try {
                const response = await fetch(`/api/history?symbol=${instrument.apiSymbol}&resolution=D&from=1&to=${Math.floor(Date.now() / 1000)}`);
                const data = await response.json();
                
                if (data.s === 'ok' && data.t && data.c) {
                    const processedData = data.t.map((time, index) => ({
                        time: time,
                        value: parseFloat(data.c[index])
                    }));

                    comparisonData = processedData;
                    if (comparisonSeries) {
                        comparisonSeries.setData(processedData);
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ö–µ–¥–µ—Ä–µ
                    if (processedData.length > 0) {
                        const latestValue = processedData[processedData.length - 1].value;
                        document.getElementById('btc-value').textContent = '$' + latestValue.toLocaleString();
                    }

                    console.log(`‚úÖ ${instrument.name} data loaded: ${processedData.length} points`);
                } else {
                    throw new Error('Invalid API response');
                }
                
            } catch (error) {
                console.error(`Error loading ${instrument.name} API data:`, error);
                throw error;
            }
        }

        async function loadFileData(instrument) {
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ–∞–π–ª–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            console.log(`üìÑ File data loading for ${instrument.name} not implemented yet`);
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            const testData = [];
            const startTime = Math.floor(Date.now() / 1000) - 7 * 24 * 60 * 60; // 7 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
            
            for (let i = 0; i < 168; i++) { // 168 —á–∞—Å–æ–≤ = 7 –¥–Ω–µ–π
                testData.push({
                    time: startTime + i * 3600,
                    value: Math.random() * 100 + 50
                });
            }

            comparisonData = testData;
            if (comparisonSeries) {
                comparisonSeries.setData(testData);
            }
        }

        function applyMovingAverage(data, period) {
            if (data.length < period) return data;
            
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].value;
                }
                result.push({
                    time: data[i].time,
                    value: sum / period
                });
            }
            return result;
        }

        function resetChart() {
            setDefaultDates();
            currentComparison = 'btc';
            currentTimeframe = '1W';
            currentMaPeriod = 14;
            
            document.getElementById('comparison-select').value = currentComparison;
            document.getElementById('timeframe-select').value = currentTimeframe;
            document.getElementById('ma-period-select').value = currentMaPeriod;
            
            updateComparisonInfo();
            updateTimeframeButtons();
            loadData();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        document.addEventListener('fullscreenchange', function() {
            if (chart) {
                setTimeout(() => {
                    const container = document.getElementById('chart-container');
                    chart.applyOptions({
                        width: container.clientWidth,
                        height: container.clientHeight,
                    });
                }, 100);
            }
        });
    </script>
</body>
</html> 