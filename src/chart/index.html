<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBMA Chart - Simplified</title>
    <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
    <script src="config.js"></script>
    <script src="optimized_utils.js"></script>
    <style>
        /* ========= –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò ========= */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
            background: #0D1421;
            color: #B2B5BE;
            overflow: hidden;
            height: 100vh;
        }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;
        }

        /* ========= –í–ï–†–•–ù–Ø–Ø –ü–ê–ù–ï–õ–¨ ========= */
        .top-panel {
            height: 48px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            justify-content: space-between;
        }

        .symbol-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .symbol-name {
            font-size: 16px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .symbol-details {
            font-size: 11px;
            color: #787B86;
        }

        .price-data {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .price-item {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .price-label {
            font-size: 10px;
            font-weight: 500;
        }

        .price-value {
            font-size: 14px;
            font-weight: 600;
            color: #FFFFFF;
        }

        .price-change {
            font-size: 12px;
            font-weight: 500;
        }

        .price-change.positive {
            color: #00C851;
        }

        .price-change.negative {
            color: #FF4444;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –¢–ê–ô–ú–§–†–ï–ô–ú–û–í ========= */
        .toolbar-panel {
            height: 40px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 16px;
        }

        .toolbar-group {
            display: flex;
            gap: 2px;
        }

        .toolbar-btn {
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            color: #B2B5BE;
            background: transparent;
            border: none;
        }

        .toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #FFFFFF;
        }

        .toolbar-btn.active {
            background: #2962FF;
            color: #FFFFFF;
        }

        .toolbar-separator {
            width: 1px;
            height: 20px;
            background: #2A2E39;
        }

        /* ========= –ü–ê–ù–ï–õ–¨ –£–ü–†–ê–í–õ–ï–ù–ò–Ø ========= */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 12px 16px;
            background: #1E222D;
            border-bottom: 1px solid #2A2E39;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #2A2E39;
            border-radius: 6px;
            font-size: 12px;
        }

        .control-group label {
            color: #B2B5BE;
            font-weight: 500;
            white-space: nowrap;
        }

        .control-group select,
        .control-group input {
            background: #131722;
            border: 1px solid #2A2E39;
            border-radius: 4px;
            padding: 4px 8px;
            color: #FFFFFF;
            font-size: 12px;
            min-width: 80px;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2962FF;
            box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.3);
        }

        .control-btn {
            background: #2962FF;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .control-btn:hover {
            background: #1E53E5;
        }

        .date-input {
            width: 140px !important;
        }

        /* ========= –û–ë–õ–ê–°–¢–¨ –ì–†–ê–§–ò–ö–ê ========= */
        .chart-area {
            flex: 1;
            position: relative;
            background: #0D1421;
        }

        .chart-container {
            width: 100%;
            height: 100%;
            background: #0D1421;
        }

        .status {
            position: absolute;
            top: 12px;
            right: 18px;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
        }

        .status.success {
            border-color: #00C851;
            color: #00C851;
        }

        .status.error {
            border-color: #FF4444;
            color: #FF4444;
        }

        .status.info {
            border-color: #2962FF;
            color: #2962FF;
        }

        /* ========= –°–ö–†–´–¢–´–ï –≠–õ–ï–ú–ï–ù–¢–´ ========= */
        .hidden {
            display: none;
        }

        /* ========= –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ ========= */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 8px;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: space-between;
            }
            
            .top-panel {
                flex-direction: column;
                height: auto;
                padding: 8px 16px;
                gap: 8px;
            }
            
            .price-data {
                justify-content: space-around;
                width: 100%;
            }
        }

        /* ========= –û–°–ù–û–í–´ –°–ö–†–û–õ–õ–ë–ê–†–ê ========= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1E222D;
        }

        ::-webkit-scrollbar-thumb {
            background: #2A2E39;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #363A45;
        }

        select option {
            background: #1E222D;
            color: #FFFFFF;
        }

        /* —Å–∫—Ä—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø—Ä–∏ fullscreen */
        .fullscreen-mode .toolbar,
        .fullscreen-mode .controls {
            display: none !important;
        }

        /* —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
        .fullscreen-mode .chart-area {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            z-index: 999;
        }

        /* –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º –∫–Ω–æ–ø–∫–∏ */
        .toolbar-btn.disabled {
            opacity: 0.35;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å -->
        <div class="top-panel">
            <div class="symbol-info">
                <div class="symbol-name">Coinbase Index Rank</div>
                <!-- subtitle removed -->
            </div>
            <!-- –ë–ª–æ–∫ —Ü–µ–Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö —É–¥–∞–ª—ë–Ω -->
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ -->
        <div class="toolbar-panel">
            <div class="toolbar-group" id="timeframe-buttons">
                <button class="toolbar-btn" data-timeframe="4h">4h</button>
                <button class="toolbar-btn" data-timeframe="1D">1D</button>
                <button class="toolbar-btn" data-timeframe="3D">3D</button>
                <button class="toolbar-btn active" data-timeframe="1W">1W</button>
            </div>

            <div class="toolbar-group" id="instrument-buttons" style="margin-left: 20px;">
                <button class="toolbar-btn instrument-btn active" data-instrument="btc">BTC</button>
                <button class="toolbar-btn instrument-btn" data-instrument="spx">S&P 500</button>
                <button class="toolbar-btn instrument-btn" data-instrument="vix">VIX</button>
                <button class="toolbar-btn instrument-btn" data-instrument="dxy">DXY</button>
                <button class="toolbar-btn instrument-btn" data-instrument="total3esbtc">Total3 - BTC</button>
                <button class="toolbar-btn instrument-btn" data-instrument="withoutbtc">Without BTC</button>
                <button class="toolbar-btn instrument-btn" data-instrument="withoutbtceth">Without BTC/ETH</button>
                <button class="toolbar-btn instrument-btn" data-instrument="others">Others</button>
                <button class="toolbar-btn instrument-btn" data-instrument="othersbtc">Others BTC</button>
            </div>
        </div>

        <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
        <div class="controls">
            <div class="control-group">
                <label>MA –ø–µ—Ä–∏–æ–¥:</label>
                <input type="number" id="ma-period-input" value="30" min="1" max="365" style="width:70px;">
            </div>

            <div class="control-group">
                <label>–°:</label>
                <input type="date" id="date-from" class="date-input">
            </div>

            <div class="control-group">
                <label>–ü–æ:</label>
                <input type="date" id="date-to" class="date-input">
            </div>

            <button class="control-btn" id="update-btn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button class="control-btn" id="reset-btn">‚Ü© –°–±—Ä–æ—Å–∏—Ç—å</button>
            <button class="control-btn" id="fullscreen-btn">‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
        </div>

        <!-- –û–±–ª–∞—Å—Ç—å –≥—Ä–∞—Ñ–∏–∫–∞ -->
        <div class="chart-area">
            <div class="chart-container" id="chart-container"></div>
        </div>
        <div class="status info" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    </div>

    <script>
        console.log('üîß Frontend Configuration:', CONFIG);

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let chart = null;
        let coinbaseSeries = null;
        let comparisonSeries = null;
        let currentComparison = 'btc';
        let currentTimeframe = '1W';
        let currentMaPeriod = 14;

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        let coinbaseData = [];
        let comparisonData = [];
        let isLoading = false;

        // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö –∏ —Å–µ—Ä–∏–π –¥–ª—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        const DATA_CACHE = {};   // –∫–ª—é—á: `${instrument}_${tf}`  ‚Üí –º–∞—Å—Å–∏–≤ —Å–≤–µ—á–µ–π/–ª–∏–Ω–∏–∏
        const SERIES_CACHE = {}; // –∫–ª—é—á: instrument ‚Üí —Å–æ–∑–¥–∞–Ω–Ω–∞—è —Å–µ—Ä–∏—è

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ TradingView Lightweight Charts loaded successfully');
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            initializeControls();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            initializeChart();
            
            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            loadData();
        });

        function initializeControls() {
            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            document.getElementById('ma-period-input').value = currentMaPeriod;

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            document.getElementById('ma-period-input').addEventListener('change', function() {
                currentMaPeriod = Math.max(1, parseInt(this.value) || 30);
                loadData();
            });

            document.getElementById('update-btn').addEventListener('click', loadData);
            document.getElementById('reset-btn').addEventListener('click', resetChart);
            document.getElementById('fullscreen-btn').addEventListener('click', toggleFullscreen);

            // –ö–Ω–æ–ø–∫–∏ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ (–∏–º–µ—é—Ç data-timeframe)
            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                const tf = btn.dataset.timeframe;
                if (!tf) return; // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∫–Ω–æ–ø–∫–∏ –±–µ–∑ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä instrument)
                btn.addEventListener('click', () => {
                    currentTimeframe = tf;
                    updateTimeframeButtons();
                    loadData();
                });
            });

            // –ö–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    currentComparison = btn.dataset.instrument;
                    updateInstrumentButtons();
                    updateComparisonInfo();
                    updateTimeframeButtons();
                    loadData();
                });
            });

            // –î–∞—Ç—ã –±—É–¥—É—Ç –≤—ã—Å—Ç–∞–≤–ª–µ–Ω—ã –ø–æ—Å–ª–µ initial loadData (fitContent)
            updateComparisonInfo();
            updateTimeframeButtons();
            updateInstrumentButtons();
        }

        function initializeChart() {
            if (!window.LightweightCharts) {
                console.error('TradingView Lightweight Charts not loaded');
                return;
            }

            const chartContainer = document.getElementById('chart-container');
            
            chart = LightweightCharts.createChart(chartContainer, {
                width: chartContainer.clientWidth,
                height: chartContainer.clientHeight,
                layout: {
                    background: { color: '#0D1421' },
                    textColor: '#B2B5BE',
                },
                grid: {
                    vertLines: { color: '#2A2E39' },
                    horzLines: { color: '#2A2E39' },
                },
                crosshair: {
                    mode: LightweightCharts.CrosshairMode.Normal,
                },
                leftPriceScale: {
                    visible: true,
                    invertScale: true,
                    borderColor: '#2A2E39',
                    scaleMargins: {
                        top: 0.05,
                        bottom: 0.05,
                    },
                },
                rightPriceScale: {
                    borderColor: '#2A2E39',
                    scaleMargins: {
                        top: 0.05,
                        bottom: 0.05,
                    },
                },
                timeScale: {
                    borderColor: '#2A2E39',
                    timeVisible: true,
                    secondsVisible: false,
                },
            });

            // –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ä–∏–π –¥–∞–Ω–Ω—ã—Ö
            coinbaseSeries = chart.addLineSeries({
                color: '#2962FF',
                lineWidth: 3,
                priceScaleId: 'left',
                title: 'Coinbase MA' + currentMaPeriod,
                crosshairMarkerVisible: true,
                crosshairMarkerRadius: 6,
                crosshairMarkerBorderColor: '#2962FF',
                crosshairMarkerBackgroundColor: '#2962FF',
            });

            comparisonSeries = chart.addCandlestickSeries({
                upColor: '#26a69a',
                downColor: '#ef5350',
                borderVisible: false,
                wickUpColor: '#26a69a',
                wickDownColor: '#ef5350'
            });

            // –ù–∞–¥—ë–∂–Ω—ã–π —Ä–µ—Å–∞–π–∑ —á–µ—Ä–µ–∑ ResizeObserver (–ª–æ–≤–∏—Ç –ª—é–±—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
            if (window.ResizeObserver) {
                const ro = new ResizeObserver(entries => {
                    for (const e of entries) {
                        const { width, height } = e.contentRect;
                        if (typeof chart.resize === 'function') {
                            chart.resize(width, height); // v4+
                        } else {
                            chart.applyOptions({ width, height }); // v3 fallback
                        }
                    }
                });
                ro.observe(chartContainer);
            } else {
                // fallback –Ω–∞ —Å–æ–±—ã—Ç–∏–µ window.resize –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
                window.addEventListener('resize', () => {
                    const w = chartContainer.clientWidth;
                    const h = chartContainer.clientHeight;
                    if (typeof chart.resize === 'function') chart.resize(w, h);
                    else chart.applyOptions({ width: w, height: h });
                });
            }

            console.log('‚úÖ Chart initialized successfully');
        }

        function updateComparisonInfo() {
            const instrument = CONFIG.INSTRUMENTS[currentComparison];
            if (instrument) {
                const cmpEl = document.getElementById('comparison-symbol');
                if (cmpEl) cmpEl.textContent = instrument.name;
                if (comparisonSeries) {
                    comparisonSeries.applyOptions({
                        color: instrument.color,
                        title: instrument.name,
                        crosshairMarkerBorderColor: instrument.color,
                        crosshairMarkerBackgroundColor: instrument.color,
                    });
                }
            }
        }

        function setStatus(message, type = 'info') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function loadData() {
            if (isLoading) return;
            isLoading = true;

            try {
                setStatus('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ Coinbase –¥–∞–Ω–Ω—ã—Ö
                await loadCoinbaseData();
                
                // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                await loadComparisonData();
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ/–∫–æ–Ω–µ—Ü –ø–æ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏—é –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤
                if (chart && coinbaseData.length && comparisonData.length) {
                    const start = Math.max(coinbaseData[0].time, comparisonData[0].time);
                    const end   = Math.min(coinbaseData[coinbaseData.length - 1].time,
                                        comparisonData[comparisonData.length - 1].time);
                    chart.timeScale().setVisibleRange({ from: start, to: end });
                } else if (chart) {
                    chart.timeScale().fitContent();
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—è –¥–∞—Ç –ø–æ–ª–Ω—ã–º –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º
                if (coinbaseData.length > 0) {
                    const firstDateStr = new Date(coinbaseData[0].time * 1000).toISOString().split('T')[0];
                    const lastDateStr = new Date(coinbaseData[coinbaseData.length - 1].time * 1000).toISOString().split('T')[0];
                    document.getElementById('date-from').value = firstDateStr;
                    document.getElementById('date-to').value = lastDateStr;
                }

                setStatus('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ', 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
            } finally {
                isLoading = false;
            }
        }

        async function loadCoinbaseData() {
            try {
                const response = await fetch('/data/data.json');
                const data = await response.json();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
                let processedData = [];
                if (data.data && Array.isArray(data.data)) {
                    processedData = data.data.map(item => ({
                        time: Math.floor(new Date(item.date).getTime() / 1000),
                        value: parseFloat(item.rank)
                    }));
                } else {
                    // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç
                    processedData = Object.entries(data).map(([date, values]) => ({
                        time: Math.floor(new Date(date).getTime() / 1000),
                        value: parseFloat(values.Overall || 0)
                    }));
                }

                // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                processedData.sort((a, b) => a.time - b.time);

                // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ–ª—å–∑—è—â–µ–π —Å—Ä–µ–¥–Ω–µ–π
                const maData = applyMovingAverage(processedData, currentMaPeriod);
                
                // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                const displayData = aggregateData(maData, currentTimeframe);
                coinbaseData = displayData;
                if (coinbaseSeries) {
                    coinbaseSeries.setData(displayData);
                    coinbaseSeries.applyOptions({
                        title: 'Coinbase MA' + currentMaPeriod,
                    });
                }

                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ö–µ–¥–µ—Ä–µ
                if (displayData.length > 0) {
                    const latestRank = displayData[displayData.length - 1].value;
                    const rankEl = document.getElementById('rank-value');
                    if (rankEl) rankEl.textContent = latestRank.toFixed(0);
                }

                console.log(`‚úÖ Coinbase data loaded: ${displayData.length} points`);
                
            } catch (error) {
                console.error('Error loading Coinbase data:', error);
                throw error;
            }
        }

        async function loadComparisonData() {
            const instrument = CONFIG.INSTRUMENTS[currentComparison];
            if (!instrument) return;

            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ —Å–µ—Ä–∏–∏
            Object.values(SERIES_CACHE).forEach(s => s.applyOptions({ visible: false }));

            // –ü–æ–ª—É—á–∞–µ–º / —Å–æ–∑–¥–∞—ë–º —Å–µ—Ä–∏—é –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            if (!SERIES_CACHE[currentComparison]) {
                SERIES_CACHE[currentComparison] = instrument.seriesType === 'line'
                    ? chart.addLineSeries({
                        color: instrument.color,
                        priceScaleId: 'right',
                        lineWidth: 2,
                    })
                    : chart.addCandlestickSeries({
                        upColor: '#26a69a',
                        downColor: '#ef5350',
                        borderVisible: false,
                        wickUpColor: '#26a69a',
                        wickDownColor: '#ef5350',
                        priceScaleId: 'right',
                    });
            }
            comparisonSeries = SERIES_CACHE[currentComparison];
            comparisonSeries.applyOptions({ visible: true });

            // –ö–ª—é—á –∫—ç—à–∞ –¥–∞–Ω–Ω—ã—Ö —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–∞–π–º—Ñ—Ä–µ–π–º, —Ç.–∫. –ø—Ä–∏ 1D/1W —Ä–∞–∑–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã
            const dataKey = `${currentComparison}_${currentTimeframe}`;

            if (DATA_CACHE[dataKey]) {
                comparisonSeries.setData(DATA_CACHE[dataKey]);
            } else {
                try {
                    if (instrument.dataSource === 'api') {
                        await loadApiData(instrument);
                    } else {
                        await loadFileData(instrument);
                    }
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ –∫—ç—à
                    DATA_CACHE[dataKey] = comparisonData;
                } catch (error) {
                    console.error('Error loading comparison data:', error);
                    throw error;
                }
            }

            // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–± –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (—Ü–µ–Ω–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
            if (chart) chart.timeScale().fitContent();

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –≤—Ä–µ–º–µ–Ω–∏: –Ω–µ —Ä–∞–Ω—å—à–µ –Ω–∞—á–∞–ª–∞ Coinbase
            if (coinbaseData.length && comparisonData.length && chart) {
                const start = Math.max(coinbaseData[0].time, comparisonData[0].time);
                const end = comparisonData[comparisonData.length - 1].time;
                chart.timeScale().setVisibleRange({ from: start, to: end });
            }
        }

        async function loadApiData(instrument) {
            try {
                const response = await fetch(`/api/history?symbol=${instrument.apiSymbol}&resolution=${currentTimeframe}&from=1&to=${Math.floor(Date.now() / 1000)}`);
                const data = await response.json();
                
                if (data.s === 'ok' && data.t && data.c) {
                    const processedData = data.t.map((time, index) => ({
                        time: time,
                        open: parseFloat(data.o[index]),
                        high: parseFloat(data.h[index]),
                        low: parseFloat(data.l[index]),
                        close: parseFloat(data.c[index])
                    }));

                    // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                    const displayData = aggregateCandleData(processedData, currentTimeframe);
                    comparisonData = displayData;
                    if (comparisonSeries) {
                        comparisonSeries.setData(displayData);
                    }

                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –≤ —Ö–µ–¥–µ—Ä–µ
                    if (displayData.length > 0) {
                        const latestValue = displayData[displayData.length - 1].value;
                        const btcEl = document.getElementById('btc-value');
                        if (btcEl) btcEl.textContent = '$' + latestValue.toLocaleString();
                    }

                    console.log(`‚úÖ ${instrument.name} data loaded: ${displayData.length} points`);
                } else if (data.s === 'no_data') {
                    console.error(`Coinglass API: no data for ${instrument.apiSymbol}`, data);
                    if (comparisonSeries) {
                        comparisonSeries.setData([]);
                    }
                    return;
                } else {
                    console.error('Coinglass API: unexpected response', data);
                    throw new Error('Invalid API response');
                }
                
            } catch (error) {
                console.error(`Error loading ${instrument.name} API data:`, error);
                throw error;
            }
        }

        async function loadFileData(instrument) {
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ–∞–π–ª —Å–æ–≥–ª–∞—Å–Ω–æ —Ç–µ–∫—É—â–µ–º—É —Ç–∞–π–º—Ñ—Ä–µ–π–º—É
                const tfMap = { '4h': '1D', '1D': '1D', '3D': '1D', '1W': '1W' };
                const tfFile = tfMap[currentTimeframe] || '1D';

                // –§–æ—Ä–º–∏—Ä—É–µ–º URL. –í CONFIG –¥–ª—è csv-–∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —É–∫–∞–∑–∞–Ω path '/data/vix/' –∏ —Ç.–¥.
                const basePath = instrument.path; // –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —Å–ª—ç—à–µ–º
                // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω —à–∞–±–ª–æ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ, –∏–Ω–∞—á–µ —Ñ–æ—Ä–º–∏—Ä—É–µ–º –ø–æ symbol –∏–ª–∏ –∫–ª—é—á—É
                const fileName = instrument.filePattern
                    ? instrument.filePattern.replace('{tf}', tfFile)
                    : `${(instrument.symbol || currentComparison).toUpperCase()}, ${tfFile}.csv`;
                const url = `${basePath}${fileName}`;

                const resp = await fetch(url);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const text = await resp.text();

                const lines = text.trim().split(/\r?\n/).slice(1); // skip header
                const raw = lines.map(line => line.split(',')).filter(arr => arr.length >= 5);

                const parsed = raw.map(arr => {
                    const tsNum = Number(arr[0]);
                    // –ï—Å–ª–∏ –≤ —Ñ–∞–π–ª–µ epoch seconds, –æ—Å—Ç–∞–≤–ª—è–µ–º; –µ—Å–ª–∏ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥—ã, –¥–µ–ª–∏–º
                    const epochSec = tsNum > 1e12 ? Math.floor(tsNum / 1000) : tsNum;
                    return {
                        time: epochSec,
                        open: parseFloat(arr[1]),
                        high: parseFloat(arr[2]),
                        low:  parseFloat(arr[3]),
                        close:parseFloat(arr[4])
                    };
                });

                let displayData = [];
                const isDailyFile = tfFile === '1D';
                const needsAggregation = (currentTimeframe === '3D') || (currentTimeframe === '1W' && isDailyFile);

                if (instrument.seriesType === 'line') {
                    const lineData = parsed.map(p => ({ time: p.time, value: p.close }));
                    displayData = needsAggregation ? aggregateData(lineData, currentTimeframe) : lineData;
                    if (comparisonSeries) comparisonSeries.setData(displayData);
                    console.log(`‚úÖ CSV data loaded for ${instrument.name}: ${displayData.length} points`);
                } else {
                    displayData = needsAggregation ? aggregateCandleData(parsed, currentTimeframe) : parsed;
                    if (comparisonSeries) comparisonSeries.setData(displayData);
                    console.log(`‚úÖ CSV data loaded for ${instrument.name}: ${displayData.length} candles`);
                }
                comparisonData = displayData;
            } catch (e) {
                console.error(`Error loading CSV for ${instrument.name}:`, e);
            }
        }

        function applyMovingAverage(data, period) {
            if (data.length < period) return data;
            
            const result = [];
            for (let i = period - 1; i < data.length; i++) {
                let sum = 0;
                for (let j = 0; j < period; j++) {
                    sum += data[i - j].value;
                }
                result.push({
                    time: data[i].time,
                    value: sum / period
                });
            }
            return result;
        }

        function resetChart() {
            currentComparison = 'btc';
            currentTimeframe = '1W';
            currentMaPeriod = 14;
            
            document.getElementById('ma-period-input').value = currentMaPeriod;
            
            updateComparisonInfo();
            updateTimeframeButtons();
            loadData();
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                document.exitFullscreen();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        document.addEventListener('fullscreenchange', () => {
            // –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º CSS-–∫–ª–∞—Å—Å
            const isFs = !!document.fullscreenElement;
            document.body.classList.toggle('fullscreen-mode', isFs);

            if (!chart) return;
            // –î–≤–æ–π–Ω–æ–π rAF –¥–∞—ë—Ç –±—Ä–∞—É–∑–µ—Ä—É 2 –∫–∞–¥—Ä–∞ –Ω–∞ –ø–µ—Ä–µ—Ä–∞—Å—á—ë—Ç layout,
            // –∏–Ω–∞—á–µ –≤—ã—Å–æ—Ç–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—á–∏—Å–ª–µ–Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    const container = document.getElementById('chart-container');
                    const w = container.clientWidth;
                    const h = container.clientHeight;
                    if (typeof chart.resize === 'function') {
                        chart.resize(w, h);
                    } else {
                        chart.applyOptions({ width: w, height: h });
                    }
                    chart.timeScale().fitContent();
                    // –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π resize —Å–ø—É—Å—Ç—è 300ms ‚Äì –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –ø–æ–¥–≥–æ–Ω–∫—É –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ layout
                    setTimeout(() => {
                        window.dispatchEvent(new Event('resize'));
                    }, 300);
                });
            });
        });

        const TF_MAP = { '4h': '240', '1D': 'D', '3D': '3D', '1W': 'W' };

        function updateTimeframeButtons() {
            const supported = CONFIG.INSTRUMENTS[currentComparison]?.supportedTimeframes || [];

            document.querySelectorAll('.toolbar-btn').forEach(btn => {
                const tf = btn.dataset.timeframe;
                if (!tf) return;
                const code = TF_MAP[tf] || tf;
                const isSupported = supported.includes(code);

                btn.classList.toggle('disabled', !isSupported);
                btn.classList.toggle('active', isSupported && tf === currentTimeframe);
            });

            // –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π timeframe –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äì –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
            if (!supported.includes(TF_MAP[currentTimeframe] || currentTimeframe)) {
                if (supported.length) {
                    const fallback = supported[0];
                    // –æ–±—Ä–∞—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                    const reverseMap = { '240': '4h', 'D': '1D', '3D': '3D', 'W': '1W' };
                    currentTimeframe = reverseMap[fallback] || '1D';
                }
            }
        }

        function updateInstrumentButtons() {
            document.querySelectorAll('.instrument-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.instrument === currentComparison);
            });
        }

        // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ 3-–¥–Ω–µ–≤–Ω—ã–µ –∏–ª–∏ –Ω–µ–¥–µ–ª—å–Ω—ã–µ —Å–≤–µ—á–∏
        function aggregateData(data, timeframe) {
            if (!Array.isArray(data) || data.length === 0) return data;

            const stepMap = { '3D': 3, '1W': 7 };
            const step = stepMap[timeframe] || 1;
            if (step === 1) return data;

            const result = [];
            for (let i = 0; i < data.length; i += step) {
                const slice = data.slice(i, i + step);
                if (!slice.length) continue;
                // —É—Å—Ä–µ–¥–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è; –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ close –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ
                const avg = slice.reduce((sum, p) => sum + p.value, 0) / slice.length;
                result.push({ time: slice[slice.length - 1].time, value: avg });
            }
            return result;
        }

        // –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º —Å–≤–µ—á–∏
        function aggregateCandleData(data, timeframe) {
            const stepMap = { '3D': 3, '1W': 7 };
            const step = stepMap[timeframe] || 1;
            if (step === 1) return data;
            const out = [];
            for (let i = 0; i < data.length; i += step) {
                const slice = data.slice(i, i + step);
                if (!slice.length) continue;
                out.push({
                    time: slice[slice.length - 1].time,
                    open: slice[0].open,
                    close: slice[slice.length - 1].close,
                    high: Math.max(...slice.map(s => s.high)),
                    low: Math.min(...slice.map(s => s.low))
                });
            }
            return out;
        }
    </script>
</body>
</html> 