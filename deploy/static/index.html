<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Instrument Chart</title>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
    <script src="config.js"></script>
    <script src="optimized_utils.js"></script>
    <script src="enhanced_technical_indicators.js"></script>
    <script src="indicators_manager.js"></script>
    <script src="timescale_integration.js"></script>
    <script src="advanced_chart_features.js"></script>
    <script src="datafeed_optimization.js"></script>
    <script src="events_and_export.js"></script>
    <script src="advanced_series_and_scale.js"></script>
    <script src="mobile_responsive.js"></script>
    <script src="candlestick_bar_series.js"></script>
    <script src="advanced_time_features.js"></script>
    <script src="performance_optimizations.js"></script>
    <script src="animation_effects.js"></script>
    <script src="custom_crosshair.js"></script>
    <style>
        /* TradingView-like design */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background: #131722;
            color: #d1d4dc;
            min-height: 100vh;
            font-size: 13px;
        }
        
        .container {
            max-width: 100%;
            margin: 0;
            background: #131722;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 44px;
        }
        
        .title {
            font-size: 16px;
            font-weight: 600;
            color: #ffffff;
            margin: 0;
        }
        
        .legend {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #9db2bd;
        }
        
        .legend-line {
            width: 16px;
            height: 2px;
            border-radius: 1px;
        }
        
        .legend-comparison {
            background: #ff9800;
        }
        
        .legend-instrument {
            background: #2962ff;
        }
        
        .controls {
            background: #1e222d;
            border-bottom: 1px solid #2a2e39;
            padding: 8px 12px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #2a2e39;
            border: 1px solid #363a45;
            border-radius: 4px;
            padding: 6px 8px;
            transition: all 0.2s ease;
        }
        
        .control-group:hover {
            background: #323641;
            border-color: #464a57;
        }
        
        .control-group label {
            font-size: 12px;
            color: #9db2bd;
            font-weight: 400;
            white-space: nowrap;
        }
        
        .control-group select {
            border: none;
            background: transparent;
            color: #d1d4dc;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            outline: none;
            min-width: 60px;
        }
        
        .control-group select:focus {
            color: #ffffff;
        }
        
        .control-group select option {
            background: #2a2e39;
            color: #d1d4dc;
            padding: 4px 8px;
        }
        
        .date-input {
            border: none;
            background: transparent;
            color: #d1d4dc;
            font-size: 12px;
            cursor: pointer;
            padding: 0;
            outline: none;
            min-width: 100px;
        }
        
        .date-input:focus {
            color: #ffffff;
        }
        
        .reset-btn, .fit-btn {
            border: none;
            background: #2962ff;
            color: #ffffff;
            font-size: 12px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .reset-btn:hover, .fit-btn:hover {
            background: #1e4fd4;
        }
        
        .reset-btn:active, .fit-btn:active {
            background: #1b4bc7;
        }
        
        .chart-container {
            flex: 1;
            background: #131722;
            border: none;
            margin: 0;
            overflow: hidden;
            position: relative;
        }
        
        .status {
            position: absolute;
            top: 10px;
            left: 10px;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            background: rgba(42, 46, 57, 0.9);
            color: #9db2bd;
            border: 1px solid #363a45;
            z-index: 1000;
        }
        
        .status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4caf50;
            border-color: #4caf50;
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border-color: #f44336;
        }
        
        .status.info {
            background: rgba(33, 150, 243, 0.1);
            color: #2196f3;
            border-color: #2196f3;
        }
        
        .data-info {
            background: #1e222d;
            border-top: 1px solid #2a2e39;
            padding: 8px 12px;
            font-size: 11px;
            color: #787b86;
            line-height: 1.4;
        }
        
        /* Scrollbars */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #131722;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #2a2e39;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #363a45;
        }
        
        /* Tooltips */
        .tooltip {
            position: absolute;
            background: #2a2e39;
            color: #d1d4dc;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            border: 1px solid #363a45;
            z-index: 1000;
            max-width: 200px;
        }
        
        /* Button variants */
        .btn-secondary {
            background: #363a45;
            color: #d1d4dc;
        }
        
        .btn-secondary:hover {
            background: #434651;
        }
        
        .btn-success {
            background: #4caf50;
            color: #ffffff;
        }
        
        .btn-success:hover {
            background: #45a049;
        }
        
        .btn-warning {
            background: #ff9800;
            color: #ffffff;
        }
        
        .btn-warning:hover {
            background: #e68900;
        }
        
        .btn-danger {
            background: #f44336;
            color: #ffffff;
        }
        
        .btn-danger:hover {
            background: #da190b;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .control-group {
                justify-content: space-between;
            }
            
            .header {
                flex-direction: column;
                height: auto;
                padding: 12px;
                gap: 8px;
            }
            
            .legend {
                order: 2;
            }
            
            .data-info {
                font-size: 10px;
            }
        }
        
        /* Animation enhancements */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease;
        }
        
        /* Chart-specific styles */
        .chart-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #9db2bd;
            font-size: 14px;
        }
        
        .chart-error {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #f44336;
            font-size: 14px;
        }
        
        /* Enhanced control styles */
        .control-group.active {
            background: #2962ff;
            border-color: #2962ff;
        }
        
        .control-group.active label {
            color: #ffffff;
        }
        
        .control-group.active select {
            color: #ffffff;
        }
        
        /* Custom select arrow */
        .control-group select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='%23d1d4dc' viewBox='0 0 16 16'%3e%3cpath d='M8 13.1l-8-8 2.1-2.1 5.9 5.9 5.9-5.9 2.1 2.1-8 8z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 4px center;
            background-size: 12px;
            padding-right: 20px;
        }
        
        /* Enhanced status messages */
        .status.loading {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
            border-color: #ffc107;
        }
        
        .status.loading::before {
            content: "‚è≥ ";
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">CBMA14 Chart</div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-line legend-instrument"></div>
                    <span id="coinbase-legend">Coinbase Index</span>
                </div>
                <div class="legend-item">
                    <div class="legend-line legend-comparison"></div>
                    <span id="comparison-legend">BTC</span>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label for="comparisonSelect">–°—Ä–∞–≤–Ω–∏—Ç—å —Å:</label>
                <select id="comparisonSelect">
                    <option value="btc" selected>BTC</option>
                    <option value="spx">S&P 500</option>
                    <option value="vix">VIX</option>
                    <option value="dxy">DXY</option>
                    <option value="total3esbtc">Total3 - BTC</option>
                    <option value="withoutbtceth">Without BTC/ETH</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="timeframeSelect">–¢–∞–π–º—Ñ—Ä–µ–π–º:</label>
                <select id="timeframeSelect">
                    <option value="240">4H</option>
                    <option value="D">1D</option>
                    <option value="3D">3D</option>
                    <option value="W" selected>1W</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="maPeriodSelect">MA –ø–µ—Ä–∏–æ–¥:</label>
                <select id="maPeriodSelect">
                    <option value="7">7 –¥–Ω–µ–π</option>
                    <option value="14" selected>14 –¥–Ω–µ–π</option>
                    <option value="30">30 –¥–Ω–µ–π</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="fromDate">–û—Ç:</label>
                <input type="date" id="fromDate" class="date-input">
            </div>
            
            <div class="control-group">
                <label for="toDate">–î–æ:</label>
                <input type="date" id="toDate" class="date-input">
            </div>
            
            <div class="control-group">
                <button id="resetScale" class="reset-btn">üîÑ –°–±—Ä–æ—Å–∏—Ç—å –º–∞—Å—à—Ç–∞–±</button>
            </div>
            
            <div class="control-group">
                <button id="fitContent" class="fit-btn">üìè –ü–æ–¥–æ–≥–Ω–∞—Ç—å –≤—Å–µ</button>
            </div>
            
            <div class="control-group">
                <label for="indicatorSelect">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã:</label>
                <select id="indicatorSelect">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä</option>
                    <option value="sma">SMA</option>
                    <option value="ema">EMA</option>
                    <option value="rsi">RSI</option>
                    <option value="macd">MACD</option>
                    <option value="bollinger">Bollinger Bands</option>
                    <option value="stochastic">Stochastic</option>
                    <option value="cbma14">CBMA14 Enhanced</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="addIndicator" class="reset-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            
            <div class="control-group">
                <label>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</label>
                <select id="quickTimeRange">
                    <option value="">–í—ã–±—Ä–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω</option>
                    <option value="7days">7 –¥–Ω–µ–π</option>
                    <option value="30days">30 –¥–Ω–µ–π</option>
                    <option value="3months">3 –º–µ—Å—è—Ü–∞</option>
                    <option value="6months">6 –º–µ—Å—è—Ü–µ–≤</option>
                    <option value="1year">1 –≥–æ–¥</option>
                    <option value="2years">2 –≥–æ–¥–∞</option>
                    <option value="all">–í—Å–µ –¥–∞–Ω–Ω—ã–µ</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="toggleTheme" class="reset-btn">üåì –¢–µ–º–∞</button>
            </div>
            
            <div class="control-group">
                <button id="toggleGrid" class="reset-btn">‚öè –°–µ—Ç–∫–∞</button>
            </div>
            
            <div class="control-group">
                <label>–£—Ä–æ–≤–Ω–∏:</label>
                <select id="addPriceLevels">
                    <option value="">–î–æ–±–∞–≤–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</option>
                    <option value="support">–ü–æ–¥–¥–µ—Ä–∂–∫–∞</option>
                    <option value="resistance">–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ</option>
                    <option value="fibonacci">–§–∏–±–æ–Ω–∞—á—á–∏</option>
                    <option value="pivot">–ü–∏–≤–æ—Ç—ã</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–≠–∫—Å–ø–æ—Ä—Ç:</label>
                <select id="exportOptions">
                    <option value="">–≠–∫—Å–ø–æ—Ä—Ç</option>
                    <option value="image">üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</option>
                    <option value="csv">üìÑ CSV</option>
                    <option value="json">üì¶ JSON</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–°–µ—Ä–∏–∏:</label>
                <select id="seriesOptions">
                    <option value="">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–∏—é</option>
                    <!-- <option value="volume">üìä –û–±—ä—ë–º—ã</option> -->
                    <option value="area">üìà –û–±–ª–∞—Å—Ç—å</option>
                    <option value="baseline">üìâ –ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–®–∫–∞–ª–∞:</label>
                <select id="priceScaleMode">
                    <option value="normal">–û–±—ã—á–Ω–∞—è</option>
                    <option value="logarithmic">–õ–æ–≥–∞—Ä–∏—Ñ–º–∏—á–µ—Å–∫–∞—è</option>
                    <option value="percentage">–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="saveState" class="reset-btn">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
            
            <div class="control-group">
                <button id="toggleFullscreen" class="reset-btn">‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
            </div>
            
            <div class="control-group">
                <label>Candlesticks:</label>
                <select id="candlestickOptions">
                    <option value="">–î–æ–±–∞–≤–∏—Ç—å —Å–≤–µ—á–∏</option>
                    <option value="classic">üïØÔ∏è –ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ</option>
                    <option value="hollow">‚ö™ –ü–æ–ª—ã–µ</option>
                    <option value="heikin">üéå Heikin-Ashi</option>
                    <option value="bar">üìä –ë–∞—Ä—ã</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–í—Ä–µ–º—è:</label>
                <select id="timeFeatures">
                    <option value="">–§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏</option>
                    <option value="business_hours">üè¢ –¢–æ—Ä–≥–æ–≤—ã–µ —á–∞—Å—ã</option>
                    <option value="timezone">üåç –ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å</option>
                    <option value="goto_now">‚è∞ –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è</option>
                    <option value="custom_marks">üìç –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>Crosshair:</label>
                <select id="crosshairMode">
                    <option value="normal">–û–±—ã—á–Ω—ã–π</option>
                    <option value="magnet">–ú–∞–≥–Ω–∏—Ç–Ω—ã–π</option>
                    <option value="hidden">–°–∫—Ä—ã—Ç—ã–π</option>
                </select>
            </div>
            
            <div class="control-group">
                <label>–ê–Ω–∏–º–∞—Ü–∏–∏:</label>
                <select id="animationEffects">
                    <option value="">–≠—Ñ—Ñ–µ–∫—Ç—ã</option>
                    <option value="entrance_fade">üí´ –ü–æ—è–≤–ª–µ–Ω–∏–µ</option>
                    <option value="highlight">‚ú® –ü–æ–¥—Å–≤–µ—Ç–∫–∞</option>
                    <option value="pulse">üíì –ü—É–ª—å—Å–∞—Ü–∏—è</option>
                    <option value="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞</option>
                </select>
            </div>
            
            <div class="control-group">
                <button id="toggleAnimations" class="reset-btn">üé¨ –ê–Ω–∏–º–∞—Ü–∏–∏</button>
            </div>
        </div>
        
        <div class="data-info">
            üìä <strong>Coinbase Index:</strong> –≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ –ª–µ–≤–æ–π –æ—Å–∏ (—Ä–∞–Ω–∫ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –≤—Å–µ—Ö –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç) | 
            üìà <strong>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:</strong> –≤—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (BTC, S&P 500, VIX, DXY –∏ –¥—Ä—É–≥–∏–µ) |
            üïê <strong>–¢–∞–π–º—Ñ—Ä–µ–π–º—ã:</strong> –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É—é—Ç—Å—è –ø–æ –ø–æ–¥–¥–µ—Ä–∂–∫–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ç–æ–ª—å–∫–æ BTC –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 4H) |
            üîó <strong>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</strong> –≥—Ä–∞—Ñ–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –ø–æ –æ–±—â–µ–π –¥–∞—Ç–µ –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö
        </div>
        
        <div class="status" id="status">–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤...</div>
        
        <div class="chart-container" id="chart-container"></div>
    </div>

    <script>
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ config.js
        // CONFIG –¥–æ—Å—Ç—É–ø–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ

        // –î–∞—Ç—ã –æ–ø—Ä–µ–¥–µ–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –¥–∞–Ω–Ω—ã—Ö
        
        // –ö–µ—à –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –¥–∞—Ç–∞—Ö –Ω–∞—á–∞–ª–∞ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
        const instrumentDateCache = new Map();
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞—Ç–∞–º–∏
        const DateUtils = {
            toTimestamp: (date) => Math.floor(date.getTime() / 1000),
            fromTimestamp: (timestamp) => new Date(timestamp * 1000),
            toLocaleDateString: (timestamp, locale = 'ru-RU') => new Date(timestamp * 1000).toLocaleDateString(locale),
            getDaysSinceEpoch: (date) => Math.floor(date.getTime() / (24 * 60 * 60 * 1000))
        };
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞–º–∏
        const TimeframeUtils = {
            // –ú–∞–ø–∏–Ω–≥ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –≤ —Å—É—Ñ—Ñ–∏–∫—Å—ã –¥–ª—è —Ñ–∞–π–ª–æ–≤
            getFileSuffix: (timeframe) => {
                const mapping = { '240': '4H', 'D': '1D', '3D': '1D', 'W': '1W' };
                return mapping[timeframe] || '1D';
            },
            
            // –ú–∞–ø–∏–Ω–≥ —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –≤ –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç
            getDisplayText: (timeframe) => {
                const mapping = { '240': '4H', 'D': '1D', '3D': '3D', 'W': '1W' };
                return mapping[timeframe] || '1D';
            },
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω—É–∂–Ω–∞ –ª–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è –∏–∑ –¥–Ω–µ–≤–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            needsAggregation: (timeframe) => ['3D', 'W'].includes(timeframe),
            
            // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ API —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            getApiTimeframe: (timeframe) => {
                return TimeframeUtils.needsAggregation(timeframe) ? 'D' : timeframe;
            }
        };
        
        // –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –¥–∞–Ω–Ω—ã—Ö
        const DataUpdateUtils = {
            // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
            async updateStartDateAndReload(reason = '–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö') {
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const fromDateInput = document.getElementById('fromDate');
                const currentFromDate = fromDateInput.value;
                
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–∞—Ç—ã, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–µ
                if (!currentFromDate || new Date(currentFromDate) < new Date(commonStartDate)) {
                    fromDateInput.value = commonStartDate;
                    fromDate = commonStartDate;
                    console.log(`üìÖ Updated start date to: ${commonStartDate}`);
                    updateStatus(`–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞ –¥–æ ${DateUtils.toLocaleDateString(DateUtils.toTimestamp(new Date(commonStartDate)))} –∏–∑-–∑–∞ ${reason}`, 'info');
                }
                
                console.log('üîÑ Reloading data...');
                loadData();
            }
        };
        
        let chart = null;
        let candlestickSeries = null;
        let coinbaseLineSeries = null; // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º Coinbase Index
        let comparisonLineSeries = null; // –°–µ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏
        let currentMAPeriod = CONFIG.DEFAULT_MA_PERIOD;
        let currentTimeframe = 'W'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ–¥–µ–ª—å–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
        let currentComparisonInstrument = 'btc'; // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å Coinbase
        let fromDate = null;
        let toDate = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å CONFIG
            if (typeof CONFIG === 'undefined') {
                console.error('‚ùå CONFIG not loaded! Make sure config.js is loaded before this script.');
                updateStatus('–û—à–∏–±–∫–∞: —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å INSTRUMENTS –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
            if (!CONFIG.INSTRUMENTS || Object.keys(CONFIG.INSTRUMENTS).length === 0) {
                console.error('‚ùå INSTRUMENTS not configured! Make sure CONFIG.INSTRUMENTS is defined.');
                updateStatus('–û—à–∏–±–∫–∞: –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!CONFIG.INSTRUMENTS[currentComparisonInstrument]) {
                console.warn(`‚ö†Ô∏è Default comparison instrument '${currentComparisonInstrument}' not found, using first available instrument.`);
                currentComparisonInstrument = Object.keys(CONFIG.INSTRUMENTS).find(key => key !== 'coinbase') || 'btc';
                console.log(`üìä Switched to comparison instrument: ${currentComparisonInstrument}`);
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Lightweight Charts
            if (typeof LightweightCharts === 'undefined') {
                console.error('‚ùå LightweightCharts not loaded! Make sure the library is loaded.');
                updateStatus('–û—à–∏–±–∫–∞: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ Lightweight Charts –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error');
                return;
            }
            
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Å —Ç–µ–∫—É—â–∏–º –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º
            const comparisonSelect = document.getElementById('comparisonSelect');
            if (comparisonSelect) {
                comparisonSelect.value = currentComparisonInstrument;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            updateTimeframeSelector(currentComparisonInstrument);
            
            await initializeDates();
            initializeChart();
            setupEventHandlers();
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
            setTimeout(loadData, 100);
        });

        async function initializeDates() {
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: –∏—Å—Ö–æ–¥—è –∏–∑ –æ–±—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
            const today = new Date();
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è Coinbase –∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
            
            toDate = today.toISOString().split('T')[0];
            fromDate = commonStartDate;
            
            document.getElementById('fromDate').value = fromDate;
            document.getElementById('toDate').value = toDate;
            
            console.log(`üìÖ Default date range set based on common data availability: ${fromDate} to ${toDate}`);
            console.log(`‚ÑπÔ∏è Note: This is the latest start date among all data sources`);
            console.log(`üïê Default timeframe: ${currentTimeframe} (Weekly)`);
        }

        // ========================================
        // –†–ê–°–®–ò–†–ï–ù–ù–´–ï –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ò–ù–î–ò–ö–ê–¢–û–†–´
        // ========================================
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é Enhanced Technical Indicators –±–∏–±–ª–∏–æ—Ç–µ–∫—É
        
        function calculateMovingAverage(values, period, type = 'SMA') {
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            const data = values.map((value, index) => ({
                time: index,
                close: value
            }));
            
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
            switch (type.toUpperCase()) {
                case 'EMA':
                    return TechnicalIndicators.ema(data, period).map(item => item.value);
                case 'SMA':
                default:
                    return TechnicalIndicators.sma(data, period).map(item => item.value);
            }
        }

        function aggregateDataByTimeframe(data, timeframe) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π TimeScale API –≤–º–µ—Å—Ç–æ —Å–∞–º–æ–ø–∏—Å–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
            if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                return window.timeScaleManager.autoAggregateDataByVisibleRange(data, {
                    maxDataPoints: 1000,
                    minDataPoints: 100
                });
            } else {
                // Fallback –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é –∞–≥—Ä–µ–≥–∞—Ü–∏—é –µ—Å–ª–∏ TimeScale API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                return DataAggregator.aggregateTimeSeriesData(data, timeframe);
            }
        }



        // ================================================
        // –£–°–¢–ê–†–ï–í–®–ò–ï –§–£–ù–ö–¶–ò–ò –£–î–ê–õ–ï–ù–´ –ò –ó–ê–ú–ï–ù–ï–ù–´ –ù–ê 
        // –°–û–í–†–ï–ú–ï–ù–ù–´–ï –ò–ó optimized_utils.js
        // ================================================
        // –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≥—Ä–µ–≥–∞—Ü–∏–∏ —Ç–µ–ø–µ—Ä—å –≤ DataAggregator



        async function loadCSVData(filePath) {
            try {
                console.log(`üîç Loading CSV data from: ${filePath}`);
                const response = await fetch(filePath);
                
                if (!response.ok) {
                    throw new Error(`Failed to load ${filePath}: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                // –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å—ã –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
                const timeIdx = headers.findIndex(h => h.trim() === 'time');
                const closeIdx = headers.findIndex(h => h.trim() === 'close');
                
                if (timeIdx === -1 || closeIdx === -1) {
                    throw new Error('Required columns (time, close) not found in CSV');
                }
                
                const data = [];
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = line.split(',');
                    if (values.length < headers.length) continue;
                    
                    const time = parseInt(values[timeIdx]);
                    const close = parseFloat(values[closeIdx]);
                    
                    if (isNaN(time) || isNaN(close)) continue;
                    
                    data.push({
                        time: time,
                        value: close
                    });
                }
                
                console.log(`üìä Loaded ${data.length} data points from CSV`);
                return data;
                
            } catch (error) {
                console.error('‚ùå Error loading CSV data:', error);
                return [];
            }
        }

        async function getInstrumentFirstDate(instrumentKey, timeframe) {
            const cacheKey = `${instrumentKey}_${timeframe}`;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à
            if (instrumentDateCache.has(cacheKey)) {
                return instrumentDateCache.get(cacheKey);
            }
            
            try {
                const instrument = CONFIG.INSTRUMENTS[instrumentKey];
                if (!instrument) {
                    console.error(`‚ùå Unknown instrument: ${instrumentKey}`);
                    return null;
                }
                

                
                let firstTimestamp = null;
                
                if (instrument.dataSource === 'json') {
                    // –î–ª—è JSON –¥–∞–Ω–Ω—ã—Ö (Coinbase Index)
                    const response = await fetch(instrument.path);
                    if (response.ok) {
                        const jsonData = await response.json();
                        if (jsonData.data && jsonData.data.length > 0) {
                            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –≤–∞–ª–∏–¥–Ω—É—é –¥–∞—Ç—É
                            for (const item of jsonData.data) {
                                if (item.date && item.rank != null) {
                                    const timestamp = parseDateString(item.date);
                                    if (timestamp) {
                                        firstTimestamp = timestamp;
                                        break;
                                    }
                                }
                            }
                        }
                    }
                } else if (instrument.dataSource === 'csv') {
                    // –î–ª—è CSV –¥–∞–Ω–Ω—ã—Ö (–¥–ª—è 3D –∏—Å–ø–æ–ª—å–∑—É–µ–º 1D —Ñ–∞–π–ª—ã)
                    const timeframeSuffix = TimeframeUtils.getFileSuffix(timeframe);
                    const possibleFiles = [
                        `${instrument.path}TVC_${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`,
                        `${instrument.path}SP_${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`,
                        `${instrument.path}${instrumentKey.toUpperCase()}, ${timeframeSuffix}.csv`
                    ];
                    
                    for (const filePath of possibleFiles) {
                        try {
                            const response = await fetch(filePath);
                            if (response.ok) {
                                const csvText = await response.text();
                                const lines = csvText.split('\n');
                                
                                if (lines.length > 1) {
                                    const headers = lines[0].split(',');
                                    const timeIdx = headers.findIndex(h => h.trim() === 'time');
                                    
                                    if (timeIdx !== -1) {
                                        const firstDataLine = lines[1].split(',');
                                        if (firstDataLine.length > timeIdx) {
                                            const time = parseInt(firstDataLine[timeIdx]);
                                            if (!isNaN(time)) {
                                                firstTimestamp = time;
                                                break;
                                            }
                                        }
                                    }
                                }
                            }
                        } catch (error) {
                            continue; // –ü—Ä–æ–±—É–µ–º —Å–ª–µ–¥—É—é—â–∏–π —Ñ–∞–π–ª
                        }
                    }
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
                instrumentDateCache.set(cacheKey, firstTimestamp);
                
                if (firstTimestamp) {
                    console.log(`üìÖ First date for ${instrumentKey} (${timeframe}): ${DateUtils.toLocaleDateString(firstTimestamp)}`);
                }
                
                return firstTimestamp;
                
            } catch (error) {
                console.error(`‚ùå Error getting first date for ${instrumentKey}:`, error);
                return null;
            }
        }

        async function getCommonStartDate(comparisonInstrumentKey, timeframe) {
            try {
                console.log(`üîç Calculating common start date for Coinbase vs ${comparisonInstrumentKey} (${timeframe})`);
                
                const dates = [];
                
                // 1. –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ Coinbase Index (–≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è)
                const coinbaseStartTime = await getInstrumentFirstDate('coinbase', timeframe);
                if (coinbaseStartTime) {
                    dates.push(coinbaseStartTime);
                    console.log(`üìÖ Coinbase start date: ${DateUtils.toLocaleDateString(coinbaseStartTime)}`);
                }
                
                // 2. –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                const comparisonStartTime = await getInstrumentFirstDate(comparisonInstrumentKey, timeframe);
                if (comparisonStartTime) {
                    dates.push(comparisonStartTime);
                    console.log(`üìÖ ${comparisonInstrumentKey} start date: ${DateUtils.toLocaleDateString(comparisonStartTime)}`);
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –Ω–∞—Å –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–∞ –¥–∞—Ç–∞
                if (dates.length === 0) {
                    console.warn('‚ö†Ô∏è No valid start dates found, using default fallback');
                    return '2017-01-01'; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fallback
                }
                
                // –ë–µ—Ä–µ–º —Å–∞–º—É—é –ø–æ–∑–¥–Ω—é—é –¥–∞—Ç—É (–º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é)
                const commonStartTime = Math.max(...dates);
                const commonStartDate = new Date(commonStartTime * 1000).toISOString().split('T')[0];
                
                console.log(`‚úÖ Common start date: ${commonStartDate} (${DateUtils.toLocaleDateString(commonStartTime)})`);
                
                return commonStartDate;
                
            } catch (error) {
                console.error('‚ùå Error calculating common start date:', error);
                return '2017-01-01'; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π fallback
            }
        }

        async function loadCoinbaseData(fromTime, toTime) {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index –∏–∑ JSON
                const response = await fetch('/data/data.json');
                
                if (!response.ok) {
                    throw new Error(`Failed to load Coinbase data: ${response.status} ${response.statusText}`);
                }
                
                const jsonData = await response.json();
                
                if (!jsonData.data || !Array.isArray(jsonData.data)) {
                    console.error('‚ùå Invalid Coinbase data structure');
                    return;
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º JSON –¥–∞–Ω–Ω—ã–µ
                const allData = [];
                for (const item of jsonData.data) {
                    if (!item.date || item.rank == null) continue;

                    const timestamp = parseDateString(item.date);
                    if (!timestamp) continue;

                    allData.push({
                        time: timestamp,
                        value: parseFloat(item.rank),
                    });
                }

                if (allData.length === 0) {
                    console.error('‚ùå No valid Coinbase data found');
                    return;
                }

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
                allData.sort((a, b) => a.time - b.time);
                console.log(`üìä Sorted ${allData.length} Coinbase data points`);

                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º moving average
                const rawValues = allData.map(item => item.value);
                const maValues = calculateMovingAverage(rawValues, currentMAPeriod);
                
                // –°–æ–∑–¥–∞—ë–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                let maData = [];
                const startIndex = currentMAPeriod - 1;
                
                for (let i = 0; i < maValues.length; i++) {
                    const originalIndex = startIndex + i;
                    if (originalIndex < allData.length) {
                        maData.push({
                            time: allData[originalIndex].time,
                            value: maValues[i]
                        });
                    }
                }

                // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞–π–º—Ñ—Ä–µ–π–º—É
                maData = aggregateDataByTimeframe(maData, currentTimeframe);
                
                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
                const filteredData = maData.filter(item => item.time >= fromTime && item.time <= toTime);

                // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ (—á–µ–º –º–µ–Ω—å—à–µ —Ä–∞–Ω–≥, —Ç–µ–º –ª—É—á—à–µ)
                if (filteredData.length > 0) {
                    const maxRank = Math.max(...filteredData.map(d => d.value));
                    const invertedData = filteredData.map(item => ({
                        ...item,
                        value: maxRank - item.value + 1
                    }));

                    coinbaseLineSeries.setData(invertedData);
                    console.log(`üîÑ Coinbase chart updated with ${invertedData.length} points (MA${currentMAPeriod}, ${currentTimeframe})`);
                }

            } catch (error) {
                console.error('‚ùå Error loading Coinbase data:', error);
            }
        }

        async function loadComparisonInstrumentData(fromTime, toTime) {
            try {
                const instrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (!instrument) {
                    console.error(`‚ùå Unknown comparison instrument: ${currentComparisonInstrument}`);
                    return;
                }

                let data = [];

                if (instrument.dataSource === 'api') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ API (–¥–ª—è BTC)
                    data = await loadAPIData(instrument, fromTime, toTime);
                } else if (instrument.dataSource === 'csv') {
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ CSV —Ñ–∞–π–ª–æ–≤
                    data = await loadInstrumentCSVData(instrument);
                    
                    // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –¥–∞—Ç–∞–º
                    if (data.length > 0) {
                        data = data.filter(item => item.time >= fromTime && item.time <= toTime);
                    }
                }

                if (data.length === 0) {
                    console.warn(`‚ö†Ô∏è No data loaded for ${instrument.name}`);
                    return;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ—Ä–∏—é
                if (instrument.seriesType === 'candlestick' && candlestickSeries) {
                    candlestickSeries.setData(data);
                } else if (comparisonLineSeries) {
                    comparisonLineSeries.setData(data);
                }

                console.log(`‚úÖ ${instrument.name} data loaded: ${data.length} points`);

            } catch (error) {
                console.error('‚ùå Error loading comparison instrument data:', error);
            }
        }

        async function loadAPIData(instrument, fromTime, toTime) {
            try {
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º API —Ç–∞–π–º—Ñ—Ä–µ–π–º (API –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ >= 4H)
                const apiTimeframe = TimeframeUtils.getApiTimeframe(currentTimeframe);
                
                if (TimeframeUtils.needsAggregation(currentTimeframe)) {
                    console.log(`üìä Loading 1D API data for ${currentTimeframe} timeframe (will be aggregated locally)`);
                }
                
                const apiUrl = `${CONFIG.API_BASE_URL}/history?symbol=${instrument.apiSymbol}&resolution=${apiTimeframe}&from=${fromTime}&to=${toTime}`;
                console.log(`üîó API URL: ${apiUrl}`);
                
                const response = await fetch(apiUrl);
                const apiData = await response.json();
                
                console.log('üìä API Response:', apiData);

                if (apiData.s === 'ok' && apiData.t && apiData.o && apiData.h && apiData.l && apiData.c) {
                    let candleData = [];
                    for (let i = 0; i < apiData.t.length; i++) {
                        if (apiData.t[i] && apiData.o[i] != null && apiData.h[i] != null && 
                            apiData.l[i] != null && apiData.c[i] != null) {
                            candleData.push({
                                time: apiData.t[i],
                                open: parseFloat(apiData.o[i]),
                                high: parseFloat(apiData.h[i]),
                                low: parseFloat(apiData.l[i]),
                                close: parseFloat(apiData.c[i]),
                            });
                        }
                    }

                    // –ê–≥—Ä–µ–≥–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
                    if (currentTimeframe === 'W' && apiTimeframe === 'D') {
                        candleData = DataAggregator.aggregateTimeSeriesData(candleData, 'W');
                        console.log(`üìä API data aggregated to weekly: ${candleData.length} candles`);
                    } else if (currentTimeframe === '3D' && apiTimeframe === 'D') {
                        candleData = DataAggregator.aggregateTimeSeriesData(candleData, '3D');
                        console.log(`üìä API data aggregated to 3-day: ${candleData.length} candles`);
                    }

                    return candleData;
                } else {
                    console.error('‚ùå Failed to load API data:', apiData);
                    return [];
                }

            } catch (error) {
                console.error('‚ùå Error loading API data:', error);
                return [];
            }
        }

        async function loadInstrumentCSVData(instrument) {
            try {
                // –î–ª—è 3D —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–Ω–µ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∞–≥—Ä–µ–≥–∏—Ä—É–µ–º –∏—Ö –ª–æ–∫–∞–ª—å–Ω–æ
                const timeframeSuffix = TimeframeUtils.getFileSuffix(currentTimeframe);
                
                if (currentTimeframe === '3D') {
                    console.log(`üìä Loading 1D CSV data for 3D timeframe (will be aggregated locally)`);
                }
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞–∑–≤–∞–Ω–∏–π —Ñ–∞–π–ª–æ–≤
                const possibleFiles = [
                    `${instrument.path}TVC_${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`,
                    `${instrument.path}SP_${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`,
                    `${instrument.path}${currentComparisonInstrument.toUpperCase()}, ${timeframeSuffix}.csv`
                ];
                
                for (const filePath of possibleFiles) {
                    const data = await loadCSVData(filePath);
                    if (data.length > 0) {
                        // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º moving average –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                        if (currentMAPeriod > 1) {
                            const rawValues = data.map(item => item.value);
                            const maValues = calculateMovingAverage(rawValues, currentMAPeriod);
                            
                            const maData = [];
                            const startIndex = currentMAPeriod - 1;
                            
                            for (let i = 0; i < maValues.length; i++) {
                                const originalIndex = startIndex + i;
                                if (originalIndex < data.length) {
                                    maData.push({
                                        time: data[originalIndex].time,
                                        value: maValues[i]
                                    });
                                }
                            }
                            
                            return aggregateDataByTimeframe(maData, currentTimeframe);
                        } else {
                            return aggregateDataByTimeframe(data, currentTimeframe);
                        }
                    }
                }
                
                return [];

            } catch (error) {
                console.error('‚ùå Error loading CSV instrument data:', error);
                return [];
            }
        }



        function createComparisonSeries() {
            try {
                // –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å–µ—Ä–∏—é —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –µ—Å–ª–∏ –æ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (comparisonLineSeries) {
                    chart.removeSeries(comparisonLineSeries);
                    comparisonLineSeries = null;
                }
                if (candlestickSeries) {
                    chart.removeSeries(candlestickSeries);
                    candlestickSeries = null;
                }
                
                const comparisonInstrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (!comparisonInstrument) {
                    console.error(`‚ùå Unknown comparison instrument: ${currentComparisonInstrument}`);
                    return;
                }
                
                if (comparisonInstrument.seriesType === 'candlestick') {
                    // –°–æ–∑–¥–∞–µ–º —Å–≤–µ—á–Ω—É—é —Å–µ—Ä–∏—é (–¥–ª—è BTC)
                    candlestickSeries = chart.addSeries(LightweightCharts.CandlestickSeries, {
                        upColor: comparisonInstrument.color,
                        downColor: '#FF4976',
                        borderVisible: false,
                        wickUpColor: comparisonInstrument.color,
                        wickDownColor: '#FF4976',
                        priceScaleId: 'right',
                    });
                } else {
                    // –°–æ–∑–¥–∞–µ–º –ª–∏–Ω–µ–π–Ω—É—é —Å–µ—Ä–∏—é (–¥–ª—è –¥—Ä—É–≥–∏—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)
                    comparisonLineSeries = chart.addSeries(LightweightCharts.LineSeries, {
                        color: comparisonInstrument.color,
                        lineWidth: 2,
                        lineStyle: LightweightCharts.LineStyle.Solid,
                        lineType: LightweightCharts.LineType.Simple,
                        crosshairMarkerVisible: true,
                        crosshairMarkerRadius: 6,
                        crosshairMarkerBorderColor: comparisonInstrument.color,
                        crosshairMarkerBackgroundColor: '#FFFFFF',
                        lastValueVisible: true,
                        priceLineVisible: true,
                        priceScaleId: 'right',
                    });
                }
                
                console.log(`‚úÖ Created ${comparisonInstrument.seriesType} series for ${comparisonInstrument.name}`);
                
            } catch (error) {
                console.error('‚ùå Error creating comparison series:', error);
            }
        }

        function parseDateString(dateStr) {
            try {
                // –ü–∞—Ä—Å–∏–º —Å—Ç—Ä–æ–∫—É —Ç–∏–ø–∞ "Fri, Jul 4, 25"
                const parts = dateStr.split(',').map(s => s.trim());
                if (parts.length !== 3) return null;

                const monthDay = parts[1]; // "Jul 4"
                const year = parts[2]; // "25"

                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∫–æ—Ä–æ—Ç–∫–∏–π –≥–æ–¥ –≤ –ø–æ–ª–Ω—ã–π
                const fullYear = year.length === 2 ? '20' + year : year;

                // –°–æ–∑–¥–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∞—Ç—É
                const fullDate = `${monthDay}, ${fullYear}`;
                const date = new Date(fullDate);

                if (isNaN(date.getTime())) return null;

                return DateUtils.toTimestamp(date);
            } catch (error) {
                console.warn('‚ö†Ô∏è Error parsing date:', dateStr, error);
                return null;
            }
        }

        function initializeChart() {
            try {
                const container = document.getElementById('chart-container');
                
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 600,
                    layout: {
                        background: { color: '#131722' },
                        textColor: '#d1d4dc',
                        fontSize: 11,
                        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    },
                    grid: {
                        vertLines: { 
                            color: '#2a2e39',
                            style: LightweightCharts.LineStyle.Solid,
                        },
                        horzLines: { 
                            color: '#2a2e39',
                            style: LightweightCharts.LineStyle.Solid,
                        },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                        vertLine: {
                            color: '#758696',
                            width: 1,
                            style: LightweightCharts.LineStyle.Solid,
                            labelBackgroundColor: '#363a45',
                        },
                        horzLine: {
                            color: '#758696',
                            width: 1,
                            style: LightweightCharts.LineStyle.Solid,
                            labelBackgroundColor: '#363a45',
                        },
                    },
                    rightPriceScale: {
                        borderColor: '#2a2e39',
                        textColor: '#d1d4dc',
                        autoScale: true,
                        mode: LightweightCharts.PriceScaleMode.Normal,
                        invertScale: false,
                        alignLabels: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                        borderVisible: true,
                        entireTextOnly: false,
                        visible: true,
                        drawTicks: true,
                        ticksVisible: true,
                    },
                    leftPriceScale: {
                        visible: true,
                        borderColor: '#2a2e39',
                        textColor: '#d1d4dc',
                        mode: LightweightCharts.PriceScaleMode.Normal,
                        invertScale: true, // –ò–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–ª—è —Ä–∞–Ω–≥–æ–≤ (–º–µ–Ω—å—à–∏–π —Ä–∞–Ω–≥ = –≤—ã—à–µ)
                        autoScale: true,
                        alignLabels: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                        borderVisible: true,
                        entireTextOnly: false,
                        drawTicks: true,
                        ticksVisible: true,
                    },
                    timeScale: {
                        borderColor: '#2a2e39',
                        textColor: '#d1d4dc',
                        timeVisible: true,
                        secondsVisible: false,
                        borderVisible: true,
                        rightOffset: 12,
                        barSpacing: 3,           // –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É –±–∞—Ä–∞–º–∏ –¥–ª—è –±–æ–ª—å—à–µ–π –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏
                        minBarSpacing: 0.5,      // –ï—â–µ –±–æ–ª—å—à–µ —É–º–µ–Ω—å—à–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ
                        fixLeftEdge: false,      // –ü–æ–∑–≤–æ–ª—è–µ–º —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å –ª–µ–≤—ã–π –∫—Ä–∞–π
                        fixRightEdge: false,     // –ü–æ–∑–≤–æ–ª—è–µ–º —Å–≤–æ–±–æ–¥–Ω–æ –ø—Ä–æ–∫—Ä—É—á–∏–≤–∞—Ç—å –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
                        lockVisibleTimeRangeOnResize: false,
                        rightBarStaysOnScroll: false,  // –†–∞–∑—Ä–µ—à–∞–µ–º —Å–≤–æ–±–æ–¥–Ω—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
                        allowBoldLabels: true,
                        visible: true,
                        ticksVisible: true,
                        shiftVisibleRangeOnNewBar: false,  // –ù–µ —Å–¥–≤–∏–≥–∞–µ–º –ø—Ä–∏ –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        tickMarkFormatter: (time) => {
                            const date = new Date(time * 1000);
                            return date.toLocaleDateString('ru-RU', { 
                                month: 'short', 
                                day: 'numeric' 
                            });
                        },
                    },
                    handleScroll: {
                        mouseWheel: true,          // –ö–æ–ª–µ—Å–∏–∫–æ –º—ã—à–∏ –¥–ª—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
                        pressedMouseMove: true,    // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ–º
                        horzTouchDrag: true,       // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ —Å–µ–Ω—Å–æ—Ä–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                        vertTouchDrag: false,      // –û—Ç–∫–ª—é—á–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–æ
                    },
                    handleScale: {
                        axisPressedMouseMove: {    // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–µ–π –º—ã—à—å—é
                            time: true,
                            price: true,
                        },
                        mouseWheel: true,          // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–ª–µ—Å–∏–∫–æ–º –º—ã—à–∏
                        pinch: true,              // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∏–Ω—á–µ–º –Ω–∞ —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
                        axisDoubleClickReset: {   // –°–±—Ä–æ—Å –º–∞—Å—à—Ç–∞–±–∞ –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º
                            time: true,
                            price: true,
                        },
                    },
                    kineticScroll: {              // –î–æ–±–∞–≤–ª—è–µ–º –∫–∏–Ω–µ—Ç–∏—á–µ—Å–∫—É—é –ø—Ä–æ–∫—Ä—É—Ç–∫—É
                        touch: true,
                        mouse: false,
                    },
                });

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API Lightweight Charts
                if (!LightweightCharts.CandlestickSeries || !LightweightCharts.LineSeries) {
                    throw new Error('Required chart series types are not available');
                }

                // –°–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏—é –¥–ª—è Coinbase Index (–≤—Å–µ–≥–¥–∞ –Ω–∞ –ª–µ–≤–æ–π –æ—Å–∏)
                coinbaseLineSeries = chart.addSeries(LightweightCharts.LineSeries, {
                    color: '#2962FF',
                    lineWidth: 2,
                    lineStyle: LightweightCharts.LineStyle.Solid,
                    lineType: LightweightCharts.LineType.Simple,
                    crosshairMarkerVisible: true,
                    crosshairMarkerRadius: 6,
                    crosshairMarkerBorderColor: '#2962FF',
                    crosshairMarkerBackgroundColor: '#FFFFFF',
                    lastValueVisible: true,
                    priceLineVisible: true,
                    priceScaleId: 'left',
                });

                // –°–µ—Ä–∏—è –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                createComparisonSeries();

                if (!coinbaseLineSeries) {
                    throw new Error('Failed to create Coinbase series');
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                window.indicatorsManager = new IndicatorsManager(chart);
                console.log('‚úÖ Technical Indicators Manager initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ TimeScale API –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–∞–º–æ–ø–∏—Å–Ω–æ–π –∞–≥—Ä–µ–≥–∞—Ü–∏–∏
                window.timeScaleManager = new TimeScaleManager(chart);
                console.log('‚úÖ TimeScale Manager initialized - legacy aggregation replaced');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π Lightweight Charts
                window.advancedFeatures = new AdvancedChartFeatures(chart);
                console.log('‚úÖ Advanced Chart Features initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ç–∏–º–∏–∑–∞—Ç–æ—Ä–∞ UDF datafeed
                window.datafeedOptimizer = new DatafeedOptimizer();
                console.log('‚úÖ Datafeed Optimizer initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Events API –∏ Export Features
                window.eventsAndExport = new ChartEventsAndExport(chart);
                console.log('‚úÖ Events & Export initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–µ—Ä–∏–π –∏ Price Scale
                window.advancedSeriesAndScale = new AdvancedSeriesAndScale(chart);
                console.log('‚úÖ Advanced Series & Scale initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö –∏ –∞–¥–∞–ø—Ç–∏–≤–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π
                window.mobileResponsive = new MobileResponsiveChart(chart, container);
                console.log('‚úÖ Mobile & Responsive initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Candlestick & Bar Series
                window.candlestickBarSeries = new CandlestickBarSeries(chart);
                console.log('‚úÖ Candlestick & Bar Series initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Advanced Time Features
                window.advancedTimeFeatures = new AdvancedTimeFeatures(chart);
                console.log('‚úÖ Advanced Time Features initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Performance Optimizations
                window.performanceOptimizations = new PerformanceOptimizations(chart);
                console.log('‚úÖ Performance Optimizations initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Animation Effects
                window.animationEffects = new AnimationEffects(chart, container);
                console.log('‚úÖ Animation Effects initialized');

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Custom Crosshair
                window.customCrosshair = new CustomCrosshair(chart);
                console.log('‚úÖ Custom Crosshair initialized');

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                window.addEventListener('resize', () => {
                    chart.applyOptions({ width: container.clientWidth });
                });

                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ª–µ–≤–æ–π –∏ –ø—Ä–∞–≤–æ–π —à–∫–∞–ª
                setupScaleSynchronization();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                setTimeout(() => {
                    if (chart) {
                        chart.timeScale().fitContent();
                        console.log('üìä Initial chart fit applied');
                    }
                }, 100);

                console.log('‚úÖ Lightweight Charts initialized');
                updateStatus('–ì—Ä–∞—Ñ–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'success');

            } catch (error) {
                console.error('‚ùå Chart initialization failed:', error);
                updateStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≥—Ä–∞—Ñ–∏–∫–∞', 'error');
            }
        }

        async function loadData() {
            try {
                updateStatus(CONFIG.MESSAGES.LOADING, 'info');

                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–∞—Ç—ã
                const fromDateValue = document.getElementById('fromDate').value;
                const toDateValue = document.getElementById('toDate').value;
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ–±—â—É—é –Ω–∞—á–∞–ª—å–Ω—É—é –¥–∞—Ç—É –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const commonStartTime = DateUtils.toTimestamp(new Date(commonStartDate));
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã –≤ timestamp —Å —É—á–µ—Ç–æ–º –æ–±—â–µ–π –Ω–∞—á–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã
                const requestedFromTime = fromDateValue ? DateUtils.toTimestamp(new Date(fromDateValue)) : commonStartTime;
                const effectiveFromTime = Math.max(requestedFromTime, commonStartTime); // –ù–µ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–∞—Ç—ã
                const toTime = toDateValue ? DateUtils.toTimestamp(new Date(toDateValue + 'T23:59:59')) : DateUtils.toTimestamp(new Date());
                
                console.log(`üìÖ Requested from: ${DateUtils.toLocaleDateString(requestedFromTime)}`);
                console.log(`üìÖ Common start: ${DateUtils.toLocaleDateString(commonStartTime)}`);
                console.log(`üìÖ Effective from: ${DateUtils.toLocaleDateString(effectiveFromTime)}`);
                console.log(`üìÖ To: ${DateUtils.toLocaleDateString(toTime)}`);
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—É—é –¥–∞—Ç—É –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                const fromTime = effectiveFromTime;

                // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
                const timeframeSelect = document.getElementById('timeframeSelect');
                currentTimeframe = timeframeSelect ? timeframeSelect.value : 'W';
                
                // 1. –í—Å–µ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index
                console.log('üìä Loading Coinbase Index data...');
                await loadCoinbaseData(fromTime, toTime);
                
                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                console.log(`üìä Loading comparison instrument: ${CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name}...`);
                await loadComparisonInstrumentData(fromTime, toTime);

                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É
                updateLegend();
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–≥–æ–Ω—è–µ–º –≥—Ä–∞—Ñ–∏–∫ –ø–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                setTimeout(() => {
                    refreshChart();
                }, 300);
                
                setTimeout(() => {
                    refreshChart();
                }, 800);
                
                // –§–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞
                setTimeout(() => {
                    fitAllContent();
                }, 1200);
                
                const timeframeText = TimeframeUtils.getDisplayText(currentTimeframe);
                const coinbaseName = CONFIG.INSTRUMENTS['coinbase']?.name || 'Coinbase';
                const comparisonName = CONFIG.INSTRUMENTS[currentComparisonInstrument]?.name || 'Unknown';
                const commonDate = DateUtils.toLocaleDateString(commonStartTime);
                updateStatus(`${CONFIG.MESSAGES.SUCCESS}: ${coinbaseName} vs ${comparisonName} (MA${currentMAPeriod}, ${timeframeText}) | –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å ${commonDate}`, 'success');

            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                updateStatus(CONFIG.MESSAGES.ERROR, 'error');
            }
        }



        function setupScaleSynchronization() {
            if (!chart) return;
            
            try {
                // –û—Ç–∫–ª—é—á–∞–µ–º –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ø—Ä–æ–±–ª–µ–º–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
                // –∫–æ—Ç–æ—Ä–∞—è –º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è
                
                console.log('‚úÖ Scale synchronization setup completed (minimal)');
            } catch (error) {
                console.warn('‚ö†Ô∏è Scale synchronization not available:', error);
            }
        }

        function refreshChart() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot refresh');
                return;
            }
            
            try {
                console.log('üîÑ Refreshing chart layout...');
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–¥–≥–æ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —à–∫–∞–ª—É
                const timeScale = chart.timeScale();
                timeScale.fitContent();
                
                // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã
                const container = document.getElementById('chart-container');
                if (container) {
                    chart.resize(container.clientWidth, 600);
                }
                
                // –ê–≤—Ç–æ–º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω–æ–≤—ã—Ö —à–∫–∞–ª —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                    console.log('üìä BTC price scale (right) refreshed');
                }
                
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                    console.log('üìä Instrument price scale (left) refreshed');
                }
                
                // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                setTimeout(() => {
                    timeScale.fitContent();
                }, 50);
                
                console.log('‚úÖ Chart refreshed successfully');
            } catch (error) {
                console.warn('‚ö†Ô∏è Error refreshing chart:', error);
            }
        }

        function setOptimalInitialRange() {
            if (!chart) return;
            
            try {
                console.log('üéØ Setting optimal initial time range...');
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞
                const now = Math.floor(Date.now() / 1000);
                const twoYearsAgo = now - (2 * 365 * 24 * 60 * 60); // 2 –≥–æ–¥–∞ –Ω–∞–∑–∞–¥
                
                const timeScale = chart.timeScale();
                timeScale.setVisibleRange({
                    from: twoYearsAgo,
                    to: now
                });
                
                console.log('üìä Initial range set to last 2 years for better visibility');
            } catch (error) {
                console.warn('‚ö†Ô∏è Could not set initial range:', error);
            }
        }

        function resetAllScaling() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot reset scaling');
                return;
            }
            
            try {
                console.log('üîÑ Resetting all chart scaling...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º TimeScale Manager –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                    window.timeScaleManager.resetTimeScale();
                } else {
                    // Fallback –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤
                    const timeScale = chart.timeScale();
                    if (timeScale.resetTimeScale) {
                        timeScale.resetTimeScale();
                    } else {
                        timeScale.fitContent();
                    }
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–∞–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É (BTC)
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                }
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ª–µ–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É (–≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç)
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                        scaleMargins: {
                            top: 0.08,
                            bottom: 0.08,
                        },
                    });
                }
                
                console.log('‚úÖ All scaling reset successfully');
                updateStatus('–ú–∞—Å—à—Ç–∞–± –≤—Å–µ—Ö –æ—Å–µ–π —Å–±—Ä–æ—à–µ–Ω', 'success');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error resetting scaling:', error);
                updateStatus('–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ –º–∞—Å—à—Ç–∞–±–∞', 'error');
            }
        }

        function fitAllContent() {
            if (!chart) {
                console.warn('‚ö†Ô∏è Chart not initialized, cannot fit content');
                return;
            }
            
            try {
                console.log('üîÑ Fitting all content...');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º TimeScale Manager –¥–ª—è –ø–æ–¥–≥–æ–Ω–∫–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ–π —à–∫–∞–ª—ã
                if (window.timeScaleManager && window.timeScaleManager.isInitialized) {
                    window.timeScaleManager.fitContent();
                } else {
                    // Fallback –Ω–∞ –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤
                    chart.timeScale().fitContent();
                }
                
                // –ü–æ–¥–≥–æ–Ω—è–µ–º –ø—Ä–∞–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É
                const rightPriceScale = chart.priceScale('right');
                if (rightPriceScale) {
                    rightPriceScale.applyOptions({
                        autoScale: true,
                    });
                }
                
                // –ü–æ–¥–≥–æ–Ω—è–µ–º –ª–µ–≤—É—é —Ü–µ–Ω–æ–≤—É—é —à–∫–∞–ª—É  
                const leftPriceScale = chart.priceScale('left');
                if (leftPriceScale) {
                    leftPriceScale.applyOptions({
                        autoScale: true,
                    });
                }
                
                console.log('‚úÖ All content fitted successfully');
                updateStatus('–í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥–æ–≥–Ω–∞–Ω—ã –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –≥—Ä–∞—Ñ–∏–∫–∞', 'success');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Error fitting content:', error);
                updateStatus('–û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ–Ω–∫–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ', 'error');
            }
        }

        function setupEventHandlers() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const requiredElements = ['comparisonSelect', 'timeframeSelect', 'maPeriodSelect', 'fromDate', 'toDate', 'resetScale', 'fitContent'];
            for (const elementId of requiredElements) {
                if (!document.getElementById(elementId)) {
                    console.error(`‚ùå Required DOM element not found: ${elementId}`);
                    updateStatus(`–û—à–∏–±–∫–∞: —ç–ª–µ–º–µ–Ω—Ç ${elementId} –Ω–µ –Ω–∞–π–¥–µ–Ω`, 'error');
                    return;
                }
            }
            
            // –°–º–µ–Ω–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            document.getElementById('comparisonSelect').addEventListener('change', async (e) => {
                currentComparisonInstrument = e.target.value;
                console.log(`üìä Comparison instrument changed to: ${currentComparisonInstrument}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤ –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                updateTimeframeSelector(currentComparisonInstrument);
                
                // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Å–µ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                createComparisonSeries();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
                await DataUpdateUtils.updateStartDateAndReload('–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
            
            // –°–º–µ–Ω–∞ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
            document.getElementById('timeframeSelect').addEventListener('change', async (e) => {
                currentTimeframe = e.target.value;
                console.log(`üìä Timeframe changed to: ${currentTimeframe}`);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—Ç—É –Ω–∞—á–∞–ª–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º–∞
                await DataUpdateUtils.updateStartDateAndReload('–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö');
            });
            
            // –°–º–µ–Ω–∞ –ø–µ—Ä–∏–æ–¥–∞ MA
            document.getElementById('maPeriodSelect').addEventListener('change', (e) => {
                currentMAPeriod = parseInt(e.target.value);
                loadData();
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –¥–∞—Ç
            document.getElementById('fromDate').addEventListener('change', async (e) => {
                const selectedDate = e.target.value;
                console.log(`üìÖ FROM date changed to: ${selectedDate}`);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—â—É—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
                const commonStartDate = await getCommonStartDate(currentComparisonInstrument, currentTimeframe);
                const commonStartTime = new Date(commonStartDate);
                const selectedTime = new Date(selectedDate);
                
                if (selectedTime < commonStartTime) {
                    console.warn(`‚ö†Ô∏è Selected date (${selectedDate}) is before common data availability (${commonStartDate})`);
                    updateStatus(`–í—ã–±—Ä–∞–Ω–Ω–∞—è –¥–∞—Ç–∞ —Ä–∞–Ω—å—à–µ –æ–±—â–µ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö (—Å ${DateUtils.toLocaleDateString(DateUtils.toTimestamp(new Date(commonStartDate)))}). –î–∞—Ç–∞ –±—É–¥–µ—Ç —Å–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞.`, 'info');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                    e.target.value = commonStartDate;
                    fromDate = commonStartDate;
                } else {
                    fromDate = selectedDate;
                }
                
                console.log('üîÑ Reloading data with new date range...');
                loadData();
            });

            document.getElementById('toDate').addEventListener('change', (e) => {
                toDate = e.target.value;
                console.log(`üìÖ TO date changed to: ${toDate}`);
                console.log('üîÑ Reloading data with new date range...');
                loadData();
            });

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º
            document.getElementById('resetScale').addEventListener('click', () => {
                console.log('üîÑ Reset scale button clicked');
                resetAllScaling();
            });

            document.getElementById('fitContent').addEventListener('click', () => {
                console.log('üìè Fit content button clicked');
                fitAllContent();
            });

            // –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            document.getElementById('addIndicator').addEventListener('click', () => {
                addSelectedIndicator();
            });

            // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
            document.getElementById('quickTimeRange').addEventListener('change', (e) => {
                handleQuickTimeRangeSelection(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
            document.getElementById('toggleTheme').addEventListener('click', () => {
                toggleChartTheme();
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∫–∏
            document.getElementById('toggleGrid').addEventListener('click', () => {
                toggleChartGrid();
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω–µ–π —Ü–µ–Ω
            document.getElementById('addPriceLevels').addEventListener('change', (e) => {
                handlePriceLevelAdd(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–∞—Å—à—Ç–∞–±–æ–º
            document.addEventListener('keydown', (e) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –Ω–µ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—è –≤–≤–æ–¥–∞
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') {
                    return;
                }
                
                switch (e.key) {
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        console.log('‚å®Ô∏è Reset scale hotkey pressed (R)');
                        resetAllScaling();
                        break;
                    case 'f':
                    case 'F':
                        e.preventDefault();
                        console.log('‚å®Ô∏è Fit content hotkey pressed (F)');
                        fitAllContent();
                        break;
                    case 'F11':
                        e.preventDefault();
                        console.log('‚å®Ô∏è Fullscreen hotkey pressed (F11)');
                        handleToggleFullscreen();
                        break;
                }
            });

            // ===============================================
            // –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ù–û–í–´–• –§–£–ù–ö–¶–ò–ô
            // ===============================================

            // –≠–∫—Å–ø–æ—Ä—Ç
            document.getElementById('exportOptions').addEventListener('change', (e) => {
                handleExportAction(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–∏–π
            document.getElementById('seriesOptions').addEventListener('change', (e) => {
                handleSeriesAdd(e.target.value);
                e.target.value = ''; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
            });

            // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ —à–∫–∞–ª—ã —Ü–µ–Ω
            document.getElementById('priceScaleMode').addEventListener('change', (e) => {
                handlePriceScaleModeChange(e.target.value);
            });

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            document.getElementById('saveState').addEventListener('click', () => {
                handleSaveState();
            });

            // –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            document.getElementById('toggleFullscreen').addEventListener('click', () => {
                handleToggleFullscreen();
            });

            // Candlestick —Å–µ—Ä–∏–∏
            document.getElementById('candlestickOptions').addEventListener('change', (e) => {
                handleCandlestickAdd(e.target.value);
                e.target.value = '';
            });

            // –§—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
            document.getElementById('timeFeatures').addEventListener('change', (e) => {
                handleTimeFeature(e.target.value);
                e.target.value = '';
            });

            // –†–µ–∂–∏–º crosshair
            document.getElementById('crosshairMode').addEventListener('change', (e) => {
                handleCrosshairModeChange(e.target.value);
            });

            // –ê–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
            document.getElementById('animationEffects').addEventListener('change', (e) => {
                handleAnimationEffect(e.target.value);
                e.target.value = '';
            });

            // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π
            document.getElementById('toggleAnimations').addEventListener('click', () => {
                handleToggleAnimations();
            });

            console.log('‚úÖ All event handlers set up successfully');
        }

        function updateLegend() {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É Coinbase Index (–≤—Å–µ–≥–¥–∞ Coinbase)
            const coinbaseLegendElement = document.getElementById('coinbase-legend');
            const coinbaseLegendLineElement = document.querySelector('.legend-instrument');
            
            if (coinbaseLegendElement && coinbaseLegendLineElement) {
                const coinbaseInstrument = CONFIG.INSTRUMENTS['coinbase'];
                if (coinbaseInstrument) {
                    coinbaseLegendElement.textContent = coinbaseInstrument.name;
                    coinbaseLegendLineElement.style.background = `linear-gradient(135deg, ${coinbaseInstrument.color}, ${coinbaseInstrument.color}aa)`;
                }
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–µ–≥–µ–Ω–¥—É –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            const comparisonLegendElement = document.getElementById('comparison-legend');
            const comparisonLegendLineElement = document.querySelector('.legend-comparison');
            
            if (comparisonLegendElement && comparisonLegendLineElement) {
                const comparisonInstrument = CONFIG.INSTRUMENTS[currentComparisonInstrument];
                if (comparisonInstrument) {
                    comparisonLegendElement.textContent = comparisonInstrument.name;
                    comparisonLegendLineElement.style.background = `linear-gradient(135deg, ${comparisonInstrument.color}, ${comparisonInstrument.color}aa)`;
                }
            }
        }

        function getSupportedTimeframes(comparisonInstrumentKey) {
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã –¥–ª—è Coinbase –∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞
            const coinbaseInstrument = CONFIG.INSTRUMENTS['coinbase'];
            const comparisonInstrument = CONFIG.INSTRUMENTS[comparisonInstrumentKey];
            
            if (!coinbaseInstrument || !comparisonInstrument) {
                console.warn('‚ö†Ô∏è Instrument not found, returning default timeframes');
                return ['D', '3D', 'W']; // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π fallback
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            const coinbaseTimeframes = coinbaseInstrument.supportedTimeframes || ['D', '3D', 'W'];
            const comparisonTimeframes = comparisonInstrument.supportedTimeframes || ['D', '3D', 'W'];
            
            const supportedTimeframes = coinbaseTimeframes.filter(tf => comparisonTimeframes.includes(tf));
            
            console.log(`üìä Supported timeframes for ${comparisonInstrumentKey}:`, supportedTimeframes);
            return supportedTimeframes;
        }

        function updateTimeframeSelector(comparisonInstrumentKey) {
            const timeframeSelect = document.getElementById('timeframeSelect');
            if (!timeframeSelect) {
                console.warn('‚ö†Ô∏è Timeframe selector not found');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ç–∞–π–º—Ñ—Ä–µ–π–º—ã
            const supportedTimeframes = getSupportedTimeframes(comparisonInstrumentKey);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º
            const currentSelectedTimeframe = timeframeSelect.value;
            
            // –û—á–∏—â–∞–µ–º —Å–µ–ª–µ–∫—Ç–æ—Ä
            timeframeSelect.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö —Ç–∞–π–º—Ñ—Ä–µ–π–º–æ–≤
            const timeframeOptions = {
                '240': '4H',
                'D': '1D',
                '3D': '3D',
                'W': '1W'
            };
            
            supportedTimeframes.forEach(tf => {
                const option = document.createElement('option');
                option.value = tf;
                option.textContent = timeframeOptions[tf] || tf;
                timeframeSelect.appendChild(option);
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ç–∞–π–º—Ñ—Ä–µ–π–º, –µ—Å–ª–∏ –æ–Ω –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è
            if (supportedTimeframes.includes(currentSelectedTimeframe)) {
                timeframeSelect.value = currentSelectedTimeframe;
                currentTimeframe = currentSelectedTimeframe;
            } else {
                // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π —Ç–∞–π–º—Ñ—Ä–µ–π–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
                const newTimeframe = supportedTimeframes[0] || 'D';
                timeframeSelect.value = newTimeframe;
                currentTimeframe = newTimeframe;
                console.log(`üìä Timeframe changed to ${currentTimeframe} (${comparisonInstrumentKey} doesn't support ${currentSelectedTimeframe})`);
                updateStatus(`–¢–∞–π–º—Ñ—Ä–µ–π–º –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ ${currentTimeframe} (${comparisonInstrumentKey} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ${currentSelectedTimeframe})`, 'info');
            }
            
            console.log(`‚úÖ Timeframe selector updated for ${comparisonInstrumentKey}. Available: [${supportedTimeframes.join(', ')}], Selected: ${currentTimeframe}`);
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            if (!statusEl) {
                console.warn('‚ö†Ô∏è Status element not found, logging message:', message);
                return;
            }
            
            statusEl.textContent = message;
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –∫–ª–∞—Å—Å—ã
            statusEl.className = 'status';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –∫–ª–∞—Å—Å –¥–ª—è —Ç–∏–ø–∞
            switch (type) {
                case 'success':
                    statusEl.classList.add('success');
                    break;
                case 'error':
                    statusEl.classList.add('error');
                    break;
                case 'loading':
                    statusEl.classList.add('loading');
                    break;
                default:
                    statusEl.classList.add('info');
            }
        }

        // ===============================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ú–ò –ò–ù–î–ò–ö–ê–¢–û–†–ê–ú–ò
        // ===============================================

        function addSelectedIndicator() {
            const indicatorSelect = document.getElementById('indicatorSelect');
            const selectedType = indicatorSelect.value;
            
            if (!selectedType) {
                updateStatus('–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è', 'error');
                return;
            }
            
            if (!window.indicatorsManager) {
                updateStatus('–ú–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                return;
            }
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
            const chartData = getCombinedChartData();
            if (!chartData || chartData.length === 0) {
                updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞', 'error');
                return;
            }
            
            try {
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–µ–Ω–µ–¥–∂–µ—Ä –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                window.indicatorsManager.setData(chartData);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
                const defaultParams = getDefaultIndicatorParams(selectedType);
                const indicatorName = `${selectedType}_${Date.now()}`;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä
                const success = window.indicatorsManager.addIndicator(
                    indicatorName, 
                    selectedType, 
                    defaultParams
                );
                
                if (success) {
                    updateStatus(`‚úÖ –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä ${selectedType.toUpperCase()} –¥–æ–±–∞–≤–ª–µ–Ω`, 'success');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
                    indicatorSelect.value = '';
                } else {
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ ${selectedType}`, 'error');
                }
                
            } catch (error) {
                console.error('‚ùå Error adding indicator:', error);
                updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞: ${error.message}`, 'error');
            }
        }

        function getCombinedChartData() {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞ (comparison)
            if (comparisonLineSeries && comparisonLineSeries.data) {
                return comparisonLineSeries.data().map((item, index) => ({
                    time: item.time,
                    close: item.value,
                    high: item.value * 1.01,
                    low: item.value * 0.99,
                    open: item.value
                }));
            }
            
            // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ Coinbase Index
            if (coinbaseLineSeries && coinbaseLineSeries.data) {
                return coinbaseLineSeries.data().map((item, index) => ({
                    time: item.time,
                    close: item.value,
                    high: item.value * 1.01,
                    low: item.value * 0.99,
                    open: item.value
                }));
            }
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã
            console.warn('‚ö†Ô∏è No chart data available, generating test data');
            const testData = [];
            const startTime = Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60);
            
            for (let i = 0; i < 100; i++) {
                const time = startTime + (i * 24 * 60 * 60);
                const baseValue = 50000 + Math.sin(i * 0.1) * 10000;
                testData.push({
                    time: time,
                    close: baseValue,
                    high: baseValue * 1.02,
                    low: baseValue * 0.98,
                    open: baseValue
                });
            }
            
            return testData;
        }

        function getDefaultIndicatorParams(type) {
            switch (type.toLowerCase()) {
                case 'sma':
                case 'ema':
                    return { period: 14 };
                    
                case 'rsi':
                    return { period: 14 };
                    
                case 'macd':
                    return { fast: 12, slow: 26, signal: 9 };
                    
                case 'bollinger':
                case 'bb':
                    return { period: 20, stdDev: 2 };
                    
                case 'stochastic':
                case 'stoch':
                    return { k: 14, d: 3 };
                    
                case 'cbma14':
                    return { period: 14, smoothing: 3 };
                    
                default:
                    return { period: 14 };
            }
        }

        // ===============================================
        // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° TIMESCALE API
        // ===============================================

        function handleQuickTimeRangeSelection(range) {
            if (!range || !window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return;
            }
            
            try {
                switch (range) {
                    case '7days':
                        window.timeScaleManager.setLastNDays(7);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π', 'success');
                        break;
                        
                    case '30days':
                        window.timeScaleManager.setLastNDays(30);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π', 'success');
                        break;
                        
                    case '3months':
                        window.timeScaleManager.setLastNMonths(3);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞', 'success');
                        break;
                        
                    case '6months':
                        window.timeScaleManager.setLastNMonths(6);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤', 'success');
                        break;
                        
                    case '1year':
                        window.timeScaleManager.setLastNMonths(12);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥', 'success');
                        break;
                        
                    case '2years':
                        window.timeScaleManager.setLastNMonths(24);
                        updateStatus('–£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 2 –≥–æ–¥–∞', 'success');
                        break;
                        
                    case 'all':
                        window.timeScaleManager.fitContent();
                        updateStatus('–ü–æ–∫–∞–∑–∞–Ω—ã –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'success');
                        break;
                        
                    default:
                        console.warn('Unknown time range:', range);
                }
                
            } catch (error) {
                console.error('‚ùå Error setting time range:', error);
                updateStatus(`–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞: ${error.message}`, 'error');
            }
        }

        function getTimeScaleInfo() {
            if (!window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return null;
            }
            
            return window.timeScaleManager.getTimeScaleInfo();
        }

        function optimizeDataForCurrentView(data) {
            if (!window.timeScaleManager || !window.timeScaleManager.isInitialized) {
                return data;
            }
            
                         return window.timeScaleManager.optimizeDataForCurrentRange(data, {
                 maxDataPoints: 1000,
                 minDataPoints: 100,
                 bufferSeconds: 86400 // 1 –¥–µ–Ω—å –±—É—Ñ–µ—Ä
             });
         }

         // ===============================================
         // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ü–†–û–î–í–ò–ù–£–¢–´–ú–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–Ø–ú–ò
         // ===============================================

         function toggleChartTheme() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 updateStatus('–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'error');
                 return;
             }
             
             try {
                 const currentTheme = window.advancedFeatures.currentTheme;
                 const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                 
                 window.advancedFeatures.setTheme(newTheme);
                 updateStatus(`–¢–µ–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞: ${newTheme === 'light' ? '—Å–≤–µ—Ç–ª—É—é' : '—Ç—ë–º–Ω—É—é'}`, 'success');
                 
             } catch (error) {
                 console.error('‚ùå Theme toggle error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ç–µ–º—ã: ${error.message}`, 'error');
             }
         }

         function toggleChartGrid() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 updateStatus('–ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã', 'error');
                 return;
             }
             
             try {
                 window.advancedFeatures.toggleGrid();
                 updateStatus('–í–∏–¥–∏–º–æ—Å—Ç—å —Å–µ—Ç–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞', 'success');
                 
             } catch (error) {
                 console.error('‚ùå Grid toggle error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–µ—Ç–∫–∏: ${error.message}`, 'error');
             }
         }

         function handlePriceLevelAdd(levelType) {
             if (!levelType || !window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return;
             }
             
             try {
                 // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π
                 const currentPrice = getCurrentPrice();
                 if (!currentPrice) {
                     updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —É—Ä–æ–≤–Ω–µ–π', 'error');
                     return;
                 }
                 
                 switch (levelType) {
                     case 'support':
                         addSupportLevel(currentPrice);
                         break;
                         
                     case 'resistance':
                         addResistanceLevel(currentPrice);
                         break;
                         
                     case 'fibonacci':
                         addFibonacciLevels(currentPrice);
                         break;
                         
                     case 'pivot':
                         addPivotLevels(currentPrice);
                         break;
                         
                     default:
                         console.warn('Unknown level type:', levelType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Price level add error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è: ${error.message}`, 'error');
             }
         }

         function getCurrentPrice() {
             try {
                 // –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ü–µ–Ω—É –∏–∑ –¥–∞–Ω–Ω—ã—Ö —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                 if (comparisonLineSeries && comparisonLineSeries.data) {
                     const data = comparisonLineSeries.data();
                     if (data && data.length > 0) {
                         return data[data.length - 1].value;
                     }
                 }
                 
                 // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –∏–∑ –¥–∞–Ω–Ω—ã—Ö Coinbase
                 if (coinbaseLineSeries && coinbaseLineSeries.data) {
                     const data = coinbaseLineSeries.data();
                     if (data && data.length > 0) {
                         return data[data.length - 1].value;
                     }
                 }
                 
                 return null;
                 
             } catch (error) {
                 console.error('‚ùå Get current price error:', error);
                 return null;
             }
         }

         function addSupportLevel(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–∞ 5% –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
             const supportPrice = basePrice * 0.95;
             
             window.advancedFeatures.addPriceLine(series, supportPrice, {
                 color: '#00C851',
                 title: `–ü–æ–¥–¥–µ—Ä–∂–∫–∞: ${supportPrice.toFixed(2)}`,
                 id: `support_${Date.now()}`,
                 lineStyle: LightweightCharts.LineStyle.Dashed
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å –ø–æ–¥–¥–µ—Ä–∂–∫–∏: ${supportPrice.toFixed(2)}`, 'success');
         }

         function addResistanceLevel(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –î–æ–±–∞–≤–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –Ω–∞ 5% –≤—ã—à–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
             const resistancePrice = basePrice * 1.05;
             
             window.advancedFeatures.addPriceLine(series, resistancePrice, {
                 color: '#FF4444',
                 title: `–°–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ: ${resistancePrice.toFixed(2)}`,
                 id: `resistance_${Date.now()}`,
                 lineStyle: LightweightCharts.LineStyle.Dashed
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω —É—Ä–æ–≤–µ–Ω—å —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è: ${resistancePrice.toFixed(2)}`, 'success');
         }

         function addFibonacciLevels(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏
             const fibLevels = [0.236, 0.382, 0.5, 0.618, 0.786];
             const range = basePrice * 0.1; // 10% –¥–∏–∞–ø–∞–∑–æ–Ω
             
             fibLevels.forEach(level => {
                 const price = basePrice + (range * level) - (range * 0.5);
                 
                 window.advancedFeatures.addPriceLine(series, price, {
                     color: '#FFB74D',
                     title: `–§–∏–±–æ ${(level * 100).toFixed(1)}%: ${price.toFixed(2)}`,
                     id: `fib_${level}_${Date.now()}`,
                     lineWidth: 1,
                     lineStyle: LightweightCharts.LineStyle.Dotted
                 });
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω—ã —É—Ä–æ–≤–Ω–∏ –§–∏–±–æ–Ω–∞—á—á–∏ (${fibLevels.length})`, 'success');
         }

         function addPivotLevels(basePrice) {
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             // –ü—Ä–æ—Å—Ç—ã–µ –ø–∏–≤–æ—Ç —É—Ä–æ–≤–Ω–∏ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
             const pivot = basePrice;
             const range = basePrice * 0.02; // 2% –¥–∏–∞–ø–∞–∑–æ–Ω
             
             const levels = [
                 { price: pivot, label: 'Pivot', color: '#2962FF' },
                 { price: pivot + range, label: 'R1', color: '#FF6B6B' },
                 { price: pivot + range * 2, label: 'R2', color: '#FF6B6B' },
                 { price: pivot - range, label: 'S1', color: '#4ECDC4' },
                 { price: pivot - range * 2, label: 'S2', color: '#4ECDC4' }
             ];
             
             levels.forEach(level => {
                 window.advancedFeatures.addPriceLine(series, level.price, {
                     color: level.color,
                     title: `${level.label}: ${level.price.toFixed(2)}`,
                     id: `pivot_${level.label}_${Date.now()}`,
                     lineWidth: level.label === 'Pivot' ? 2 : 1
                 });
             });
             
             updateStatus(`–î–æ–±–∞–≤–ª–µ–Ω—ã –ø–∏–≤–æ—Ç —É—Ä–æ–≤–Ω–∏ (${levels.length})`, 'success');
         }

         function addEventMarker(time, type, text) {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return;
             }
             
             const series = comparisonLineSeries || coinbaseLineSeries;
             if (!series) return;
             
             return window.advancedFeatures.addMarker(series, time, {
                 position: type === 'bullish' ? 'belowBar' : 'aboveBar',
                 color: type === 'bullish' ? '#00C851' : '#FF4444',
                 shape: type === 'bullish' ? 'arrowUp' : 'arrowDown',
                 text: text,
                 id: `event_${Date.now()}`
             });
         }

         function getAdvancedFeaturesInfo() {
             if (!window.advancedFeatures || !window.advancedFeatures.isInitialized) {
                 return null;
             }
             
             return window.advancedFeatures.getFeatureInfo();
         }

         // ===============================================
         // –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° –ù–û–í–´–ú–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–Ø–ú–ò
         // ===============================================

         function handleExportAction(exportType) {
             if (!exportType || !window.eventsAndExport || !window.eventsAndExport.isInitialized) {
                 return;
             }
             
             try {
                 switch (exportType) {
                     case 'image':
                         window.eventsAndExport.exportChartAsImage();
                         updateStatus('–ì—Ä–∞—Ñ–∏–∫ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ', 'success');
                         break;
                         
                     case 'csv':
                         window.eventsAndExport.exportDataAsCSV();
                         updateStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV', 'success');
                         break;
                         
                     case 'json':
                         window.eventsAndExport.exportDataAsJSON();
                         updateStatus('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ JSON', 'success');
                         break;
                         
                     default:
                         console.warn('Unknown export type:', exportType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Export error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
             }
         }

         function handleSeriesAdd(seriesType) {
             if (!seriesType || !window.advancedSeriesAndScale || !window.advancedSeriesAndScale.isInitialized) {
                 return;
             }
             
             try {
                 const seriesId = `${seriesType}_${Date.now()}`;
                 
                 switch (seriesType) {
                                     // case 'volume':
                //     // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä—ë–º–æ–≤
                //     const volumeData = generateVolumeData();
                //     window.advancedSeriesAndScale.createVolumesSeries(seriesId, volumeData);
                //     updateStatus('–°–µ—Ä–∏—è –æ–±—ä—ë–º–æ–≤ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                //     break;
                         
                     case 'area':
                         // –°–æ–∑–¥–∞–µ–º –æ–±–ª–∞—Å—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö
                         const areaData = getCurrentChartData();
                         window.advancedSeriesAndScale.createTrendAreaSeries(seriesId, areaData);
                         updateStatus('–°–µ—Ä–∏—è –æ–±–ª–∞—Å—Ç–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                         break;
                         
                     case 'baseline':
                         // –°–æ–∑–¥–∞–µ–º –±–∞–∑–æ–≤—É—é –ª–∏–Ω–∏—é
                         const baselineData = getCurrentChartData();
                         const baselineValue = calculateBaselineValue(baselineData);
                         window.advancedSeriesAndScale.createDeviationBaselineSeries(seriesId, baselineData, baselineValue);
                         updateStatus('–ë–∞–∑–æ–≤–∞—è –ª–∏–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                         break;
                         
                     default:
                         console.warn('Unknown series type:', seriesType);
                 }
                 
             } catch (error) {
                 console.error('‚ùå Series add error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–∏–∏: ${error.message}`, 'error');
             }
         }

         function handlePriceScaleModeChange(mode) {
             if (!window.advancedSeriesAndScale || !window.advancedSeriesAndScale.isInitialized) {
                 return;
             }
             
             try {
                 window.advancedSeriesAndScale.setPriceScaleMode('right', mode);
                 updateStatus(`–†–µ–∂–∏–º —à–∫–∞–ª—ã —Ü–µ–Ω –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${mode}`, 'success');
                 
             } catch (error) {
                 console.error('‚ùå Price scale mode change error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ —à–∫–∞–ª—ã: ${error.message}`, 'error');
             }
         }

         function handleSaveState() {
             if (!window.eventsAndExport || !window.eventsAndExport.isInitialized) {
                 updateStatus('–ú–æ–¥—É–ª—å —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                 return;
             }
             
             try {
                 window.eventsAndExport.saveChartState();
                 updateStatus('–°–æ—Å—Ç–æ—è–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
                 
             } catch (error) {
                 console.error('‚ùå Save state error:', error);
                 updateStatus(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${error.message}`, 'error');
             }
         }

         // function generateVolumeData() {
         //     // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ–±—ä—ë–º–æ–≤
         //     const volumeData = [];
         //     const startTime = Math.floor(Date.now() / 1000) - (365 * 24 * 60 * 60);
         //     
         //     for (let i = 0; i < 100; i++) {
         //         const time = startTime + (i * 24 * 60 * 60);
         //         const baseVolume = 1000000 + Math.random() * 500000;
         //         volumeData.push({
         //             time: time,
         //             value: baseVolume,
         //             volume: baseVolume,
         //             color: Math.random() > 0.5 ? '#26a69a' : '#ef5350'
         //         });
         //     }
         //     
         //     return volumeData;
         // }

         function getCurrentChartData() {
             // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä–∞—Ñ–∏–∫–∞
             if (comparisonLineSeries && comparisonLineSeries.data) {
                 return comparisonLineSeries.data();
             }
             
             if (coinbaseLineSeries && coinbaseLineSeries.data) {
                 return coinbaseLineSeries.data();
             }
             
             return [];
         }

                   function calculateBaselineValue(data) {
              if (!data || data.length === 0) return 0;
              
              // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–∞–∫ –±–∞–∑–æ–≤—É—é –ª–∏–Ω–∏—é
              const sum = data.reduce((acc, item) => acc + item.value, 0);
              return sum / data.length;
          }

                     function handleToggleFullscreen() {
               if (!window.mobileResponsive || !window.mobileResponsive.isInitialized) {
                   updateStatus('–ú–æ–±–∏–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω', 'error');
                   return;
               }
               
               try {
                   if (!window.mobileResponsive.isFullscreenSupported()) {
                       updateStatus('–ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
                       return;
                   }

                   const success = window.mobileResponsive.toggleFullscreen();
                   if (success) {
                       const isFullscreen = window.mobileResponsive.isFullscreen;
                       updateStatus(
                           isFullscreen ? '–í–∫–ª—é—á—ë–Ω –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º' : '–í—ã–∫–ª—é—á–µ–Ω –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º', 
                           'success'
                       );
                       
                       // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
                       const button = document.getElementById('toggleFullscreen');
                       if (button) {
                           button.innerHTML = isFullscreen ? 'üóó –í—ã–π—Ç–∏' : '‚õ∂ –ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω';
                       }
                   } else {
                       updateStatus('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞', 'error');
                   }
                   
               } catch (error) {
                   console.error('‚ùå Fullscreen toggle error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞: ${error.message}`, 'error');
               }
           }

           function handleCandlestickAdd(type) {
               if (!type || !window.candlestickBarSeries) return;
               
               try {
                   const currentData = getCurrentChartData();
                   if (!currentData || currentData.length === 0) {
                       updateStatus('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤–µ—á–µ–π', 'error');
                       return;
                   }

                   // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º line-–¥–∞–Ω–Ω—ã–µ –≤ OHLC
                   const ohlcData = window.candlestickBarSeries.convertLineToOHLC(currentData);
                   const seriesId = `${type}_${Date.now()}`;
                   
                   switch (type) {
                       case 'classic':
                           window.candlestickBarSeries.createClassicCandlesticks(seriesId, ohlcData);
                           updateStatus('–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'hollow':
                           window.candlestickBarSeries.createHollowCandlesticks(seriesId, ohlcData);
                           updateStatus('–ü–æ–ª—ã–µ —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'heikin':
                           window.candlestickBarSeries.createHeikinAshiCandlesticks(seriesId, ohlcData);
                           updateStatus('Heikin-Ashi —Å–≤–µ—á–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã', 'success');
                           break;
                       case 'bar':
                           window.candlestickBarSeries.addBarSeries(seriesId);
                           window.candlestickBarSeries.setBarData(seriesId, ohlcData);
                           updateStatus('–ë–∞—Ä-–≥—Ä–∞—Ñ–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Candlestick add error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–≤–µ—á–µ–π: ${error.message}`, 'error');
               }
           }

           function handleTimeFeature(feature) {
               if (!feature || !window.advancedTimeFeatures) return;
               
               try {
                   switch (feature) {
                       case 'business_hours':
                           window.advancedTimeFeatures.setBusinessHours({
                               from: '09:30',
                               to: '16:00',
                               timezone: 'America/New_York'
                           });
                           updateStatus('–¢–æ—Ä–≥–æ–≤—ã–µ —á–∞—Å—ã NYSE —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
                           break;
                           
                       case 'timezone':
                           window.advancedTimeFeatures.setTimeZone('Europe/Moscow');
                           updateStatus('–ß–∞—Å–æ–≤–æ–π –ø–æ—è—Å –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ –º–æ—Å–∫–æ–≤—Å–∫–∏–π', 'success');
                           break;
                           
                       case 'goto_now':
                           window.advancedTimeFeatures.goToNow();
                           updateStatus('–ü–µ—Ä–µ—Ö–æ–¥ –∫ —Ç–µ–∫—É—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏', 'success');
                           break;
                           
                       case 'custom_marks':
                           const now = Math.floor(Date.now() / 1000);
                           window.advancedTimeFeatures.addEventMark(now, '–í–∞–∂–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ', '#FF6B6B');
                           updateStatus('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –º–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Time feature error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—Ä–µ–º–µ–Ω–∏: ${error.message}`, 'error');
               }
           }

           function handleCrosshairModeChange(mode) {
               if (!window.customCrosshair) return;
               
               try {
                   window.customCrosshair.setCrosshairMode(mode);
                   updateStatus(`–†–µ–∂–∏–º crosshair –∏–∑–º–µ–Ω—ë–Ω –Ω–∞: ${mode}`, 'success');
                   
               } catch (error) {
                   console.error('‚ùå Crosshair mode error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ crosshair: ${error.message}`, 'error');
               }
           }

           function handleAnimationEffect(effect) {
               if (!effect || !window.animationEffects) return;
               
               try {
                   switch (effect) {
                       case 'entrance_fade':
                           window.animationEffects.animateChartEntrance('fade');
                           updateStatus('–ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'highlight':
                           window.animationEffects.highlightChart();
                           updateStatus('–ü–æ–¥—Å–≤–µ—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'pulse':
                           window.animationEffects.pulseChart();
                           updateStatus('–ü—É–ª—å—Å–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞', 'success');
                           break;
                           
                       case 'loading':
                           window.animationEffects.showLoadingSpinner('–î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏—è...');
                           setTimeout(() => {
                               window.animationEffects.hideLoadingSpinner();
                           }, 3000);
                           updateStatus('–ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∫–∞–∑–∞–Ω–∞', 'success');
                           break;
                   }
                   
               } catch (error) {
                   console.error('‚ùå Animation effect error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞: ${error.message}`, 'error');
               }
           }

           function handleToggleAnimations() {
               if (!window.animationEffects) return;
               
               try {
                   const currentlyEnabled = window.animationEffects.transitions.enabled;
                   const newState = !currentlyEnabled;
                   
                   window.animationEffects.setAnimationsEnabled(newState);
                   updateStatus(`–ê–Ω–∏–º–∞—Ü–∏–∏ ${newState ? '–≤–∫–ª—é—á–µ–Ω—ã' : '–≤—ã–∫–ª—é—á–µ–Ω—ã'}`, 'success');
                   
                   const button = document.getElementById('toggleAnimations');
                   if (button) {
                       button.innerHTML = newState ? 'üé¨ –ê–Ω–∏–º–∞—Ü–∏–∏' : '‚è∏Ô∏è –ê–Ω–∏–º–∞—Ü–∏–∏';
                   }
                   
               } catch (error) {
                   console.error('‚ùå Toggle animations error:', error);
                   updateStatus(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π: ${error.message}`, 'error');
               }
           }
    </script>
</body>
</html> 